---
title             : "Reliability of Mobile Sensor Sleep Measurement in Young Adults"
shorttitle        : "Sleep Reliability"
bibliography      : "r-references.bib"
floatsintext      : yes
linenumbers       : no
draft             : no
mask              : no
figurelist        : no
tablelist         : no
footnotelist      : no
classoption: "doc"
output:
  papaja::apa6_pdf:
    latex_engine: lualatex
  html_notebook:
editor_options: 
  chunk_output_type: console
---

This script wrangles raw accel, actilife, and diary data to yield a usable .Rda for analysis and visualization. 
# Setup

```{r setup}
library("papaja")
library("kableExtra")
r_refs("r-references.bib")
```

```{r analysis-preferences}
# Seed for random number generation
set.seed(42)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed)
```

We used `r cite_r("r-references.bib")` for all our analyses.

## Libraries, color palatte, and functions

```{r, echo=FALSE}
library(tidyverse)
library(readr)
library(stringr)
library(lubridate)
library(data.table)
library(skimr)
library(patchwork)
library(MethodCompare)
library(DescTools)
library(janitor)
library(scipub)
library(lme4)
library(lmerTest)
library(knitr)


cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7") 
theme_set(theme_bw())
# Simple function for computing ICC from lme() output
ICClme <- function(out) {
  varests <- as.numeric(VarCorr(out)[1:2])
  return(paste("ICC =", varests[1] / sum(varests)))
}
theme_set(theme_bw(base_size = 12,base_family = "Arial")); theme_update(panel.grid.minor = element_line(linetype = "solid",linewidth =.5),axis.title.x = element_text(face = "bold"),axis.title.y = element_text(face = "bold"), plot.title = element_text(face="bold"))
```

## Reading in files

```{r, echo=FALSE}
df_sleep_ears_path <- "~/Dropbox/Postdoc/15_Sleep_metrics_reliability/data_from_Ryann/reliability_paper/ears/sleep_detection_final.csv"
df_sleep_actilife_path  <- "~/Dropbox/Postdoc/15_Sleep_metrics_reliability/data_from_Ryann/reliability_paper/actilife/Batch/BatchSleepExportDetails(2020-03-03_14-13-01).csv"
df_sleep_diary_path <- "~/Dropbox/Postdoc/15_Sleep_metrics_reliability/data_from_Ryann/reliability_paper/sleep_diary/sleep_diary.csv"
df_ears_acc_10sec_path <- "~/Dropbox/Postdoc/15_Sleep_metrics_reliability/data_from_Ryann/reliability_paper/ears/acc_second10_df.csv"
df_baseline_path  <- "~/Dropbox/Postdoc/15_Sleep_metrics_reliability/Melissa/Raw_Baseline_Data.csv"
```

# Wrangling

## Actilife

```{r, echo=FALSE,message=FALSE}
# Actilife not used in Melissa's dissertation
# renaming and converting variables
df_sleep_actilife <- 
  read_csv(df_sleep_actilife_path) %>% 
  janitor::clean_names() %>% 
  dplyr::mutate(
    actilife_id = str_remove(file_name, "60sec.agd"),
    bedtime_timestamp = mdy_hms(in_bed_time), # sleep_onset_timestamp -> bedtime_timestamp
    risetime_timestamp = mdy_hms(out_bed_time), # sleep_offset_timestamp -> risetime_timestamp
    time_in_bed_minutes = lubridate::interval(bedtime_timestamp, risetime_timestamp),
    time_in_bed_minutes = time_length(time_in_bed_minutes, "minutes"), # this is actually same as total_sleep_time in the dataframe
    bedtime_timestamp = as.character(bedtime_timestamp),
    risetime_timestamp = as.character(risetime_timestamp),
    risetime_date = as_date(risetime_timestamp)
  ) %>%
  dplyr::select(
    actilife_id,
    risetime_date,
    bedtime_timestamp,
    risetime_timestamp,
    time_in_bed_minutes
  )

rm(df_sleep_actilife_path)

# number of participants we start with
num_pts <- df_sleep_actilife %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::summarise(
    n = n()
  ) # 18 participants, 132 observations

# explore cases for duplicate values
sum_explore <-
  df_sleep_actilife %>%
  dplyr::group_by(actilife_id, risetime_date) %>%
  dplyr::summarise(
    n = n(), # num of entries
    # within each ID and date, finding the earliest (min) and latest (max) time to determine which entry to use
    bedtime_timestamp_min = min(bedtime_timestamp), 
    risetime_timestamp_min = min(risetime_timestamp),
    bedtime_timestamp_max = max(bedtime_timestamp),
    risetime_timestamp_max = max(risetime_timestamp)
    ) %>%
  filter(n > 1) %>% # identifying those with duplicate values
  dplyr::ungroup() %>%
  dplyr::mutate(gap_min = difftime(bedtime_timestamp_max, risetime_timestamp_min, units = "min")) # computing minutes btwn onset and offset to determine what is sleep and what might be a nap


# drop duplicates that appear to be midday naps (keeping sleep period of longest duration, which also coincides during the evening)

df_sleep_actilife2 <-
  df_sleep_actilife %>%
  dplyr::mutate(
    drop_flag = 0,
    drop_flag =
      ifelse( # A screening of the data identified two records as potential "naps", to be deleted and the rest of the cases that appeared to be sleep interruptions.  After hard coding 2 "nap" records to be removed, the remaining records get reduced to one as the code consolidates across the sleep interruptions by selecting the earliest (min) sleep onset and latest (max) sleep offset.)
        (actilife_id == "ae1365" & bedtime_timestamp == "2018-10-23 14:03:00") | # removing the ones that looks like a midday nap based on onset and duration
          (actilife_id == "jm8103" & bedtime_timestamp == "2018-10-24 19:02:00"),
        1, 0
        )
  ) %>%
  filter(drop_flag == 0) %>%
  dplyr::select(-drop_flag)


df_sleep_actilife3 <-
  df_sleep_actilife2 %>%
  dplyr::group_by(actilife_id, risetime_date) %>%
  dplyr::summarise(
    # within each ID and wake-up date, identifying sleep onset as the earliest time and sleep offest as the latest time to find the greatest difference in times
    bedtime_timestamp = min(bedtime_timestamp),
    risetime_timestamp = max(risetime_timestamp),
  ) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(
    # actilife sleep duration
    time_in_bed_minutes = as.numeric(difftime(risetime_timestamp, bedtime_timestamp, units = "min")),
    source = "actilife",
  ) %>%
  dplyr::select(-risetime_date)


# number of participants we end with
num_pts <- df_sleep_actilife3 %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::summarise(
    n = n()
  ) 
```

```{r}
skim(df_sleep_actilife3)
```


A subset of participants ( _n_ =18) consented to wear the watch After removing two observations identified as "naps" and consolidating across the sleep interruptions by selecting the earliest (min) sleep onset and latest (max) sleep offset, 114 observations from 18 participants were considered for analysis.

## Diary

```{r, echo=FALSE,message=FALSE}
df_sleep_diary <-
  read_csv(df_sleep_diary_path) %>%
  dplyr::mutate_if(is.POSIXct, as.character) %>%
  
  # data cleaning - adding or subtracting 12hours; the code was utilized to correct erroneous entries for AM/PM, with one record correcting for both calendar date and reassigning AM to PM, such as ae1365 with date_start of 2018-10-21)
  dplyr::mutate(
    # fixing dates and times for those that didn't convert sleep onset to 24-hour clock
    diary_sleep_onset = ifelse((participant_id == "ae1365" & diary_sleep_onset == "2018-10-22 11:30:00"), "2018-10-21 11:30:00", diary_sleep_onset),
    diary_bed_onset = ifelse((participant_id == "ae1365" & diary_bed_onset == "2018-10-22 11:30:00"), "2018-10-21 11:30:00", diary_bed_onset),
    
    diary_sleep_onset = ifelse((participant_id == "ls7319" & diary_sleep_onset == "2018-10-18 11:00:00"), "2018-10-17 23:00:00", diary_sleep_onset),
    diary_bed_onset = ifelse((participant_id == "ls7319" & diary_bed_onset == "2018-10-18 10:30:00"), "2018-10-17 22:30:00", diary_bed_onset),
    
    diary_sleep_onset = ifelse((participant_id == "bh2693" & diary_sleep_onset == "2018-10-15 10:10:00"), "2018-10-14 22:10:00", diary_sleep_onset),
    diary_bed_onset = ifelse((participant_id == "bh2693" & diary_bed_onset == "2018-10-15 09:30:00"), "2018-10-14 21:30:00", diary_bed_onset),
    
    diary_sleep_onset = ifelse((participant_id == "ae1365" & diary_sleep_onset == "2018-10-21 11:30:00"), "2018-10-21 23:30:00", diary_sleep_onset),
    diary_bed_onset = ifelse((participant_id == "ae1365" & diary_bed_onset == "2018-10-21 11:30:00"), "2018-10-21 23:30:00", diary_bed_onset),
    
    # fixing dates and times for those that didn't convert sleep offset to 24-hour clock
    diary_sleep_offset = ifelse((participant_id == "ks8282" & diary_sleep_offset == "2018-10-05 19:30:00"), "2018-10-05 07:30:00", diary_sleep_offset),
    diary_bed_offset = ifelse((participant_id == "ks8282" & diary_bed_offset == "2018-10-05 19:35:00"), "2018-10-05 07:35:00", diary_bed_offset),    
    
    diary_sleep_offset = ifelse((participant_id == "jm8103" & diary_sleep_offset == "2018-10-26 20:30:00"), "2018-10-26 08:30:00", diary_sleep_offset),
    diary_bed_offset = ifelse((participant_id == "jm8103" & diary_bed_offset == "2018-10-26 20:30:00"), "2018-10-26 08:30:00", diary_bed_offset),
    
    diary_sleep_offset = ifelse((participant_id == "at0565" & diary_sleep_offset == "2018-10-19 20:45:00"), "2018-10-19 08:45:00", diary_sleep_offset),
    # diary_bed_offset for at0565 seems right (2018-10-19 09:15:00)
    
    diary_sleep_offset = ifelse((participant_id == "at0565" & diary_sleep_offset == "2018-10-21 20:30:00"), "2018-10-21 08:30:00", diary_sleep_offset),
    diary_bed_offset = ifelse((participant_id == "at0565" & diary_bed_offset == "2018-10-21 20:30:00"), "2018-10-21 08:30:00", diary_bed_offset),
    
    diary_sleep_offset = ifelse((participant_id == "gh0416" & diary_sleep_offset == "2018-10-30 00:20:00"), "2018-10-30 12:20:00", diary_sleep_offset),
    diary_bed_offset = ifelse((participant_id == "gh0416" & diary_bed_offset == "2018-10-30 00:30:00"), "2018-10-30 12:30:00", diary_bed_offset),    
    
    diary_bed_onset = ifelse((participant_id == "bh2693" & diary_bed_onset == "2018-10-14 11:00:00"), "2018-10-13 23:00:00", diary_bed_onset),   
    
    diary_bed_onset = ifelse((participant_id == "951713430" & diary_bed_onset == "2018-10-16 12:30:00"), "2018-10-17 00:30:00", diary_bed_onset),     
    
    diary_bed_onset = ifelse((participant_id == "em6678" & diary_bed_onset == "2018-10-11 12:00:00"), "2018-10-12 00:00:00", diary_bed_onset),     
    
    diary_bed_onset = ifelse((participant_id == "tt8746" & diary_bed_onset == "2018-10-13 12:00:00"), "2018-10-14 00:00:00", diary_bed_onset),         
  ) %>%

  dplyr::mutate(
    actilife_id = participant_id, # to merge with actilife dataset
    sleep_onset_timestamp = lubridate::as_datetime(diary_sleep_onset),
    sleep_offset_timestamp = lubridate::as_datetime(diary_sleep_offset),
    # computing sleep duration minutes
    sleep_duration_minutes = as.numeric(difftime(sleep_offset_timestamp, sleep_onset_timestamp, units = "mins")), 
    bedtime_timestamp = lubridate::as_datetime(diary_bed_onset),
    risetime_timestamp = lubridate::as_datetime(diary_bed_offset),
    # computing time in bed duration minutes
    time_in_bed_minutes = as.numeric(difftime(risetime_timestamp, bedtime_timestamp, units = "mins")), 
    source = "diary",
    sleep_onset_timestamp = as.character(sleep_onset_timestamp),
    sleep_offset_timestamp = as.character(sleep_offset_timestamp),
    bedtime_timestamp = as.character(bedtime_timestamp),
    risetime_timestamp = as.character(risetime_timestamp),    
    risetime_date = as_date(diary_sleep_offset)
  ) %>%

  dplyr::select(
    X = ...1 ,
    # device_id,
    actilife_id,
    # date_start,
    sleep_onset_timestamp,
    sleep_offset_timestamp,
    sleep_duration_minutes,
    bedtime_timestamp,
    risetime_timestamp,
    time_in_bed_minutes,
    source,
    risetime_date
    )

num_pts <- df_sleep_diary %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::summarise(
    n = n()
  ) # 35 participants (n=261 observations)

# explore cases for duplicate values
sum_explore_diary <-
  df_sleep_diary %>%
  dplyr::group_by(actilife_id, risetime_date) %>%
  dplyr::summarise(
    n = n(),
    sleep_onset_timestamp_min = min(sleep_onset_timestamp),
    sleep_offset_timestamp_min = min(sleep_offset_timestamp),
    sleep_onset_timestamp_max = max(sleep_onset_timestamp),
    sleep_offset_timestamp_max = max(sleep_offset_timestamp),
    sleep_min_dur = min(sleep_duration_minutes),
    sleep_max_dur = max(sleep_duration_minutes),
    min_x = min(X), # first recorded entry
    max_x = max(X) # second recorded entry
  ) %>%
  filter(n > 1) %>%
  dplyr::ungroup()

# select 2nd recorded entry (as it may be a correction)
df_sleep_diary2 <-
  df_sleep_diary %>%
  arrange(desc(X), actilife_id, risetime_date) %>% # reordering so that the 2nd recorded entry comes before the 1st entry
  dplyr::group_by(actilife_id, risetime_date) %>%
  slice(1) %>% # removes duplicate rows, keeping the 1st entry. A review of the code confirmed the process was selecting a second record, whether the duplicate was a correction or a double entry, when more than one record was available.
  dplyr::ungroup() %>%
  dplyr::select(-X, -risetime_date)

num_pts <- df_sleep_diary2 %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::summarise(
    n = n()
  ) # 35 participants (n=244 observations)

# drop records with durations less than 1 hour (removes 3 cases = -3.17, 0, 0.5) ### 3/23/24 toggled this line to align with original script
# df_sleep_diary3 <-
#   df_sleep_diary2 %>%  
#   filter(sleep_duration_minutes >= 60)

skim(df_sleep_diary2)
```

35 participants provided data ( _n_ =261 observations). After removing 17 observations identified as duplicated entries, `nrow(df_sleep_diary2)` 242 observations from 35 participants were considered for analysis.

## EARS

```{r, echo=FALSE,message=FALSE}
df_sleep_ears <-
  read.csv(df_sleep_ears_path,
           stringsAsFactors = FALSE)  %>%
  dplyr::mutate(
    actilife_id = participant_id,
    timestamp_start = paste(date_start, "00:00:00"),
    timestamp_start_final = as.POSIXct(timestamp_start), # converting to dttm object
    #date_start = as_date(date_start),
    bedtime_timestamp = as.character(timestamp_start_final + seconds(sleep_onset_numeric)),
    risetime_timestamp = as.character(timestamp_start_final + seconds(sleep_offset_numeric)),
    time_in_bed_minutes = sleep_duration_hours * 60,
    #day_id = day,
    source = "ears"
  ) %>%
  dplyr::select(
    # device_id,
    actilife_id,
    # date_start,
    # day_id,
    bedtime_timestamp,
    risetime_timestamp,
    time_in_bed_minutes,
    source
    )

rm(df_sleep_ears_path)

num_pts <- df_sleep_ears %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::summarise(
    n = n()
  ) # 31 participants (n=193 observations)

skim(df_sleep_ears)
```


31 participants provided data ( _n_ =193 observations) were considered for analysis.

## Combining dfs

```{r, echo=FALSE}
# joining actigraphy, diary, and ears
df_sleep <-
  bind_rows(df_sleep_actilife3, df_sleep_diary2, df_sleep_ears)

df_sleep2 <-
  df_sleep %>%
  dplyr::mutate(risetime_date = date(risetime_timestamp))

rm(df_sleep_actilife, df_sleep_diary, df_sleep_ears)
```

# Wrangling merged df

```{r, echo=FALSE,message=FALSE}
# df_sleep_offset_date_min ----
# `sp_id` (i.e., day number) is based on first sleep offset date (since onset might vary by calendar day if spans across midnight)
# fyi, not all partcipant have all types of sleep data (ears, actilife, diary), so using the min (first sleep offset date) across all three sources
# sleep_offset_date_min will be used to create a sleep period id (i.e., day number) to standardize the sleep periods across all three sources

df_risetime_date_min <-
  df_sleep2 %>%
  dplyr::mutate(risetime_date = date(risetime_timestamp)) %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::summarise(risetime_date_min = min(risetime_date)) %>%
  dplyr::ungroup() %>%
  dplyr::select(actilife_id, risetime_date_min)


# merge min sleep offset date to dataset
df_sleep3 <- 
  df_sleep2 %>% 
  left_join(df_risetime_date_min, by = c("actilife_id"))

#rm(df_sleep_offset_date_min)


# create a sleep period id (i.e., day number), unique identifier for each sleep period per participant

df_sleep4 <-
  df_sleep3 %>%
  dplyr::mutate(day_num = as.numeric(risetime_date - risetime_date_min, units = "days")) %>%
  dplyr::select(-risetime_date_min)


# df_participant_list: to get ID and device ID
# based off of records in sleep diary
df_participant_list <-
  read_csv(df_sleep_diary_path) %>%
  dplyr::mutate_if(is.POSIXct, as.character) %>%
  dplyr::mutate(
    date_start = as.character(date_start),
    diary_sleep_onset_time = as.character(diary_sleep_onset_time),
    X = as.integer(...1)
    ) %>%
  dplyr::select(-...1) %>%
  dplyr::select(X, everything()) %>%
  dplyr::mutate(actilife_id = participant_id) %>%
  dplyr::select(actilife_id, device_id) %>%
  unique() %>%
  filter(!is.na(device_id)) # There are 34 participants who completed the diary
```

## Joining participant list with sleep df

```{r, echo=FALSE, message=FALSE}
# joining sleep data with participant list
df_analysis <-
  full_join(
    df_participant_list, df_sleep4, by = c("actilife_id"), multiple = "all"
    ) %>%
  filter(!is.na(device_id))

rm(df_participant_list, df_sleep4, df_sleep3, df_sleep2, df_sleep)

# keeping those who have all actilife, ears, diary
df_analysis_sum_32 <-
  df_analysis %>%
  dplyr::mutate(
    source = factor(source),
    actilife_id = factor(actilife_id)
  ) %>%
  dplyr::group_by(actilife_id, source) %>%
  dplyr::summarise(
    n_days = n() 
  ) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::mutate(
    n_sources = n()
  ) %>%
  filter(n_sources > 1) # can see that for some participants, all sources don't align with the same number of days

df_analysis_sum_32 %>%
  dplyr::summarise(
    n = n()
  )

df_analysis_sum_32_sources_per_day <-
  df_analysis %>%
  dplyr::group_by(actilife_id, day_num) %>%
  dplyr::summarise(
    n_sources_per_person_per_day = n()
  ) %>% # 188 observations of at least 2 sources recorded on the same day
  filter(n_sources_per_person_per_day > 1)


```

34 participants have at least 1 source of data; 32 participants have at least 2 sources of data.

However, not all participants with multiple sources had all sources of measurement on the same days. Across 32 participants, 188 observations of at least 2 sources recorded on the same day.

## Classifying sources of data

```{r,results='asis', echo=FALSE,message=FALSE}
df_analysis2 <-
  left_join(df_analysis, df_analysis_sum_32_sources_per_day, by = c("actilife_id", "day_num")) %>%
  drop_na(n_sources_per_person_per_day) %>%
  dplyr::group_by(actilife_id, day_num) %>%
  dplyr::mutate(
    source_combos1 =
      case_when(
       "3" %in%  n_sources_per_person_per_day & "diary" %in% source & "ears" %in% source & "actilife" %in% source ~ "diary_ears_actilife"
      ),
    source_combos2 =
      case_when(
       "2" %in%  n_sources_per_person_per_day & "diary" %in% source & "ears" %in% source ~ "diary_ears"
      ),
    source_combos3 =
      case_when(
       "2" %in%  n_sources_per_person_per_day & "diary" %in% source & "actilife" %in% source ~ "diary_actilife"
      ),
    source_combos4 =
      case_when(
        "2" %in% n_sources_per_person_per_day & "ears" %in% source & "actilife" %in% source ~
          "ears_actilife"
        )
  ) %>%
  dplyr::mutate(
    source_combination = source_combos1,
    source_combination =
      case_when(
        is.na(source_combos1) & is.na(source_combos3) & is.na(source_combos4) ~ source_combos2, TRUE ~ source_combos1
      ),
    source_combination =
      case_when(
        is.na(source_combos1) & is.na(source_combos2) & is.na(source_combos4) ~ source_combos3, TRUE ~ source_combination
      ),
    source_combination =
      case_when(
        is.na(source_combos1) & is.na(source_combos2) & is.na(source_combos3) ~ source_combos4, TRUE ~ source_combination
        )
  ) %>%
  dplyr::select(-c("source_combos1", "source_combos2", "source_combos3", "source_combos4")) %>%
  dplyr::ungroup() 

# num participants
df_analysis2_sum_num_pts <-
  df_analysis2 %>%
  drop_na() %>%
  dplyr::ungroup() %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::summarise(
    n = n() # 32 participants
  ) 

# num days per participant per source_combination
df_analysis2_sum_num_days <-
  df_analysis2 %>%
  dplyr::ungroup() %>%
  dplyr::select(actilife_id, day_num, source_combination) %>%
  distinct() %>%
  dplyr::group_by(actilife_id, source_combination) %>%
  dplyr::summarise(
    n = n() 
  )

diary_and_ears_num_pts <-
  df_analysis2 %>%
  dplyr::ungroup() %>%
  dplyr::select(actilife_id,source_combination) %>%
  distinct() %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::mutate(
    diary_ears_concurr =
      case_when(
      "diary_ears" %in%  source_combination |  "diary_ears_actilife" %in%  source_combination ~ "diary & ears", TRUE ~ NA
      )
  ) %>%
  dplyr::select(-c(source_combination)) %>%
  drop_na() %>%
  distinct() # 29 pts with diary and ears data, some of whom have actilife data concurrently


diary_and_ears_and_act_num_pts <-
  df_analysis2 %>%
  dplyr::ungroup() %>%
  dplyr::select(actilife_id,source_combination) %>%
  distinct() %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::mutate(
    diary_ears_actilife_concurr =
      case_when(
      "diary_ears_actilife" %in%  source_combination ~ "diary & ears & actigraph", TRUE ~ NA
      )
  ) %>%
  dplyr::select(-c(source_combination)) %>%
  drop_na() %>%
  distinct() # 13 pts with diary, ears, and actilife data concurrently

diary_and_act_num_pts <-
  df_analysis2 %>%
  dplyr::ungroup() %>%
  dplyr::select(actilife_id,source_combination) %>%
  distinct() %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::mutate(
    diary_actilife_concurr =
      case_when(
      "diary_actilife" %in%  source_combination ~ "diary & actigraph", TRUE ~ NA
      )
  ) %>%
  dplyr::select(-c(source_combination)) %>%
  drop_na() %>%
  distinct() # 13 pts with diary and actilife data concurrently

ears_act_num_pts <-
  df_analysis2 %>%
  dplyr::ungroup() %>%
  dplyr::select(actilife_id,source_combination) %>%
  distinct() %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::mutate(
    diary_actilife_concurr =
      case_when(
      "ears_actilife" %in%  source_combination ~ "ears & actigraph", TRUE ~ NA
      )
  ) %>%
  dplyr::select(-c(source_combination)) %>%
  drop_na() %>%
  distinct() # 2 pts with ears and actilife data concurrently


# converting variable types and converting bedtimes and risetimes into minutes from midnight
df_analysis3 <-
  df_analysis2 %>%
  dplyr::mutate(
    risetime_date = date(risetime_timestamp),
    sleep_onset_timestamp = lubridate::as_datetime(sleep_onset_timestamp),
    sleep_offset_timestamp = lubridate::as_datetime(sleep_offset_timestamp),
    sleep_period_start_timestamp = lubridate::as_datetime(paste(risetime_date, "00:00:00")),
    sleep_period_start_onset_minutes = as.numeric(difftime(sleep_onset_timestamp, sleep_period_start_timestamp, units = "mins")),
    sleep_period_start_offset_minutes = as.numeric(difftime(sleep_offset_timestamp, sleep_period_start_timestamp, units = "mins")),
    bedtime_timestamp = lubridate::as_datetime(bedtime_timestamp),
    risetime_timestamp = lubridate::as_datetime(risetime_timestamp),
    bedtime_start_timestamp = lubridate::as_datetime(paste(risetime_date, "00:00:00")),
    bedtime_start_onset_minutes = as.numeric(difftime(bedtime_timestamp, bedtime_start_timestamp, units = "mins")),
    risetime_start_offset_minutes = as.numeric(difftime(risetime_timestamp, bedtime_start_timestamp, units = "mins"))    
  )

# df_analysis_wide ----

df_analysis_wide <-
  df_analysis3 %>%
  dplyr::select(-source_combination) %>%
  pivot_wider(
    names_from = source,
    values_from = c(
      "sleep_onset_timestamp",
      "sleep_offset_timestamp",
      "sleep_duration_minutes",
      "sleep_period_start_onset_minutes",
      "sleep_period_start_offset_minutes",
      "bedtime_timestamp",
      "risetime_timestamp",
      "time_in_bed_minutes",
      "bedtime_start_onset_minutes",
      "risetime_start_offset_minutes"      
    ),
    names_sep = "_"
  )
```



## Demo + PSQI

```{r, echo=FALSE,message=FALSE,warning=FALSE}
df_demo <-
  read_csv(df_baseline_path) %>%
  dplyr::select(
    -c(Status:UserLanguage)
  ) %>%
  slice(-2) %>%
  row_to_names(row_number = 1) %>%
  clean_names() %>%
  rename(
    actilife_id = what_is_your_id_for_this_research_study_first_initial_last_initial_last_4_of_phone_number,
    age = how_old_are_you,
    sex = what_is_your_biological_sex,
    gender = what_is_your_gender_identity,
    race = with_what_race_do_you_identify,
    ethnicity = with_what_ethnicity_do_you_identify,
    gone_to_bed_hr_pastmonth = during_the_past_month_when_have_you_usually_gone_to_bed_hour,
    gone_to_bed_min_pastmonth = during_the_past_month_when_have_you_usually_gone_to_bed_minute,
    gone_to_bed_am_pm_pastmonth = during_the_past_month_when_have_you_usually_gone_to_bed_am_pm,
    psqi_2_min_to_fall_asleep_pastmonth = during_the_past_month_how_long_in_minutes_has_it_taken_you_to_fall_asleep_each_night,
    wakeup_time_hr_pastmonth = during_the_past_month_when_have_you_usually_gotten_up_in_the_morning_hour,
    wakeup_time_min_pastmonth = during_the_past_month_when_have_you_usually_gotten_up_in_the_morning_minute,
    wakeup_am_pm_pastmonth = during_the_past_month_when_have_you_usually_gotten_up_in_the_morning_am_pm,
    psqi_4_sleep_duration_hours_pastmonth = during_the_past_month_how_many_hours_of_actual_sleep_do_you_get_at_night_this_may_be_different_than_the_number_of_hours_you_spend_in_bed,
    psqi_5a_trouble_falling_asleep_within_30min_pastmonth = during_the_past_month_how_often_have_you_had_trouble_sleeping_because_you_cannot_get_to_sleep_within_30_minutes,
    psqi_5b_trouble_staying_asleep_or_early_wakeup_pastmonth = during_the_past_month_how_often_have_you_had_trouble_sleeping_because_you_wake_up_in_the_middle_of_the_night_or_early_morning,
    psqi_5c_trouble_staying_asleep_bathroom_pastmonth = during_the_past_month_how_often_have_you_had_trouble_sleeping_because_you_have_to_get_up_to_use_the_bathroom,
    psqi_5d_trouble_staying_asleep_breathing_pastmonth = during_the_past_month_how_often_have_you_had_trouble_sleeping_because_you_cannot_breathe_comfortably,
    psqi_5e_trouble_staying_asleep_snoring_pastmonth = during_the_past_month_how_often_have_you_had_trouble_sleeping_because_you_cough_or_snore_loudly,
    psqi_5f_trouble_staying_asleep_too_cold_pastmonth = during_the_past_month_how_often_have_you_had_trouble_sleeping_because_you_feel_too_cold,
    psqi_5g_trouble_staying_asleep_too_hot_pastmonth = during_the_past_month_how_often_have_you_had_trouble_sleeping_because_you_feel_too_hot,
    psqi_5h_trouble_staying_asleep_nightmares_pastmonth =
      during_the_past_month_how_often_have_you_had_trouble_sleeping_because_you_have_bad_dreams,
    psqi_5i_trouble_staying_asleep_pain_pastmonth = during_the_past_month_how_often_have_you_had_trouble_sleeping_because_you_have_pain,
    psqi_5j_trouble_sleeping_other_reasons_pastmonth = during_the_past_month_how_often_have_you_had_trouble_sleeping_because_you_other_reason_s_please_describe,
    trouble_sleeping_other_reasons2_pastmonth = during_the_past_month_how_often_have_you_had_trouble_sleeping_because_you_other_reason_s_please_describe_2,
    psqi_6_sleep_medicine_pastmonth = during_the_past_month_how_often_have_you_taken_medicine_prescribed_or_over_the_counter_to_help_you_sleep,
    psqi_7_trouble_staying_awake_during_activities_pastmonth = during_the_past_month_how_often_have_you_had_trouble_staying_awake_while_driving_eating_meals_or_engaging_in_social_activity,
    psqi_8_trouble_maintaining_enthusiasm_to_get_things_done_pastmonth = during_the_past_month_how_much_of_a_problem_has_it_been_for_you_to_keep_up_enthusiasm_to_get_things_done,
    psqi_9_sleep_quality_overall_pastmonth =
      during_the_past_month_how_would_you_rate_your_sleep_quality_overall
  ) %>%
  dplyr::select(
    actilife_id, age, sex, gender, race, ethnicity, ends_with("_pastmonth")
  ) %>%
  dplyr::mutate(
    actilife_id = tolower(actilife_id),
    gone_to_bed_min_pastmonth =
      case_when(
        gone_to_bed_min_pastmonth == "0" ~ "00",
        is.na(gone_to_bed_min_pastmonth) ~ "00",
        TRUE ~ gone_to_bed_min_pastmonth
        ),
    gone_to_bed_am_pm_pastmonth =
      ifelse(
        gone_to_bed_am_pm_pastmonth == "Am" | gone_to_bed_am_pm_pastmonth == "AM", "AM",
      gone_to_bed_am_pm_pastmonth),
    gone_to_bed_am_pm_pastmonth =
      ifelse(
        gone_to_bed_am_pm_pastmonth == "Pm" | gone_to_bed_am_pm_pastmonth == "PM", "PM",
      gone_to_bed_am_pm_pastmonth),
    gone_to_bed_timestamp =
      paste(gone_to_bed_hr_pastmonth, gone_to_bed_min_pastmonth, sep = ":"),
    psqi_1_gone_to_bed_timestamp =
      paste(gone_to_bed_timestamp, gone_to_bed_am_pm_pastmonth),
    wakeup_time_min_pastmonth =
      case_when(
        wakeup_time_min_pastmonth == "0" ~ "00",
        is.na(wakeup_time_min_pastmonth) ~ "00",
        TRUE ~ wakeup_time_min_pastmonth
        ),
    wakeup_am_pm_pastmonth =
      ifelse(
        wakeup_am_pm_pastmonth == "Am" | wakeup_am_pm_pastmonth == "AM", "AM",
      wakeup_am_pm_pastmonth),
    wakeup_am_pm_pastmonth =
      ifelse(
        wakeup_am_pm_pastmonth == "Pm" | wakeup_am_pm_pastmonth == "PM", "PM",
      wakeup_am_pm_pastmonth),
    wakeup_timestamp =
      paste(wakeup_time_hr_pastmonth, wakeup_time_min_pastmonth, sep = ":"),
    psqi_3_wakeup_timestamp =
      paste(wakeup_timestamp, wakeup_am_pm_pastmonth)
    ) %>%
  dplyr::select(
    -c(gone_to_bed_hr_pastmonth, gone_to_bed_min_pastmonth, gone_to_bed_am_pm_pastmonth,
       wakeup_time_hr_pastmonth, wakeup_time_min_pastmonth, wakeup_am_pm_pastmonth)
  ) %>%
  dplyr::mutate(
    # Component 1
    psqi_comp_1_subj_sleep_quality_pastmonth =
      psqi_9_sleep_quality_overall_pastmonth,
    psqi_comp_1_subj_sleep_quality_pastmonth =
      case_when(
        psqi_9_sleep_quality_overall_pastmonth == "Very good" ~ "0",
        psqi_9_sleep_quality_overall_pastmonth == "Fairly good" ~ "1",
        psqi_9_sleep_quality_overall_pastmonth == "Fairly bad" ~ "2",
        psqi_9_sleep_quality_overall_pastmonth == "Very bad" ~ "3",
        TRUE ~ psqi_9_sleep_quality_overall_pastmonth
      ),
    # Component 2 - calc
    psqi_2_min_to_fall_asleep_pastmonth = as.numeric(psqi_2_min_to_fall_asleep_pastmonth),
    psqi_comp_2_q2_min_to_fall_asleep_pastmonth =
      case_when(
        psqi_2_min_to_fall_asleep_pastmonth <= 15 ~ 0,
        psqi_2_min_to_fall_asleep_pastmonth >= 16 & psqi_2_min_to_fall_asleep_pastmonth <= 30 ~ 1,
        psqi_2_min_to_fall_asleep_pastmonth >= 31 & psqi_2_min_to_fall_asleep_pastmonth <= 60 ~ 2,
        psqi_2_min_to_fall_asleep_pastmonth > 60 ~ 3,
        TRUE ~ psqi_2_min_to_fall_asleep_pastmonth
        ),
    psqi_comp_2_q5a_trouble_falling_asleep_within_30min_pastmonth =
      case_when(
        psqi_5a_trouble_falling_asleep_within_30min_pastmonth == "Not during the past month" ~ "0",
        psqi_5a_trouble_falling_asleep_within_30min_pastmonth == "Less than once a week" ~ "1",
        psqi_5a_trouble_falling_asleep_within_30min_pastmonth == "Once or twice a week" ~ "2",
        psqi_5a_trouble_falling_asleep_within_30min_pastmonth == "Three or more times a week" ~ "3",
        TRUE ~ psqi_5a_trouble_falling_asleep_within_30min_pastmonth
      ),
    psqi_comp_2_q5a_trouble_falling_asleep_within_30min_pastmonth = as.numeric(psqi_comp_2_q5a_trouble_falling_asleep_within_30min_pastmonth),
    # Component 2 - final
    psqi_comp2_sleep_latency_pastmonth =
      rowSums(
        across(psqi_comp_2_q2_min_to_fall_asleep_pastmonth:psqi_comp_2_q5a_trouble_falling_asleep_within_30min_pastmonth)
        ),
    # Component 3
    psqi_comp_3_sleep_duration_pastmonth =
      as.numeric(psqi_4_sleep_duration_hours_pastmonth),
    psqi_comp_3_sleep_duration_pastmonth =
      case_when(
        psqi_comp_3_sleep_duration_pastmonth > 7 ~ 0,
        psqi_comp_3_sleep_duration_pastmonth >=6 & psqi_comp_3_sleep_duration_pastmonth <= 7 ~ 1,
        psqi_comp_3_sleep_duration_pastmonth >=5 & psqi_comp_3_sleep_duration_pastmonth <= 6 ~ 2,
        psqi_comp_3_sleep_duration_pastmonth < 5 ~ 3,
        TRUE ~ psqi_comp_3_sleep_duration_pastmonth
      )
  )

df_demo <-
  df_demo %>%
  dplyr::mutate(
    # Component 4 - calc
    psqi_comp_4_num_hours_slept = as.numeric(psqi_4_sleep_duration_hours_pastmonth), # psqi q4 (sleep duration)
    date_onset = "04-19-2024",
    date_offset = "04-20-2024",
    date_onset =
      ifelse(
        str_detect(psqi_1_gone_to_bed_timestamp, "am") | str_detect(psqi_1_gone_to_bed_timestamp, "AM"),
        date_offset,
        date_onset
      ),
    psqi_1_gone_to_bed_timestamp_hms = format(as.POSIXct(psqi_1_gone_to_bed_timestamp,format='%I:%M %p'),format="%H:%M:%S"),
    psqi_3_wakeup_timestamp_hms = format(as.POSIXct(psqi_3_wakeup_timestamp,format='%I:%M %p'),format="%H:%M:%S"),
    psqi_1_gone_to_bed_timestamp_hms = paste(date_onset, psqi_1_gone_to_bed_timestamp_hms, sep = " "),
    psqi_3_wakeup_timestamp_hms = paste(date_offset, psqi_3_wakeup_timestamp_hms, sep = " ")
    ) %>%
   dplyr::select(
     actilife_id, psqi_1_gone_to_bed_timestamp, psqi_1_gone_to_bed_timestamp_hms, wakeup_timestamp, psqi_3_wakeup_timestamp, psqi_3_wakeup_timestamp_hms, everything()
   )

df_demo <-
  df_demo %>%
  dplyr::mutate(
    psqi_1_gone_to_bed_timestamp_hms = mdy_hms(psqi_1_gone_to_bed_timestamp_hms),
    psqi_3_wakeup_timestamp_hms = mdy_hms(psqi_3_wakeup_timestamp_hms),
    psqi_comp_4_num_hours_in_bed = psqi_1_gone_to_bed_timestamp_hms %--% psqi_3_wakeup_timestamp_hms,
    psqi_comp_4_num_hours_in_bed = as.duration(psqi_comp_4_num_hours_in_bed) / dhours(1),
    psqi_comp_4_sleep_efficiency = (psqi_comp_4_num_hours_slept/psqi_comp_4_num_hours_in_bed)*100,
    # Component 4 - final
    psqi_comp_4_sleep_efficiency_pastmonth =
      case_when(
        psqi_comp_4_sleep_efficiency > 85 ~ 0,
        psqi_comp_4_sleep_efficiency >= 75 & psqi_comp_4_sleep_efficiency <= 84 ~ 1,
        psqi_comp_4_sleep_efficiency >= 65 & psqi_comp_4_sleep_efficiency <= 74 ~ 2,
        psqi_comp_4_sleep_efficiency < 65 ~ 3,
        TRUE ~ psqi_comp_4_sleep_efficiency
      ),
    # Component 5
    psqi_comp_5_5b_trouble_staying_asleep_or_early_wakeup_pastmonth =
      case_when(
        psqi_5b_trouble_staying_asleep_or_early_wakeup_pastmonth == "Not during the past month" ~ "0",
        psqi_5b_trouble_staying_asleep_or_early_wakeup_pastmonth == "Less than once a week" ~ "1",
        psqi_5b_trouble_staying_asleep_or_early_wakeup_pastmonth == "Once or twice a week" ~ "2",
        psqi_5b_trouble_staying_asleep_or_early_wakeup_pastmonth == "Three or more times a week" ~ "3",
        TRUE ~ psqi_5b_trouble_staying_asleep_or_early_wakeup_pastmonth
      ),    
    psqi_comp_5_5c_trouble_staying_asleep_bathroom_pastmonth =
      case_when(
        psqi_5c_trouble_staying_asleep_bathroom_pastmonth == "Not during the past month" ~ "0",
        psqi_5c_trouble_staying_asleep_bathroom_pastmonth == "Less than once a week" ~ "1",
        psqi_5c_trouble_staying_asleep_bathroom_pastmonth == "Once or twice a week" ~ "2",
        psqi_5c_trouble_staying_asleep_bathroom_pastmonth == "Three or more times a week" ~ "3",
        TRUE ~ psqi_5c_trouble_staying_asleep_bathroom_pastmonth
      ),    
    psqi_comp_5_5d_trouble_staying_asleep_breathing_pastmonth =
      case_when(
        psqi_5d_trouble_staying_asleep_breathing_pastmonth == "Not during the past month" ~ "0",
        psqi_5d_trouble_staying_asleep_breathing_pastmonth == "Less than once a week" ~ "1",
        psqi_5d_trouble_staying_asleep_breathing_pastmonth == "Once or twice a week" ~ "2",
        psqi_5d_trouble_staying_asleep_breathing_pastmonth == "Three or more times a week" ~ "3",
        TRUE ~ psqi_5d_trouble_staying_asleep_breathing_pastmonth
      ),     
    psqi_comp_5_5e_trouble_staying_asleep_snoring_pastmonth =
      case_when(
        psqi_5e_trouble_staying_asleep_snoring_pastmonth == "Not during the past month" ~ "0",
        psqi_5e_trouble_staying_asleep_snoring_pastmonth == "Less than once a week" ~ "1",
        psqi_5e_trouble_staying_asleep_snoring_pastmonth == "Once or twice a week" ~ "2",
        psqi_5e_trouble_staying_asleep_snoring_pastmonth == "Three or more times a week" ~ "3",
        TRUE ~ psqi_5e_trouble_staying_asleep_snoring_pastmonth
      ),       
    psqi_comp_5_5f_trouble_staying_asleep_too_cold_pastmonth =
      case_when(
        psqi_5f_trouble_staying_asleep_too_cold_pastmonth == "Not during the past month" ~ "0",
        psqi_5f_trouble_staying_asleep_too_cold_pastmonth == "Less than once a week" ~ "1",
        psqi_5f_trouble_staying_asleep_too_cold_pastmonth == "Once or twice a week" ~ "2",
        psqi_5f_trouble_staying_asleep_too_cold_pastmonth == "Three or more times a week" ~ "3",
        TRUE ~ psqi_5f_trouble_staying_asleep_too_cold_pastmonth
      ),      
    psqi_comp_5_5g_trouble_staying_asleep_too_hot_pastmonth =
      case_when(
        psqi_5g_trouble_staying_asleep_too_hot_pastmonth == "Not during the past month" ~ "0",
        psqi_5g_trouble_staying_asleep_too_hot_pastmonth == "Less than once a week" ~ "1",
        psqi_5g_trouble_staying_asleep_too_hot_pastmonth == "Once or twice a week" ~ "2",
        psqi_5g_trouble_staying_asleep_too_hot_pastmonth == "Three or more times a week" ~ "3",
        TRUE ~ psqi_5g_trouble_staying_asleep_too_hot_pastmonth
      ),  
    psqi_comp_5_5h_trouble_staying_asleep_nightmares_pastmonth =
      case_when(
        psqi_5h_trouble_staying_asleep_nightmares_pastmonth == "Not during the past month" ~ "0",
        psqi_5h_trouble_staying_asleep_nightmares_pastmonth == "Less than once a week" ~ "1",
        psqi_5h_trouble_staying_asleep_nightmares_pastmonth == "Once or twice a week" ~ "2",
        psqi_5h_trouble_staying_asleep_nightmares_pastmonth == "Three or more times a week" ~ "3",
        TRUE ~ psqi_5h_trouble_staying_asleep_nightmares_pastmonth
      ),  
    psqi_comp_5_5i_trouble_staying_asleep_pain_pastmonth =
      case_when(
        psqi_5i_trouble_staying_asleep_pain_pastmonth == "Not during the past month" ~ "0",
        psqi_5i_trouble_staying_asleep_pain_pastmonth == "Less than once a week" ~ "1",
        psqi_5i_trouble_staying_asleep_pain_pastmonth == "Once or twice a week" ~ "2",
        psqi_5i_trouble_staying_asleep_pain_pastmonth == "Three or more times a week" ~ "3",
        TRUE ~ psqi_5i_trouble_staying_asleep_pain_pastmonth
      ), 
    psqi_comp_5_5j_trouble_sleeping_other_reasons_pastmonth =
      case_when(
        psqi_5j_trouble_sleeping_other_reasons_pastmonth == "Not during the past month" ~ "0",
        psqi_5j_trouble_sleeping_other_reasons_pastmonth == "Less than once a week" ~ "1",
        psqi_5j_trouble_sleeping_other_reasons_pastmonth == "Once or twice a week" ~ "2",
        psqi_5j_trouble_sleeping_other_reasons_pastmonth == "Three or more times a week" ~ "3",
        TRUE ~ psqi_5j_trouble_sleeping_other_reasons_pastmonth
      )
  ) %>%
  dplyr::mutate_at(vars(matches("psqi_comp_5_5")), as.numeric) %>%
  dplyr::mutate(
    # Component 5 - final
    psqi_comp_5_sleep_disturb_pastmonth =
      rowSums(
        across(psqi_comp_5_5b_trouble_staying_asleep_or_early_wakeup_pastmonth:psqi_comp_5_5j_trouble_sleeping_other_reasons_pastmonth), na.rm = TRUE
        ),
    psqi_comp_5_sleep_disturb_pastmonth =
      case_when(
        psqi_comp_5_sleep_disturb_pastmonth == 0 ~ 0,
        psqi_comp_5_sleep_disturb_pastmonth >= 1 & psqi_comp_5_sleep_disturb_pastmonth <= 9 ~ 1,
        psqi_comp_5_sleep_disturb_pastmonth >= 10 & psqi_comp_5_sleep_disturb_pastmonth <= 18 ~ 2,
        psqi_comp_5_sleep_disturb_pastmonth >= 19 & psqi_comp_5_sleep_disturb_pastmonth <= 27 ~ 3,
        TRUE ~ psqi_comp_5_sleep_disturb_pastmonth
      ),
    # Component 6
    psqi_comp_6_sleep_med_pastmonth =
      case_when(
        psqi_6_sleep_medicine_pastmonth == "Not during the past month" ~ "0",
        psqi_6_sleep_medicine_pastmonth == "Less than once a week" ~ "1",
        psqi_6_sleep_medicine_pastmonth == "Once or twice a week" ~ "2",
        psqi_6_sleep_medicine_pastmonth == "Three or more times a week" ~ "3",
        TRUE ~ psqi_6_sleep_medicine_pastmonth
      ),
    # Component 7 - calc
    psqi_comp_7_trouble_staying_awake_during_activities_pastmonth =
      case_when(
        psqi_7_trouble_staying_awake_during_activities_pastmonth == "Not during the past month" ~ "0",
        psqi_7_trouble_staying_awake_during_activities_pastmonth == "Less than once a week" ~ "1",
        psqi_7_trouble_staying_awake_during_activities_pastmonth == "Once or twice a week" ~ "2",
        psqi_7_trouble_staying_awake_during_activities_pastmonth == "Three or more times a week" ~ "3",
        TRUE ~ psqi_7_trouble_staying_awake_during_activities_pastmonth
        ),
    psqi_comp_7_trouble_maintaining_enthusiasm_to_get_things_done_pastmonth =
      case_when(
        psqi_8_trouble_maintaining_enthusiasm_to_get_things_done_pastmonth == "Not during the past month" ~ "0",
        psqi_8_trouble_maintaining_enthusiasm_to_get_things_done_pastmonth == "Less than once a week" ~ "1",
        psqi_8_trouble_maintaining_enthusiasm_to_get_things_done_pastmonth == "Once or twice a week" ~ "2",
        psqi_8_trouble_maintaining_enthusiasm_to_get_things_done_pastmonth == "Three or more times a week" ~ "3",
        TRUE ~ psqi_8_trouble_maintaining_enthusiasm_to_get_things_done_pastmonth
        )
  ) %>%
  dplyr::mutate_at(
    vars(matches("psqi_comp_7")), as.numeric
  ) %>%
  dplyr::mutate(
    # Component 7 - final
    psqi_comp_7_daytime_dysfunc_pastmonth =
      rowSums(
        across(psqi_comp_7_trouble_staying_awake_during_activities_pastmonth:psqi_comp_7_trouble_maintaining_enthusiasm_to_get_things_done_pastmonth)
      ),
    psqi_comp_7_daytime_dysfunc_pastmonth =
      case_when(
        psqi_comp_7_daytime_dysfunc_pastmonth == 0 ~ 0,
        psqi_comp_7_daytime_dysfunc_pastmonth == 1 | psqi_comp_7_daytime_dysfunc_pastmonth == 2 ~ 1,
        psqi_comp_7_daytime_dysfunc_pastmonth == 3 | psqi_comp_7_daytime_dysfunc_pastmonth == 4 ~ 2,
        psqi_comp_7_daytime_dysfunc_pastmonth == 5 | psqi_comp_7_daytime_dysfunc_pastmonth == 6 ~ 3,
        TRUE ~ psqi_comp_7_daytime_dysfunc_pastmonth
      )
)

df_demo <-
  df_demo %>%
  dplyr::select(
    actilife_id, age, sex, gender, race, ethnicity, psqi_1_gone_to_bed_timestamp_hms, psqi_3_wakeup_timestamp_hms, psqi_comp_1_subj_sleep_quality_pastmonth, psqi_comp2_sleep_latency_pastmonth, psqi_comp_3_sleep_duration_pastmonth, psqi_comp_4_sleep_efficiency_pastmonth, psqi_comp_5_sleep_disturb_pastmonth, psqi_comp_6_sleep_med_pastmonth, psqi_comp_7_daytime_dysfunc_pastmonth 
  ) %>%
  dplyr::mutate_at(vars(matches("psqi_comp")), as.numeric) %>%
  dplyr::mutate(
    psqi_global_score = rowSums(across(psqi_comp_1_subj_sleep_quality_pastmonth:psqi_comp_7_daytime_dysfunc_pastmonth))
  ) %>%
  dplyr::mutate(
    sleep_type =
      case_when(
        psqi_global_score > 5 ~ 1, # 1 = poor sleep
        TRUE ~ 0
      )
  )
# internal consistency
psqi_alpha <- 
  df_demo %>%
  dplyr::select(actilife_id, starts_with("psqi"), -psqi_global_score, -psqi_1_gone_to_bed_timestamp_hms, -psqi_3_wakeup_timestamp_hms, -actilife_id)
library(ltm)
cronbach.alpha(psqi_alpha, standardized = TRUE, CI = TRUE) # 0.66
```   


```{r}
# ethnicity: hispanic, not hispanic
df_demo <- 
  df_demo %>%
  dplyr::mutate(
    Ethnicity = 
      case_when(
        ethnicity == "Latine" | ethnicity == "Latinx" | ethnicity == "Mexican American" | ethnicity == "Mexican/latina" ~ "Hispanic",
        TRUE ~ "Not Hispanic"
      ),
    Race =
      case_when(
        race == "African American" | race == "Black" ~ "African American/Black",
        race == "asian" | race == "Asian" | race == "Chinese" ~ "Asian",
        race == "caucasian" | race == "Caucasian" | race == "White" | race == "European" | race == "white" ~ "White",
        race == "Hispanic/Northern European" | race == "White/Indigenous" ~ "More than one race",
        race == "N/A" ~ "Unknown/Not reported",
        TRUE ~ "NA"
      ),
    age = as.numeric(age)
  )
```

### Merging demo
```{r}
only_diary_ids <- c("vh2540", "bh2693", "ab3410") # ids with no concurrent diary - ears/act data
df_analysis_wide_demo <-
  left_join(
    df_analysis_wide, df_demo, by = "actilife_id"
  ) %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::mutate(
    n_days = n()
  ) %>%
  ungroup()

df_analysis_wide_demox <-
  left_join(
    df_analysis3, df_analysis_wide_demo, by = c("actilife_id", "device_id", "risetime_date", "day_num", "n_sources_per_person_per_day")
  ) %>%
  dplyr::select(actilife_id, age, sex, gender, Race, Ethnicity, n_days, source_combination, starts_with("psqi_")) %>%
  distinct() %>%
  drop_na(source_combination) %>%
  dplyr::filter(
    actilife_id != "vh2540"
  ) %>%
   dplyr::filter(
    actilife_id != "bh2693"
  ) %>% 
  dplyr::filter(
    actilife_id != "ab3410"
  )

df_analysis_wide_demox$sex <- factor(df_analysis_wide_demox$sex, levels = c("Male", "Female"))
df_analysis_wide_demox$Ethnicity <- factor(df_analysis_wide_demox$Ethnicity, levels = c("Not Hispanic", "Hispanic"))
df_analysis_wide_demox$Race <- factor(df_analysis_wide_demox$Race, levels = c("African American/Black", "Asian", "More than one race", "White", "Unknown/Not reported"))

df_analysis_wide_demoxx <-
  df_analysis_wide_demox %>%
  dplyr::mutate(
    Race = as.character(Race),
    Race =
      case_when(
        is.na(Race) ~ "Unknown/Not reported",
        TRUE ~ Race
      ),
    Ethnicity =
      as.character(Ethnicity),
    Ethnicity =
      case_when(
        is.na(Ethnicity) ~ "Unknown/Not reported",
        TRUE ~ Ethnicity
      )
  ) %>%
  dplyr::select(-source_combination) %>%
  distinct() 
  

demo_table_full <-
  FullTable1(
    data = df_analysis_wide_demoxx,
    strata = NULL,
    c("age", "sex", "Race", "Ethnicity", "n_days"),
    stars = "name", html = F)$table

kable(demo_table_full) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed")
    )
```


> Becker et al., 2018 (https://doi.org/10.1016/j.sleh.2018.01.001): average bedtime of 12:17am (17min from midnight), and average wake time of 8:27am (507min from midnight)


### Computing averages and differences for onset, offset, and duration between sources of data

```{r, echo=FALSE}
df_analysis_wide2 <-
  df_analysis_wide %>%
  # `sleep_` variables only exist for diary, so removing sleep_period_start_onset_minutes_ears, sleep_period_start_onset_minutes_actilife, sleep_period_start_offset_minutes_ears, sleep_period_start_offset_minutes_actilife, sleep_duration_minutes_ears, sleep_duration_minutes_actilife, sleep_onset_timestamp_ears, sleep_onset_timestamp_actilife, sleep_offset_timestamp_ears, sleep_offset_timestamp_actilife
  dplyr::select(
    -c(sleep_period_start_onset_minutes_ears, sleep_period_start_onset_minutes_actilife, sleep_period_start_offset_minutes_ears, sleep_period_start_offset_minutes_actilife, sleep_duration_minutes_ears, sleep_duration_minutes_actilife, sleep_onset_timestamp_ears, sleep_onset_timestamp_actilife, sleep_offset_timestamp_ears, sleep_offset_timestamp_actilife)
  ) %>%
  dplyr::mutate(
    # Diary and EARS Bedtime Average
    bedtime_start_onset_avg_diary_ears =
      as.numeric(
        ifelse(
          (
      !is.na(bedtime_start_onset_minutes_ears) &
        !is.na(bedtime_start_onset_minutes_diary)
      ),
      (
      bedtime_start_onset_minutes_ears + bedtime_start_onset_minutes_diary
    ) / 2,
    NA
    )),
    # Diary and Actilife Bedtime Average
    bedtime_start_onset_avg_diary_actilife =
      as.numeric(
        ifelse(
          (
      !is.na(bedtime_start_onset_minutes_actilife) &
        !is.na(bedtime_start_onset_minutes_diary)
    ),
    (
      bedtime_start_onset_minutes_actilife + bedtime_start_onset_minutes_diary
    ) / 2,
    NA
    )),
    # EARS and Actilife Bedtime Average
    bedtime_start_onset_avg_actilife_ears =
      as.numeric(
        ifelse(
          (
      !is.na(bedtime_start_onset_minutes_actilife) &
        !is.na(bedtime_start_onset_minutes_ears)
    ),
    (
      bedtime_start_onset_minutes_actilife + bedtime_start_onset_minutes_ears
    ) / 2,
    NA
    )),   
### Supplementary Diary Sleep Onset and EARS Bedtime Average
    sleep_and_bedtime_start_onset_avg_diary_ears =
      as.numeric(
        ifelse(
          (
      !is.na(bedtime_start_onset_minutes_ears) &
        !is.na(sleep_period_start_onset_minutes_diary)
      ),
      (
      bedtime_start_onset_minutes_ears + sleep_period_start_onset_minutes_diary
    ) / 2,
    NA
    )),
### Supplementary Diary Sleep Onset and Actilife Bedtime Average
    sleep_and_bedtime_start_onset_avg_diary_actilife =
      as.numeric(
        ifelse(
          (
      !is.na(bedtime_start_onset_minutes_actilife) &
        !is.na(sleep_period_start_onset_minutes_diary)
    ),
    (
      bedtime_start_onset_minutes_actilife + sleep_period_start_onset_minutes_diary
    ) / 2,
    NA
    )),
        
    # Diary and EARS Risetime Average
    risetime_start_offset_avg_diary_ears =
      as.numeric(
        ifelse(
          (
      !is.na(risetime_start_offset_minutes_ears) &
        !is.na(risetime_start_offset_minutes_diary)
    ),
    (
      risetime_start_offset_minutes_ears + risetime_start_offset_minutes_diary
    ) / 2,
    NA
    )),
    # Diary and Actilife Risetime Average
    risetime_start_offset_avg_diary_actilife =
      as.numeric(
        ifelse(
          (
      !is.na(risetime_start_offset_minutes_actilife) &
        !is.na(risetime_start_offset_minutes_diary)
    ),
    (
      risetime_start_offset_minutes_actilife + risetime_start_offset_minutes_diary
    ) / 2,
    NA
    )),
    # EARS and Actilife Risetime Average
    risetime_start_offset_avg_actilife_ears =
      as.numeric(
        ifelse(
          (
      !is.na(risetime_start_offset_minutes_actilife) &
        !is.na(risetime_start_offset_minutes_ears)
    ),
    (
      risetime_start_offset_minutes_actilife + risetime_start_offset_minutes_ears
    ) / 2,
    NA
    )),    
### Supplementary Diary Sleep Offset and EARS Risetime Average
    sleep_and_risetime_start_offset_avg_diary_ears =
      as.numeric(
        ifelse(
          (
      !is.na(risetime_start_offset_minutes_ears) &
        !is.na(sleep_period_start_offset_minutes_diary)
    ),
    (
      risetime_start_offset_minutes_ears + sleep_period_start_offset_minutes_diary
    ) / 2,
    NA
    )),
### Supplementary Diary Sleep Offset and Actilife Risetime Average
    sleep_and_risetime_start_offset_avg_diary_actilife =
      as.numeric(
        ifelse(
          (
      !is.na(risetime_start_offset_minutes_actilife) &
        !is.na(sleep_period_start_offset_minutes_diary)
    ),
    (
      risetime_start_offset_minutes_actilife + sleep_period_start_offset_minutes_diary
    ) / 2,
    NA
    )),

    # Diary and EARS Time in Bed Average
    time_in_bed_minutes_avg_diary_ears =
      as.numeric(
        ifelse(
          (
      !is.na(time_in_bed_minutes_ears) &
        !is.na(time_in_bed_minutes_diary)
    ),
    (
      time_in_bed_minutes_ears + time_in_bed_minutes_diary
    ) / 2,
    NA
    )),
    # Diary and Actilife Time in Bed Average
    time_in_bed_minutes_avg_diary_actilife =
      as.numeric(
        ifelse(
          (
      !is.na(time_in_bed_minutes_actilife) &
        !is.na(time_in_bed_minutes_diary)
    ),
    (
      time_in_bed_minutes_actilife + time_in_bed_minutes_diary
    ) / 2,
    NA
    )),
    # EARS and Actilife Time in Bed Average
    time_in_bed_minutes_avg_actilife_ears =
      as.numeric(
        ifelse(
          (
      !is.na(time_in_bed_minutes_actilife) &
        !is.na(time_in_bed_minutes_ears)
    ),
    (
      time_in_bed_minutes_actilife + time_in_bed_minutes_ears
    ) / 2,
    NA
    )),    
### Supplementary Diary Sleep Duration and EARS Time in Bed Average
    duration_and_time_in_bed_minutes_avg_diary_ears =
      as.numeric(
        ifelse(
          (
      !is.na(time_in_bed_minutes_ears) &
        !is.na(sleep_duration_minutes_diary)
    ),
    (
      time_in_bed_minutes_ears + sleep_duration_minutes_diary
    ) / 2,
    NA
    )),
### Supplementary Diary Sleep Duration and Actilife Time in Bed Average
    duration_and_time_in_bed_minutes_avg_diary_actilife =
      as.numeric(
        ifelse(
          (
      !is.na(time_in_bed_minutes_actilife) &
        !is.na(sleep_duration_minutes_diary)
    ),
    (
      time_in_bed_minutes_actilife + sleep_duration_minutes_diary
    ) / 2,
    NA
    )),    
    # Difference between Diary and EARS Bedtime
    bedtime_diff_min_diary_ears =
      as.numeric(
        difftime(
          bedtime_timestamp_diary,
          bedtime_timestamp_ears,
          units = "mins"
          )
        ),
    # Difference between Diary and Actilife Bedtime
    bedtime_diff_min_diary_actilife =
      as.numeric(
        difftime(
          bedtime_timestamp_diary,
          bedtime_timestamp_actilife,
          units = "mins"
          )
        ),
    # Difference between Actilife and EARS Bedtime
    bedtime_diff_min_actilife_ears =
      as.numeric(
        difftime(
          bedtime_timestamp_actilife,
          bedtime_timestamp_ears,
          units = "mins"
          )
        ),    
### Supplementary Difference between Diary Sleep Onset and EARS Bedtime
    sleep_onset_bedtime_diff_min_diary_ears =
      as.numeric(
        difftime(
          sleep_onset_timestamp_diary,
          bedtime_timestamp_ears,
          units = "mins"
          )
        ),
### Supplementary Difference between Diary Sleep Onset and Actilife Bedtime
    sleep_onset_bedtime_diff_min_diary_actilife =
      as.numeric(
        difftime(
          sleep_onset_timestamp_diary,
          bedtime_timestamp_actilife,
          units = "mins"
          )
        ),    
    
    # Difference between Diary and EARS Risetime
    risetime_diff_min_diary_ears =
      as.numeric(
        difftime(
          risetime_timestamp_diary,
          risetime_timestamp_ears,
          units = "mins"
          )
        ),
    # Difference between Diary and Actilife Risetime
    risetime_diff_min_diary_actilife =
      as.numeric(
        difftime(
          risetime_timestamp_diary,
          risetime_timestamp_actilife,
          units = "mins"
          )
        ),
    # Difference between Actilife and EARS Risetime
    risetime_diff_min_actilife_ears =
      as.numeric(
        difftime(
          risetime_timestamp_actilife,
          risetime_timestamp_ears,
          units = "mins"
          )
        ),  
    
### Supplementary Difference between Diary Sleep Offset and EARS Risetime
    sleep_offset_risetime_diff_min_diary_ears =
      as.numeric(
        difftime(
          sleep_offset_timestamp_diary,
          risetime_timestamp_ears,
          units = "mins"
          )
        ),
### Supplementary Difference between Diary Sleep Offset and Actilife Risetime
    sleep_offset_risetime_diff_min_diary_actilife =
      as.numeric(
        difftime(
          sleep_offset_timestamp_diary,
          risetime_timestamp_actilife,
          units = "mins"
          )
        ),    
    
    # Difference between Diary and EARS Time in Bed
    time_in_bed_minutes_diff_min_diary_ears =
      time_in_bed_minutes_diary - time_in_bed_minutes_ears,
    # Difference between Diary and Actilife Time in Bed
    time_in_bed_minutes_diff_min_diary_actilife =
      time_in_bed_minutes_diary - time_in_bed_minutes_actilife,
    # Difference between Actilife and EARS Time in Bed
    time_in_bed_minutes_diff_min_actilife_ears =
      time_in_bed_minutes_actilife - time_in_bed_minutes_ears,
    
### Supplementary Difference between Diary Sleep Duration and EARS Time in Bed
    sleep_dur_time_in_bed_minutes_diff_min_diary_ears =
      sleep_duration_minutes_diary - time_in_bed_minutes_ears,
### Supplementary Difference between Diary Sleep Duration and Actilife Time in Bed
    sleep_dur_time_in_bed_minutes_diff_min_diary_actilife =
      sleep_duration_minutes_diary - time_in_bed_minutes_actilife,    
    )
```

### Sensitivity / Specificity / Accuracy (bedtime and risetime)
To see whether ears bedtime and risetimes are more/less aligned with diary and act bedtime and risetimes

```{r, echo=FALSE,message=FALSE,warning=FALSE}
# _ _ _  ears ----
# loop thru each particpant for each sp with ears and diary times
# to extract sensitivity, specificity, and accuracy scores for 
# minute by minute comparisons across sources

df_analysis_wide_sample1 <-
  df_analysis_wide2 %>% 
  filter(!is.na(bedtime_start_onset_minutes_diary) & 
  !is.na(risetime_start_offset_minutes_diary) & 
  !is.na(bedtime_start_onset_minutes_ears) & 
  !is.na(risetime_start_offset_minutes_ears))


unique_actilife_id <- unique(df_analysis_wide2$actilife_id)

df_sp <- data.frame(minutes = seq(1, 1440, by = 1))

df_acc_ears <- data.frame(
  actilife_id <- as.character(),
  day_num <- as.character(),
  true_bed_EARS_DIARY <- as.character(),
  false_bed_EARS_DIARY <- as.character(),
  true_rise_EARS_DIARY <- as.character(),
  false_rise_EARS_DIARY <- as.character(),
  sensitivity_EARS_DIARY <- as.character(),
  specificity_EARS_DIARY <- as.character(),
  accuracy_EARS_DIARY <- as.character()
)

df_acc_ears_long <- data.frame(
  actilife_id <- as.character(),
  day_num <- as.character(),
  minutes <- as.character(),
  diary_bed <- as.character(),
  ears_bed <- as.character(),
  true_bed_EARS_DIARY <- as.character(),
  false_bed_EARS_DIARY <- as.character(),
  true_rise_EARS_DIARY <- as.character(),
  false_rise_EARS_DIARY <- as.character()  
)

for(i in seq_along(unique_actilife_id)){

  df_temp_i <- df_analysis_wide2 %>% 
    filter(
      actilife_id == unique_actilife_id[i] &
        !is.na(bedtime_start_onset_minutes_diary) & 
                 !is.na(risetime_start_offset_minutes_diary) & 
                 !is.na(bedtime_start_onset_minutes_ears) & 
                 !is.na(risetime_start_offset_minutes_ears))
  
  unique_day_num <- unique(df_temp_i$day_num) 
  
  df_epoch_by_epoch <- data.frame(
    day_num <- as.character(),
    true_bed_EARS_DIARY <- as.character(),
    false_bed_EARS_DIARY <- as.character(),
    true_rise_EARS_DIARY <- as.character(),
    false_rise_EARS_DIARY <- as.character(),
    sensitivity_EARS_DIARY <- as.character(),
    specificity_EARS_DIARY <- as.character(),
    accuracy_EARS_DIARY <- as.character()
  )
  
  df_epoch_by_epoch_long <- data.frame(
    minutes <- as.character(),
    diary_bed <- as.character(),
    ears_bed <- as.character(),
    day_num <- as.character(),
    true_bed_EARS_DIARY <- as.character(),
    false_bed_EARS_DIARY <- as.character(),
    true_rise_EARS_DIARY <- as.character(),
    false_rise_EARS_DIARY <- as.character()
    )
  
  
  for(j in seq_along(unique_day_num)){
 

  #  if(!is.na(df_temp$sleep_period_start_onset_minutes_diary[j]) & !is.na(df_temp$sleep_period_start_onset_minutes_ears[j])){
    
      df_diary_bed <- 
        data.frame(
          minutes = seq(
            df_temp_i$bedtime_start_onset_minutes_diary[j],
            df_temp_i$risetime_start_offset_minutes_diary[j],
            by = 1
            ),
          diary_bed = 1
          )


      df_ears_bed <- 
        data.frame(
          minutes = seq(
            round(df_temp_i$bedtime_start_onset_minutes_ears[j],0),
            round(df_temp_i$risetime_start_offset_minutes_ears[j],0),
            by = 1
            ),
          ears_bed = 1
          )

    
df_temp_j <- 
  left_join(df_sp, df_diary_bed, by = c("minutes")) %>% 
  left_join(df_ears_bed, by = c("minutes")) %>% mutate(day_num = j)


df_temp_j <-
  df_temp_j %>% 
  dplyr::mutate(
    true_bed_EARS_DIARY = as.numeric(ifelse((diary_bed == 1 & ears_bed == 1 & !is.na(diary_bed) & !is.na(ears_bed)), 1, 0)),
    false_bed_EARS_DIARY = as.numeric(ifelse((is.na(diary_bed) & ears_bed == 1 & !is.na(ears_bed)), 1, 0)),
    true_rise_EARS_DIARY = as.numeric(ifelse((is.na(diary_bed) & is.na(ears_bed)), 1, 0)),
    false_rise_EARS_DIARY = as.numeric(ifelse((diary_bed == 1 & is.na(ears_bed) & !is.na(diary_bed)), 1, 0))
    )

         
df_temp_j_agg <- df_temp_j %>% 
  dplyr::group_by(day_num) %>% 
  dplyr::summarise(
    true_bed_EARS_DIARY = sum(true_bed_EARS_DIARY, na.rm = TRUE), # num hits
    false_bed_EARS_DIARY = sum(false_bed_EARS_DIARY, na.rm = TRUE), # num false alarms
    true_rise_EARS_DIARY = sum(true_rise_EARS_DIARY, na.rm = TRUE), # num correct rejects
    false_rise_EARS_DIARY = sum(false_rise_EARS_DIARY, na.rm = TRUE) # num misses
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    ears.diary_bed_sensitivity = 
      true_bed_EARS_DIARY/(true_bed_EARS_DIARY + false_bed_EARS_DIARY),
    ears.diary_bed_specificity =
      true_rise_EARS_DIARY/(false_rise_EARS_DIARY + true_rise_EARS_DIARY),
    ears.diary_bed_accuracy = 
      (true_bed_EARS_DIARY + true_rise_EARS_DIARY) / (true_bed_EARS_DIARY + false_bed_EARS_DIARY + true_rise_EARS_DIARY + false_rise_EARS_DIARY),
    p_hit_ears.diary = 
      (true_bed_EARS_DIARY) / (true_bed_EARS_DIARY + false_rise_EARS_DIARY),
    p_fa_ears.diary = 
      (false_bed_EARS_DIARY) / (false_bed_EARS_DIARY + true_rise_EARS_DIARY),
    p_miss_ears.diary =
      (false_rise_EARS_DIARY) / (false_rise_EARS_DIARY + true_bed_EARS_DIARY),
    p_cr_ears.diary = 
      (true_rise_EARS_DIARY) / (true_rise_EARS_DIARY + false_bed_EARS_DIARY)
    )

      
    df_epoch_by_epoch <- rbind(df_epoch_by_epoch, df_temp_j_agg)
    df_epoch_by_epoch_long <- rbind(df_epoch_by_epoch_long, df_temp_j)

    # rm(df_temp_j, df_temp_j_agg, df_diary_sleep, df_ears_sleep)  
    
  }
  
  df_epoch_by_epoch <- 
    df_epoch_by_epoch %>% 
    dplyr::mutate(actilife_id = unique_actilife_id[i])
  
    df_epoch_by_epoch_long <- 
    df_epoch_by_epoch_long %>%
    dplyr::mutate(actilife_id = unique_actilife_id[i])
 
  df_acc_ears <- rbind(df_acc_ears, df_epoch_by_epoch)
  df_acc_ears_long <- rbind(df_acc_ears_long, df_epoch_by_epoch_long)
   
 #  rm(df_temp_i, df_epoch_by_epoch)
  
}
  
rm(df_sp)
  
# match into analysis dataset
df_analysis_wide2 <- df_analysis_wide2 %>% left_join(df_acc_ears, by = c("actilife_id", "day_num"))

df_acc_ears_person <-
  df_acc_ears_long %>% 
  dplyr::group_by(actilife_id) %>% 
  dplyr::summarise(
    true_bed_EARS_DIARY.p = sum(true_bed_EARS_DIARY, na.rm = TRUE), # num hits
    false_bed_EARS_DIARY.p = sum(false_bed_EARS_DIARY, na.rm = TRUE), # num false alarms
    true_rise_EARS_DIARY.p = sum(true_rise_EARS_DIARY, na.rm = TRUE), # num correct rejects
    false_rise_EARS_DIARY.p = sum(false_rise_EARS_DIARY, na.rm = TRUE) # num misses
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    ears.diary_bed_sensitivity.p = 
      true_bed_EARS_DIARY.p/(true_bed_EARS_DIARY.p + false_bed_EARS_DIARY.p),
    ears.diary_bed_specificity.p =
      true_rise_EARS_DIARY.p/(false_rise_EARS_DIARY.p + true_rise_EARS_DIARY.p),
    ears.diary_bed_accuracy.p = 
      (true_bed_EARS_DIARY.p + true_rise_EARS_DIARY.p) / (true_bed_EARS_DIARY.p + false_bed_EARS_DIARY.p + true_rise_EARS_DIARY.p + false_rise_EARS_DIARY.p),
    p_hit_ears.diary.p = 
      (true_bed_EARS_DIARY.p) / (true_bed_EARS_DIARY.p + false_rise_EARS_DIARY.p),
    p_fa_ears.diary.p = 
      (false_bed_EARS_DIARY.p) / (false_bed_EARS_DIARY.p + true_rise_EARS_DIARY.p),
    p_miss_ears.diary.p =
      (false_rise_EARS_DIARY.p) / (false_rise_EARS_DIARY.p + true_bed_EARS_DIARY.p),
    p_cr_ears.diary.p = 
      (true_rise_EARS_DIARY.p) / (true_rise_EARS_DIARY.p + false_bed_EARS_DIARY.p)
    )

# match into analysis dataset
df_analysis_wide2 <- df_analysis_wide2 %>% left_join(df_acc_ears_person, by = c("actilife_id"))

# _ _ _ actilife ---- 

# loop thru each particpant for each day num with ears and actilife times
# to extract sensitivity, specificity, and accuracy scores for 
# minute by minute comparisons across sources

df_analysis_wide_sample2 <-
  df_analysis_wide2 %>% 
  filter(!is.na(bedtime_start_onset_minutes_ears) & 
           !is.na(risetime_start_offset_minutes_ears) &
           !is.na(bedtime_start_onset_minutes_actilife) & 
           !is.na(risetime_start_offset_minutes_actilife))

unique_actilife_id <- unique(df_analysis_wide2$actilife_id)

df_sp <- data.frame(minutes = seq(1, 1440, by = 1))

df_acc_actilife <- data.frame(
  actilife_id <- as.character(),
  day_num <- as.character(),
  true_bed_EARS_ACT <- as.character(),
  false_bed_EARS_ACT <- as.character(),
  true_rise_EARS_ACT <- as.character(),
  false_rise_EARS_ACT <- as.character(),
  sensitivity_EARS_ACT <- as.character(),
  specificity_EARS_ACT <- as.character(),
  accuracy_EARS_ACT <- as.character()
)

df_acc_actilife_long <- data.frame(
  actilife_id <- as.character(),
  day_num <- as.character(),
  minutes <- as.character(),
  actilife_bed <- as.character(),
  ears_bed <- as.character(),
  true_bed_EARS_ACT <- as.character(),
  false_bed_EARS_ACT <- as.character(),
  true_rise_EARS_ACT <- as.character(),
  false_rise_EARS_ACT <- as.character()  
)


for(i in seq_along(unique_actilife_id)){
  
  df_temp_i <- df_analysis_wide2 %>% 
    filter(
      actilife_id == unique_actilife_id[i] &
        !is.na(bedtime_start_onset_minutes_ears) & 
        !is.na(risetime_start_offset_minutes_ears) &
        !is.na(bedtime_start_onset_minutes_actilife) & 
        !is.na(risetime_start_offset_minutes_actilife))

  
  unique_day_num <- unique(df_temp_i$day_num)
  
  df_epoch_by_epoch <- data.frame(
    day_num <- as.character(),
    true_bed_EARS_ACT <- as.character(),
    false_bed_EARS_ACT <- as.character(),
    true_rise_EARS_ACT <- as.character(),
    false_rise_EARS_ACT <- as.character(),
    sensitivity_EARS_ACT <- as.character(),
    specificity_EARS_ACT <- as.character(),
    accuracy_EARS_ACT <- as.character()
  )

  df_epoch_by_epoch_long <- data.frame(
    minutes <- as.character(),
    actilife_bed <- as.character(),
    ears_bed <- as.character(),
    day_num <- as.character(),
    true_bed_EARS_ACT<- as.character(),
    false_bed_EARS_ACT <- as.character(),
    true_rise_EARS_ACT <- as.character(),
    false_rise_EARS_ACT <- as.character()
    )
  
  for(j in seq_along(unique_day_num)){

    df_actilife_bed <- data.frame(
      minutes = seq(
        round(df_temp_i$bedtime_start_onset_minutes_actilife[j],0),
        round(df_temp_i$risetime_start_offset_minutes_actilife[j],0),
        by = 1
      ),
      actilife_bed = 1
    )
    
    
    df_ears_bed <- data.frame(
      minutes = seq(
        round(df_temp_i$bedtime_start_onset_minutes_ears[j], 0),
        round(df_temp_i$risetime_start_offset_minutes_ears[j], 0),
        by = 1
      ),
      ears_bed = 1
    )
    
   
    
    df_temp_j <- left_join(df_sp, df_actilife_bed, by = c("minutes")) %>% left_join(df_ears_bed, by = c("minutes")) %>% mutate(day_num = j) 
    
    df_temp_j <- 
      df_temp_j %>% 
      dplyr::mutate(
        true_bed_EARS_ACT =
          as.numeric(ifelse((actilife_bed == 1 & ears_bed == 1 & !is.na(actilife_bed) & !is.na(ears_bed)), 1, 0)),
        false_bed_EARS_ACT =
          as.numeric(ifelse((is.na(actilife_bed) & ears_bed == 1 & !is.na(ears_bed)), 1, 0)),
        true_rise_EARS_ACT =
          as.numeric(ifelse((is.na(actilife_bed) & is.na(ears_bed)), 1, 0)),
        false_rise_EARS_ACT = 
          as.numeric(ifelse((actilife_bed == 1 & is.na(ears_bed) & !is.na(actilife_bed)), 1, 0))
      )
    
    df_temp_j_agg <-
      df_temp_j %>% 
      dplyr::group_by(day_num) %>% 
      dplyr::summarise(
        true_bed_EARS_ACT = sum(true_bed_EARS_ACT, na.rm = TRUE), # num hits
        false_bed_EARS_ACT = sum(false_bed_EARS_ACT, na.rm = TRUE), # num false alarms
        true_rise_EARS_ACT = sum(true_rise_EARS_ACT, na.rm = TRUE), # num correct rejects
        false_rise_EARS_ACT = sum(false_rise_EARS_ACT, na.rm = TRUE) # num misses
      ) %>% 
      dplyr::ungroup() %>% 
      dplyr::mutate(
        ears.actilife_bed_sensitivity =
          true_bed_EARS_ACT/(true_bed_EARS_ACT + false_bed_EARS_ACT),
        ears.actilife_bed_specificity =
          true_rise_EARS_ACT/(false_rise_EARS_ACT + true_rise_EARS_ACT),
        ears.actilife_bed_accuracy = 
          (true_bed_EARS_ACT + true_rise_EARS_ACT) / (true_bed_EARS_ACT + false_bed_EARS_ACT + true_rise_EARS_ACT + false_rise_EARS_ACT),
        p_hit_ears.act = 
          (true_bed_EARS_ACT) / (true_bed_EARS_ACT + false_rise_EARS_ACT),
        p_fa_ears.act = 
          (false_bed_EARS_ACT) / (false_bed_EARS_ACT + true_rise_EARS_ACT),
        p_miss_ears.act =
          (false_rise_EARS_ACT) / (false_rise_EARS_ACT + true_bed_EARS_ACT),
        p_cr_ears.act = 
          (true_rise_EARS_ACT) / (true_rise_EARS_ACT + false_bed_EARS_ACT)        
        
      )
  
    df_epoch_by_epoch <- rbind(df_epoch_by_epoch, df_temp_j_agg)
    df_epoch_by_epoch_long <- rbind(df_epoch_by_epoch_long, df_temp_j)
    
    
    rm(df_temp_j, df_temp_j_agg, df_actilife_bed, df_ears_bed)  
    
  }
  
  df_epoch_by_epoch <-
    df_epoch_by_epoch %>% 
    dplyr::mutate(actilife_id = unique_actilife_id[i])
  
  df_epoch_by_epoch_long <- 
    df_epoch_by_epoch_long %>%
    dplyr::mutate(actilife_id = unique_actilife_id[i])
  
  df_acc_actilife <- rbind(df_acc_actilife, df_epoch_by_epoch)
  df_acc_actilife_long <- rbind(df_acc_actilife_long, df_epoch_by_epoch_long)  
  
  rm(df_temp_i, df_epoch_by_epoch)
  
}

rm(df_sp)

# match into analysis dataset
df_analysis_wide2 <- df_analysis_wide2 %>% left_join(df_acc_actilife, by = c("actilife_id", "day_num"))

df_acc_actilife_person <-
  df_acc_actilife_long %>% 
  dplyr::group_by(actilife_id) %>% 
  dplyr::summarise(
    true_bed_EARS_ACT.p = sum(true_bed_EARS_ACT, na.rm = TRUE), # num hits
    false_bed_EARS_ACT.p = sum(false_bed_EARS_ACT, na.rm = TRUE), # num false alarms
    true_rise_EARS_ACT.p = sum(true_rise_EARS_ACT, na.rm = TRUE), # num correct rejects
    false_rise_EARS_ACT.p = sum(false_rise_EARS_ACT, na.rm = TRUE) # num misses
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    ears.actilife_bed_sensitivity.p = 
      true_bed_EARS_ACT.p/(true_bed_EARS_ACT.p + false_bed_EARS_ACT.p),
    ears.actilife_bed_specificity.p =
      true_rise_EARS_ACT.p/(false_rise_EARS_ACT.p + true_rise_EARS_ACT.p),
    ears.actilife_bed_accuracy.p = 
      (true_bed_EARS_ACT.p + true_rise_EARS_ACT.p) / (true_bed_EARS_ACT.p + false_bed_EARS_ACT.p + true_rise_EARS_ACT.p + false_rise_EARS_ACT.p),
    p_hit_ears_actilife.p = 
      (true_bed_EARS_ACT.p) / (true_bed_EARS_ACT.p + false_rise_EARS_ACT.p),
    p_fa_ears_actilife.p = 
      (false_bed_EARS_ACT.p) / (false_bed_EARS_ACT.p + true_rise_EARS_ACT.p),
    p_miss_ears_actilife.p =
      (false_rise_EARS_ACT.p) / (false_rise_EARS_ACT.p + true_bed_EARS_ACT.p),
    p_cr_ears_actilife.p = 
      (true_rise_EARS_ACT.p) / (true_rise_EARS_ACT.p + false_bed_EARS_ACT.p)
  )

# match into analysis dataset
df_analysis_wide2 <- df_analysis_wide2 %>% left_join(df_acc_actilife_person, by = c("actilife_id"))

```


#### Supplementary Sensitivity / Specificity / Accuracy (bedtime and risetime)
To see whether ears bedtime and risetimes are more/less aligned with diary bedtime and risetimes within the truncated ears data capture schedule (8:30pm-10:39am; 849 minutes)

```{r, echo=FALSE,message=FALSE,warning=FALSE}
# _ _ _  ears ----
# loop thru each particpant for each sp with ears and diary times
# to extract sensitivity, specificity, and accuracy scores for 
# minute by minute comparisons across sources

df_analysis_wide_sample1 <-
  df_analysis_wide2 %>% 
  filter(!is.na(bedtime_start_onset_minutes_diary) & 
  !is.na(risetime_start_offset_minutes_diary) & 
  !is.na(bedtime_start_onset_minutes_ears) & 
  !is.na(risetime_start_offset_minutes_ears))


unique_actilife_id_trunc <- unique(df_analysis_wide2$actilife_id)

df_sp_trunc <- data.frame(minutes = seq(1, 849, by = 1))

df_acc_ears_trunc <- data.frame(
  actilife_id <- as.character(),
  day_num <- as.character(),
  true_bed_EARS_DIARY_t <- as.character(),
  false_bed_EARS_DIARY_t <- as.character(),
  true_rise_EARS_DIARY_t <- as.character(),
  false_rise_EARS_DIARY_t <- as.character(),
  sensitivity_EARS_DIARY_t <- as.character(),
  specificity_EARS_DIARY_t <- as.character(),
  accuracy_EARS_DIARY_t <- as.character()
)
  
df_acc_ears_trunc_long <- data.frame(
  actilife_id <- as.character(),
  day_num <- as.character(),
  minutes <- as.character(),
  diary_bed <- as.character(),
  ears_bed <- as.character(),
  true_bed_EARS_DIARY_t <- as.character(),
  false_bed_EARS_DIARY_t <- as.character(),
  true_rise_EARS_DIARY_t <- as.character(),
  false_rise_EARS_DIARY_t <- as.character()  
)

for(i in seq_along(unique_actilife_id_trunc)){

  df_temp_i_trunc <- df_analysis_wide2 %>% 
    filter(
      actilife_id == unique_actilife_id_trunc[i] &
        !is.na(bedtime_start_onset_minutes_diary) & 
                 !is.na(risetime_start_offset_minutes_diary) & 
                 !is.na(bedtime_start_onset_minutes_ears) & 
                 !is.na(risetime_start_offset_minutes_ears))
  
  unique_day_num_trunc <- unique(df_temp_i_trunc$day_num) 
  
  df_epoch_by_epoch_trunc <- data.frame(
    day_num <- as.character(),
    true_bed_EARS_DIARY_t <- as.character(),
    false_bed_EARS_DIARY_t <- as.character(),
    true_rise_EARS_DIARY_t <- as.character(),
    false_rise_EARS_DIARY_t <- as.character(),
    sensitivity_EARS_DIARY_t <- as.character(),
    specificity_EARS_DIARY_t <- as.character(),
    accuracy_EARS_DIARY_t <- as.character()
  )
    
    df_epoch_by_epoch_trunc_long <- data.frame(
    minutes <- as.character(),
    diary_bed <- as.character(),
    ears_bed <- as.character(),
    day_num <- as.character(),
    true_bed_EARS_DIARY_t <- as.character(),
    false_bed_EARS_DIARY_t <- as.character(),
    true_rise_EARS_DIARY_t <- as.character(),
    false_rise_EARS_DIARY_t <- as.character()
    )


  for(j in seq_along(unique_day_num_trunc)){
 

  #  if(!is.na(df_temp$sleep_period_start_onset_minutes_diary[j]) & !is.na(df_temp$sleep_period_start_onset_minutes_ears[j])){
    
      df_diary_bed_trunc <- 
        data.frame(
          minutes = seq(
            df_temp_i_trunc$bedtime_start_onset_minutes_diary[j],
            df_temp_i_trunc$risetime_start_offset_minutes_diary[j],
            by = 1
            ),
          diary_bed = 1
          )


      df_ears_bed_trunc <- 
        data.frame(
          minutes = seq(
            round(df_temp_i_trunc$bedtime_start_onset_minutes_ears[j],0),
            round(df_temp_i_trunc$risetime_start_offset_minutes_ears[j],0),
            by = 1
            ),
          ears_bed = 1
          )

    
df_temp_j_trunc <- 
  left_join(df_sp_trunc, df_diary_bed_trunc, by = c("minutes")) %>% 
  left_join(df_ears_bed_trunc, by = c("minutes")) %>% mutate(day_num = j)


df_temp_j_trunc <-
  df_temp_j_trunc %>% 
  dplyr::mutate(
    true_bed_EARS_DIARY_t = 
      as.numeric(ifelse((diary_bed == 1 & ears_bed == 1 & !is.na(diary_bed) & !is.na(ears_bed)), 1, 0)),
    false_bed_EARS_DIARY_t =
      as.numeric(ifelse((is.na(diary_bed) & ears_bed == 1 & !is.na(ears_bed)), 1, 0)),
    true_rise_EARS_DIARY_t = 
      as.numeric(ifelse((is.na(diary_bed) & is.na(ears_bed)), 1, 0)),
    false_rise_EARS_DIARY_t = 
      as.numeric(ifelse((diary_bed == 1 & is.na(ears_bed) & !is.na(diary_bed)), 1, 0))
    )

         
df_temp_j_agg_trunc <- 
  df_temp_j_trunc %>% 
  dplyr::group_by(day_num) %>% 
  dplyr::summarise(
    true_bed_EARS_DIARY_t = sum(true_bed_EARS_DIARY_t, na.rm = TRUE), # num hits
    false_bed_EARS_DIARY_t = sum(false_bed_EARS_DIARY_t, na.rm = TRUE), # num false alarms
    true_rise_EARS_DIARY_t = sum(true_rise_EARS_DIARY_t, na.rm = TRUE), # num correct rejects
    false_rise_EARS_DIARY_t = sum(false_rise_EARS_DIARY_t, na.rm = TRUE) # num misses
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    ears.diary_bed_sensitivity_trunc = 
      true_bed_EARS_DIARY_t/(true_bed_EARS_DIARY_t + false_bed_EARS_DIARY_t),
    ears.diary_bed_specificity_trunc =
      true_rise_EARS_DIARY_t/(false_rise_EARS_DIARY_t + true_rise_EARS_DIARY_t),
    ears.diary_bed_accuracy_trunc = 
      (true_bed_EARS_DIARY_t + true_rise_EARS_DIARY_t) / (true_bed_EARS_DIARY_t + false_bed_EARS_DIARY_t + true_rise_EARS_DIARY_t + false_rise_EARS_DIARY_t),
    p_hit_ears.diary_t = 
      (true_bed_EARS_DIARY_t) / (true_bed_EARS_DIARY_t + false_rise_EARS_DIARY_t),
    p_fa_ears.diary_t = 
      (false_bed_EARS_DIARY_t) / (false_bed_EARS_DIARY_t + true_rise_EARS_DIARY_t),
    p_miss_ears.diary_t =
      (false_rise_EARS_DIARY_t) / (false_rise_EARS_DIARY_t + true_bed_EARS_DIARY_t),
    p_cr_ears.diary_t = 
      (true_rise_EARS_DIARY_t) / (true_rise_EARS_DIARY_t + false_bed_EARS_DIARY_t)    
    )

      
    df_epoch_by_epoch_trunc <- rbind(df_epoch_by_epoch_trunc, df_temp_j_agg_trunc)
    
    df_epoch_by_epoch_trunc_long <- rbind(df_epoch_by_epoch_trunc_long, df_temp_j_trunc)

  }
  
  df_epoch_by_epoch_trunc <- 
    df_epoch_by_epoch_trunc %>% 
    dplyr::mutate(actilife_id = unique_actilife_id_trunc[i])
  
  df_epoch_by_epoch_trunc_long <- 
    df_epoch_by_epoch_trunc_long %>%
    dplyr::mutate(actilife_id = unique_actilife_id_trunc[i])
 
  df_acc_ears_trunc <- rbind(df_acc_ears_trunc, df_epoch_by_epoch_trunc)
  
  df_acc_ears_trunc_long <- rbind(df_acc_ears_trunc_long, df_epoch_by_epoch_trunc_long)
  
 #  rm(df_temp_i, df_epoch_by_epoch)
  
}
  
rm(df_sp_trunc)
  
# match into analysis dataset
df_analysis_wide2 <- df_analysis_wide2 %>% left_join(df_acc_ears_trunc, by = c("actilife_id", "day_num"))


df_acc_ears_trunc_person <-
  df_acc_ears_trunc_long %>% 
  dplyr::group_by(actilife_id) %>% 
  dplyr::summarise(
    true_bed_EARS_DIARY_t.p = sum(true_bed_EARS_DIARY_t, na.rm = TRUE), # num hits
    false_bed_EARS_DIARY_t.p = sum(false_bed_EARS_DIARY_t, na.rm = TRUE), # num false alarms
    true_rise_EARS_DIARY_t.p = sum(true_rise_EARS_DIARY_t, na.rm = TRUE), # num correct rejects
    false_rise_EARS_DIARY_t.p = sum(false_rise_EARS_DIARY_t, na.rm = TRUE) # num misses
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    ears.diary_bed_t_sensitivity.p = 
      true_bed_EARS_DIARY_t.p/(true_bed_EARS_DIARY_t.p + false_bed_EARS_DIARY_t.p),
    ears.diary_bed_t_specificity.p =
      true_rise_EARS_DIARY_t.p/(false_rise_EARS_DIARY_t.p + true_rise_EARS_DIARY_t.p),
    ears.diary_bed_t_accuracy.p = 
      (true_bed_EARS_DIARY_t.p + true_rise_EARS_DIARY_t.p) / (true_bed_EARS_DIARY_t.p + false_bed_EARS_DIARY_t.p + true_rise_EARS_DIARY_t.p + false_rise_EARS_DIARY_t.p),
    p_hit_ears_diary_t.p = 
      (true_bed_EARS_DIARY_t.p) / (true_bed_EARS_DIARY_t.p + false_rise_EARS_DIARY_t.p),
    p_fa_ears_diary_t.p = 
      (false_bed_EARS_DIARY_t.p) / (false_bed_EARS_DIARY_t.p + true_rise_EARS_DIARY_t.p),
    p_miss_ears_diary_t.p =
      (false_rise_EARS_DIARY_t.p) / (false_rise_EARS_DIARY_t.p + true_bed_EARS_DIARY_t.p),
    p_cr_ears_diary_t.p = 
      (true_rise_EARS_DIARY_t.p) / (true_rise_EARS_DIARY_t.p + false_bed_EARS_DIARY_t.p)
  )

# match into analysis dataset
df_analysis_wide2 <- df_analysis_wide2 %>% left_join(df_acc_ears_trunc_person, by = c("actilife_id"))


```


#### Supplementary Sensitivity / Specificity / Accuracy (ears bedtime/risetime v diary sleep onset and offset)
To see whether ears bedtime and risetimes are more/less aligned with diary sleep onset and offset

```{r, echo=FALSE,message=FALSE,warning=FALSE}
# _ _ _  ears ----
# loop thru each particpant for each sp with ears and diary times
# to extract sensitivity, specificity, and accuracy scores for 
# minute by minute comparisons across sources

df_analysis_wide_sample1_supp <-
  df_analysis_wide2 %>% 
  filter(!is.na(sleep_period_start_onset_minutes_diary) & 
  !is.na(sleep_period_start_offset_minutes_diary) & 
  !is.na(bedtime_start_onset_minutes_ears) & 
  !is.na(risetime_start_offset_minutes_ears))


unique_actilife_id_supp <- unique(df_analysis_wide2$actilife_id)

df_sp_supp <- data.frame(minutes = seq(1, 1440, by = 1))

df_acc_ears_supp <- data.frame(
  actilife_id <- as.character(),
  day_num <- as.character(),
  true_sleep <- as.character(),
  false_sleep <- as.character(),
  true_wake <- as.character(),
  false_wake <- as.character(),
  sensitivity <- as.character(),
  specificity <- as.character(),
  accuracy <- as.character()
)

df_acc_ears_supp_long <- data.frame(
  actilife_id <- as.character(),
  day_num <- as.character(),
  minutes <- as.character(),
  diary_sleep <- as.character(),
  ears_bed <- as.character(),
  true_sleep <- as.character(),
  false_sleep <- as.character(),
  true_wake <- as.character(),
  false_wake <- as.character()
)

for(i in seq_along(unique_actilife_id_supp)){

  df_temp_i_supp <- df_analysis_wide2 %>% 
    filter(
      actilife_id == unique_actilife_id_supp[i] &
        !is.na(sleep_period_start_onset_minutes_diary) & 
                 !is.na(sleep_period_start_offset_minutes_diary) & 
                 !is.na(bedtime_start_onset_minutes_ears) & 
                 !is.na(risetime_start_offset_minutes_ears))
  
  unique_day_num_supp <- unique(df_temp_i_supp$day_num) 
  
  df_epoch_by_epoch_supp <- data.frame(
    day_num <- as.character(),
    true_sleep <- as.character(),
    false_sleep <- as.character(),
    true_wake <- as.character(),
    false_wake <- as.character(),
    sensitivity <- as.character(),
    specificity <- as.character(),
    accuracy <- as.character()
  )
  
  df_epoch_by_epoch_supp_long <- data.frame(
    minutes <- as.character(),
    diary_sleep <- as.character(),
    ears_bed <- as.character(),
    day_num <- as.character(),
    true_sleep <- as.character(),
    false_sleep <- as.character(),
    true_wake <- as.character(),
    false_wake <- as.character()
    )  


  for(j in seq_along(unique_day_num_supp)){
 

  #  if(!is.na(df_temp$sleep_period_start_onset_minutes_diary[j]) & !is.na(df_temp$sleep_period_start_onset_minutes_ears[j])){
    
      df_diary_sleep_supp <- 
        data.frame(
          minutes = seq(
            df_temp_i_supp$sleep_period_start_onset_minutes_diary[j],
            df_temp_i_supp$sleep_period_start_offset_minutes_diary[j],
            by = 1
            ),
          diary_sleep = 1
          )


      df_ears_bed_supp <- 
        data.frame(
          minutes = seq(
            round(df_temp_i_supp$bedtime_start_onset_minutes_ears[j],0),
            round(df_temp_i_supp$risetime_start_offset_minutes_ears[j],0),
            by = 1
            ),
          ears_bed = 1
          )

    
df_temp_j_supp <- 
  left_join(df_sp_supp, df_diary_sleep_supp, by = c("minutes")) %>% 
  left_join(df_ears_bed_supp, by = c("minutes")) %>% mutate(day_num = j)


df_temp_j_supp <-
  df_temp_j_supp %>% 
  dplyr::mutate(
    true_sleep = as.numeric(ifelse((diary_sleep == 1 & ears_bed == 1 & !is.na(diary_sleep) & !is.na(ears_bed)), 1, 0)),
    false_sleep = as.numeric(ifelse((is.na(diary_sleep) & ears_bed == 1 & !is.na(ears_bed)), 1, 0)),
    true_wake = as.numeric(ifelse((is.na(diary_sleep) & is.na(ears_bed)), 1, 0)),
    false_wake = as.numeric(ifelse((diary_sleep == 1 & is.na(ears_bed) & !is.na(diary_sleep)), 1, 0))
    )

         
df_temp_j_agg_supp <- df_temp_j_supp %>% 
  dplyr::group_by(day_num) %>% 
  dplyr::summarise(
    true_sleep = sum(true_sleep, na.rm = TRUE), # num hits
    false_sleep = sum(false_sleep, na.rm = TRUE), # num false alarms
    true_wake = sum(true_wake, na.rm = TRUE), # num correct rejects
    false_wake = sum(false_wake, na.rm = TRUE) # num misses
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    ears.diary_sleep_sensitivity = true_sleep/(true_sleep + false_sleep),
    ears.diary_sleep_specificity = true_wake/(false_wake + true_wake),
    ears.diary_sleep_accuracy = 
      (true_sleep + true_wake) / (true_sleep + false_sleep + true_wake + false_wake),
    p_hit_ears.diary_sleep = 
      (true_sleep) / (true_sleep + false_wake),
    p_fa_ears.diary_sleep = 
      (false_sleep) / (false_sleep + true_sleep),
    p_miss_ears.diary_sleep =
      (false_wake) / (false_wake + true_sleep),
    p_cr_ears.diary_sleep = 
      (true_wake) / (true_wake + false_sleep)  
    )

      
    df_epoch_by_epoch_supp <- rbind(df_epoch_by_epoch_supp, df_temp_j_agg_supp)
    
    df_epoch_by_epoch_supp_long <- rbind(df_epoch_by_epoch_supp_long, df_temp_j_supp)

    # rm(df_temp_j, df_temp_j_agg, df_diary_sleep, df_ears_sleep)  
    
  }
  
  df_epoch_by_epoch_supp <- 
    df_epoch_by_epoch_supp %>% 
    dplyr::mutate(actilife_id = unique_actilife_id_supp[i])

  df_epoch_by_epoch_supp_long <- 
    df_epoch_by_epoch_supp_long %>% 
    dplyr::mutate(actilife_id = unique_actilife_id_supp[i])
    
  df_acc_ears_supp <- rbind(df_acc_ears_supp, df_epoch_by_epoch_supp)
  
  df_acc_ears_supp_long <- rbind(df_acc_ears_supp_long, df_epoch_by_epoch_supp_long) 
 #  rm(df_temp_i, df_epoch_by_epoch)
  
}
  
rm(df_sp_supp)
  
# match into analysis dataset
df_analysis_wide2 <- df_analysis_wide2 %>% left_join(df_acc_ears_supp, by = c("actilife_id", "day_num"))

df_acc_ears_supp_person <-
  df_acc_ears_supp_long %>% 
  dplyr::group_by(actilife_id) %>% 
  dplyr::summarise(
    true_sleep.p = sum(true_sleep, na.rm = TRUE), # num hits
    false_sleep.p = sum(false_sleep, na.rm = TRUE), # num false alarms
    true_wake.p = sum(true_wake, na.rm = TRUE), # num correct rejects
    false_wake.p = sum(false_wake, na.rm = TRUE) # num misses
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    ears.diary_sleep_sensitivity.p = 
      true_sleep.p/(true_sleep.p + false_sleep.p),
    ears.diary_sleep_specificity.p =
      true_wake.p/(false_wake.p + true_wake.p),
    ears.diary_sleep_accuracy.p = 
      (true_sleep.p + true_wake.p) / (true_sleep.p + false_sleep.p + true_wake.p + false_wake.p),
    p_hit_ears_diary_sleep.p = 
      (true_sleep.p) / (true_sleep.p + false_wake.p),
    p_fa_ears_diary_sleep.p = 
      (false_sleep.p) / (false_sleep.p + true_wake.p),
    p_miss_ears_diary_sleep.p =
      (false_wake.p) / (false_wake.p + true_sleep.p),
    p_cr_ears_diary_sleep.p = 
      (true_wake.p) / (true_wake.p + false_sleep.p)
  )

# match into analysis dataset
df_analysis_wide2 <- df_analysis_wide2 %>% left_join(df_acc_ears_supp_person, by = c("actilife_id"))


```


## Computing differences in bedtime, risetime, and time in bed between sources

```{r, echo=FALSE,message=FALSE,warning=FALSE}
df_analysis_wide3 <- 
  df_analysis_wide2 %>% 
  drop_na(bedtime_timestamp_diary) %>%
  dplyr::mutate(
    sample_data_available = 
      ifelse(
        (!is.na(bedtime_start_onset_minutes_diary) &
           !is.na(risetime_start_offset_minutes_diary) &
           !is.na(bedtime_start_onset_minutes_ears) &
           !is.na(risetime_start_offset_minutes_ears) &
           !is.na(bedtime_start_onset_minutes_actilife) &
           !is.na(risetime_start_offset_minutes_actilife)
         ), "EARS & ActiGraph & Diary", # Jackie: added in diary here in the classification of this variable
        ifelse(
          (!is.na(bedtime_start_onset_minutes_diary) &
             !is.na(risetime_start_offset_minutes_diary) &
             !is.na(bedtime_start_onset_minutes_ears) &
             !is.na(risetime_start_offset_minutes_ears)
           ), "EARS & Diary Only",
          ifelse(
            (!is.na(bedtime_start_onset_minutes_diary) &
               !is.na(risetime_start_offset_minutes_diary) &
               !is.na(bedtime_start_onset_minutes_actilife) &
               !is.na(risetime_start_offset_minutes_actilife)
             ), "ActiGraph & Diary Only", NA) # Jackie added ActiGraph & Diary only
           )
        ),
    sample_1_flag = 
      ifelse(sample_data_available == "EARS & ActiGraph & Diary" | 
               sample_data_available == "EARS & Diary Only", 1, 0),
    sample_2_flag = 
      ifelse(sample_data_available == "ActiGraph & Diary Only" |
               sample_data_available == "EARS & ActiGraph & Diary", 1, 0),
    # difference in bedtime min between diary and ears
    bedtime_diff_min_diary_ears_abs = 
      abs(bedtime_diff_min_diary_ears),
 
    # difference in risetime min between diary and ears
    risetime_diff_min_diary_ears_abs =
      abs(risetime_diff_min_diary_ears),

    # difference in time in bed min between diary and ears
    time_in_bed_minutes_diff_min_diary_ears_abs =
      abs(time_in_bed_minutes_diff_min_diary_ears),
    
    # difference in sleep onset min diary and bedtime min ears (supp)
    sleep_onset_bedtime_diff_min_diary_ears_abs =
      abs(sleep_onset_bedtime_diff_min_diary_ears),   
    
    # difference in sleep offset min diary and risetime min ears (supp)
    sleep_offset_risetime_diff_min_diary_ears_abs =
      abs(sleep_offset_risetime_diff_min_diary_ears),      
    
    # difference in sleep duration min diary and time in bed min ears (supp)
    time_in_bed_minutes_diff_min_diary_ears_abs =
      abs(time_in_bed_minutes_diff_min_diary_ears),        
 
    # difference in bedtime min between diary and actilife
    bedtime_diff_min_diary_actilife_abs = 
      abs(bedtime_diff_min_diary_actilife),
   
    # difference in risetime min between diary and actilife
    risetime_diff_min_diary_actilife_abs = 
      abs(risetime_diff_min_diary_actilife),
  
    # difference in time in bed min between diary and actilife
    time_in_bed_minutes_diff_min_diary_actilife_abs =
      abs(time_in_bed_minutes_diff_min_diary_actilife),
    
    # difference in sleep onset min diary and bedtime min actilife (supp)
    sleep_onset_bedtime_diff_min_diary_actilife_abs = 
      abs(sleep_onset_bedtime_diff_min_diary_actilife),
   
    # difference in sleep offset min diary and risetime min actilife (supp)
    sleep_offset_risetime_diff_min_diary_actilife_abs = 
      abs(sleep_offset_risetime_diff_min_diary_actilife),
  
    # difference in sleep duration min diary and time in bed min actilife (supp)
    sleep_dur_time_in_bed_minutes_diff_min_diary_actilife_abs =
      abs(sleep_dur_time_in_bed_minutes_diff_min_diary_actilife),    
    
    # difference in bedtime min between ears and actilife
    bedtime_diff_min_actilife_ears_abs = 
      abs(bedtime_diff_min_actilife_ears),
   
    # difference in risetime min between ears and actilife
    risetime_diff_min_actilife_ears_abs = 
      abs(risetime_diff_min_actilife_ears),

    # difference in time in bed min between ears and actilife
    time_in_bed_minutes_diff_min_actilife_ears_abs =
      abs(time_in_bed_minutes_diff_min_actilife_ears)
    )
```

### Updating analysis roster

```{r, echo=FALSE}
# df_analysis_roster ----

df_sample_1 <- # EARS & Diary (some with Actilife)
  df_analysis_wide3 %>% 
  filter(sample_1_flag == 1) %>% 
  dplyr::group_by(actilife_id, device_id, sample_1_flag) %>% 
  dplyr::summarise(
    n_ears = n()
    ) %>% 
  dplyr::select(-n_ears) # 29 have EARS and Diary data

df_sample_2 <- # Diary & Actilife (some with EARS)
  df_analysis_wide3 %>%
  filter(sample_2_flag == 1) %>% 
  dplyr::group_by(actilife_id, sample_2_flag) %>% 
  dplyr::summarise(
    n_actilife = n()
    ) %>% 
  dplyr::select(-n_actilife) # 16 have Diary & Actilife data, but not necessarily on the same day


df_analysis_roster <- full_join(df_sample_1, df_sample_2)

rm(df_sample_1, df_sample_2)


# update df_analysis with roster data (sample flags)

df_analysis4 <- 
  df_analysis3 %>%
  left_join(df_analysis_roster, by = c("actilife_id"))

```


#### Inspecting outliers 

```{r, echo=FALSE,message=FALSE,warning=FALSE}
# ---- Diary ---- 

### Time in Bed
diary_tib_dist <- 
  df_analysis_wide3 %>%
  ggplot(
    aes(x = time_in_bed_minutes_diary)
  ) + 
  geom_boxplot() + # looks okay (maybe 1 outliers)
  labs(
    x = "Time in Bed (Min)"
  ) +
  theme(axis.title.x = element_text(size = 10))
# get mean and sd
mean <- mean(df_analysis_wide3$time_in_bed_minutes_diary, na.rm = TRUE)
sd <- sd(df_analysis_wide3$time_in_bed_minutes_diary, na.rm = TRUE)
# get threshold values for outliers
Tmin = mean-(3*sd) 
Tmax = mean+(3*sd)
# find outlier
out <- df_analysis_wide3$time_in_bed_minutes_diary[which(df_analysis_wide3$time_in_bed_minutes_diary < Tmin | df_analysis_wide3$time_in_bed_minutes_diary > Tmax)]
out_ind <- which(df_analysis_wide3$time_in_bed_minutes_diary %in% c(out)) # no outliers


### Bedtime
diary_bedtime_dist <-
  df_analysis_wide3 %>%
  ggplot(
    aes(x = bedtime_start_onset_minutes_diary)
  ) + 
  geom_boxplot() +
    labs(
    x = "Bedtime (Min from Midnight)"
  ) +
  theme(axis.title.x = element_text(size = 10))
  
# get mean and sd
mean <- mean(df_analysis_wide3$bedtime_start_onset_minutes_diary, na.rm = TRUE)
sd <- sd(df_analysis_wide3$bedtime_start_onset_minutes_diary, na.rm = TRUE)
# get threshold values for outliers
Tmin = mean-(3*sd) 
Tmax = mean+(3*sd)
# find outlier
out <- df_analysis_wide3$bedtime_start_onset_minutes_diary[which(df_analysis_wide3$bedtime_start_onset_minutes_diary < Tmin | df_analysis_wide3$bedtime_start_onset_minutes_diary > Tmax)]
out_ind <- which(df_analysis_wide3$bedtime_start_onset_minutes_diary %in% c(out))
out_ids <- df_analysis_wide3 %>% slice(14, 19, 62)# vh2540 (day 1, 280 min); vh2540 (day 6, 291 min); kk1526 (day 5, 360 min)


### Risetime
diary_risetime_dist <- 
  df_analysis_wide3 %>%
  ggplot(
    aes(x = risetime_start_offset_minutes_diary)
  ) + 
  geom_boxplot() +
    labs(
    x = "Rise Time (Min from Midnight)"
  ) +
  theme(axis.title.x = element_text(size = 10))

# get mean and sd
mean <- mean(df_analysis_wide3$risetime_start_offset_minutes_diary, na.rm = TRUE)
sd <- sd(df_analysis_wide3$risetime_start_offset_minutes_diary, na.rm = TRUE)
# get threshold values for outliers
Tmin = mean-(3*sd) 
Tmax = mean+(3*sd)
# find outlier
out <- df_analysis_wide3$risetime_start_offset_minutes_diary[which(df_analysis_wide3$risetime_start_offset_minutes_diary < Tmin | df_analysis_wide3$risetime_start_offset_minutes_diary > Tmax)]
out_ind <- which(df_analysis_wide3$risetime_start_offset_minutes_diary %in% c(out))
out_ids <- df_analysis_wide3 %>% slice(14) # vh2540 (day 1, 900 min)

(diary_bedtime_dist + diary_risetime_dist +  diary_tib_dist) +
  plot_annotation(
    title = "Distribution of Diary Self-Reported Bedtime, Risetime, and Time-in-Bed",
    subtitle = "",
    caption = ""
  )

#############################################

### Sleep Duration
diary_dur_dist <- 
  df_analysis_wide3 %>%
  ggplot(
    aes(x = sleep_duration_minutes_diary)
  ) + 
  geom_boxplot() + # looks okay (maybe 4 outliers)
  labs(
    x = "Sleep Duration (Min)"
  ) +
  theme(axis.title.x = element_text(size = 10))
# get mean and sd
mean <- mean(df_analysis_wide3$sleep_duration_minutes_diary, na.rm = TRUE)
sd <- sd(df_analysis_wide3$sleep_duration_minutes_diary, na.rm = TRUE)
# get threshold values for outliers
Tmin = mean-(3*sd) 
Tmax = mean+(3*sd)
# find outlier
out <- df_analysis_wide3$sleep_duration_minutes_diary[which(df_analysis_wide3$sleep_duration_minutes_diary < Tmin | df_analysis_wide3$sleep_duration_minutes_diary > Tmax)]
out_ind <- which(df_analysis_wide3$sleep_duration_minutes_diary %in% c(out))
# out_ids <- df_analysis_wide3 %>% slice(16,27) # ys8070 (day 0, 30 min); vh2540 (day 7, 0 min)


### Sleep Onset
diary_on_dist <-
  df_analysis_wide3 %>%
  ggplot(
    aes(x = sleep_period_start_onset_minutes_diary)
  ) + 
  geom_boxplot() +
    labs(
    x = "Sleep Onset (Min from Midnight)"
  ) +
  theme(axis.title.x = element_text(size = 10))
  
# get mean and sd
mean <- mean(df_analysis_wide3$sleep_period_start_onset_minutes_diary, na.rm = TRUE)
sd <- sd(df_analysis_wide3$sleep_period_start_onset_minutes_diary, na.rm = TRUE)
# get threshold values for outliers
Tmin = mean-(3*sd) 
Tmax = mean+(3*sd)
# find outlier
out <- df_analysis_wide3$sleep_period_start_onset_minutes_diary[which(df_analysis_wide3$sleep_period_start_onset_minutes_diary < Tmin | df_analysis_wide3$sleep_period_start_onset_minutes_diary > Tmax)]
out_ind <- which(df_analysis_wide3$sleep_period_start_onset_minutes_diary %in% c(out))
out_ids <- df_analysis_wide3 %>% slice(19, 62) # vh2540 (day 6, 335 min); kk1526 (day 5, 360 min)

### Sleep Offset
diary_off_dist <- 
  df_analysis_wide3 %>%
  ggplot(
    aes(x = sleep_period_start_offset_minutes_diary)
  ) + 
  geom_boxplot() +
    labs(
    x = "Sleep Offset (Min from Midnight)"
  ) +
  theme(axis.title.x = element_text(size = 10))

# get mean and sd
mean <- mean(df_analysis_wide3$sleep_period_start_offset_minutes_diary, na.rm = TRUE)
sd <- sd(df_analysis_wide3$sleep_period_start_offset_minutes_diary, na.rm = TRUE)
# get threshold values for outliers
Tmin = mean-(3*sd) 
Tmax = mean+(3*sd)
# find outlier
out <- df_analysis_wide3$sleep_period_start_offset_minutes_diary[which(df_analysis_wide3$sleep_period_start_offset_minutes_diary < Tmin | df_analysis_wide3$sleep_period_start_offset_minutes_diary > Tmax)]
out_ind <- which(df_analysis_wide3$sleep_period_start_offset_minutes_diary %in% c(out))
out_ids <- df_analysis_wide3 %>% slice(14) # vh2540 (day 1, 860 min)

(diary_on_dist + diary_off_dist + diary_dur_dist) +
  plot_annotation(
    title = "Distribution of Diary Self-Reported Sleep Onset, Offset, and Duration",
    subtitle = "",
    caption = ""
  )

```


```{r, echo=FALSE,message=FALSE,warning=FALSE}
# ---- Actilife ---- 

### Time in Bed
act_tib_dist <-
  df_analysis_wide3 %>%
  ggplot(
    aes(x = time_in_bed_minutes_actilife)
  ) + 
  geom_boxplot() + # bunch of outliers
  labs(
    x = "Time in Bed (Min)"
  ) +
  theme(axis.title.x = element_text(size = 10))

# get mean and sd
mean <- mean(df_analysis_wide3$time_in_bed_minutes_actilife, na.rm = TRUE)
sd <- sd(df_analysis_wide3$time_in_bed_minutes_actilife, na.rm = TRUE)
# get threshold values for outliers
Tmin = mean-(3*sd) 
Tmax = mean+(3*sd)
# find outlier
out <- df_analysis_wide3$time_in_bed_minutes_actilife[which(df_analysis_wide3$time_in_bed_minutes_actilife < Tmin | df_analysis_wide3$time_in_bed_minutes_actilife > Tmax)]
out_ind <- which(df_analysis_wide3$time_in_bed_minutes_actilife %in% c(out))
out_ids <- df_analysis_wide3 %>% slice(66) # kj6506 (day 3, 1405 min)


### Bedtime
act_bedtime_dist<-
  df_analysis_wide3 %>%
  ggplot(
    aes(x = bedtime_start_onset_minutes_actilife)
  ) + 
  geom_boxplot() +
  labs(
    x = "Bedtime (Min from Midnight)"
  ) +
  theme(axis.title.x = element_text(size = 10))
# get mean and sd
mean <- mean(df_analysis_wide3$bedtime_start_onset_minutes_actilife, na.rm = TRUE)
sd <- sd(df_analysis_wide3$bedtime_start_onset_minutes_actilife, na.rm = TRUE)
# get threshold values for outliers
Tmin = mean-(3*sd) 
Tmax = mean+(3*sd)
# find outlier
out <- df_analysis_wide3$bedtime_start_onset_minutes_actilife[which(df_analysis_wide3$bedtime_start_onset_minutes_actilife < Tmin | df_analysis_wide3$bedtime_start_onset_minutes_actilife > Tmax)]
out_ind <- which(df_analysis_wide3$bedtime_start_onset_minutes_actilife %in% c(out))
out_ids <- df_analysis_wide3 %>% slice(26, 66, 113) # ss9468 (day 7, -514 min); kj6506 (day 3, -599 min); jd5772 (day 5,  746)


### Risetime
act_risetime_dist <-
  df_analysis_wide3 %>%
  ggplot(
    aes(x = risetime_start_offset_minutes_actilife)
  ) + 
  geom_boxplot() +
  labs(
    x = "Rise Time (Min from Midnight)"
  ) +
  theme(axis.title.x = element_text(size = 10))
# get mean and sd
mean <- mean(df_analysis_wide3$risetime_start_offset_minutes_actilife, na.rm = TRUE)
sd <- sd(df_analysis_wide3$risetime_start_offset_minutes_actilife, na.rm = TRUE)
# get threshold values for outliers
Tmin = mean-(3*sd) 
Tmax = mean+(3*sd)
# find outlier
out <- df_analysis_wide3$risetime_start_offset_minutes_actilife[which(df_analysis_wide3$risetime_start_offset_minutes_actilife < Tmin | df_analysis_wide3$risetime_start_offset_minutes_actilife > Tmax)]
out_ind <- which(df_analysis_wide3$risetime_start_offset_minutes_actilife %in% c(out))
out_ids <- df_analysis_wide3 %>% slice(17, 169) # vh2540 (day 4, 1149 min); jm8103 (day 7, 1054 min)


(act_bedtime_dist + act_risetime_dist + act_tib_dist) +
  plot_annotation(
    title = "Distribution of ActiGraph Wearable Bedtime, Risetime, Time-in-Bed",
    subtitle = "",
    caption = "",
    theme = theme(axis.text = element_text(size = 8))
  )
```


```{r, echo=FALSE,message=FALSE,warning=FALSE}
# ---- ears ---- 

### Time in Bed
ears_tib_dist <-
  df_analysis_wide3 %>%
  ggplot(
    aes(x = time_in_bed_minutes_ears)
  ) + 
  geom_boxplot()  +
  labs(
    x = "Time in Bed (Min)"
  ) +
  theme(axis.title.x = element_text(size = 10))
# get mean and sd
mean <- mean(df_analysis_wide3$time_in_bed_minutes_ears, na.rm = TRUE)
sd <- sd(df_analysis_wide3$time_in_bed_minutes_ears, na.rm = TRUE)
# get threshold values for outliers
Tmin = mean-(3*sd) 
Tmax = mean+(3*sd)
# find outlier
out <- df_analysis_wide3$time_in_bed_minutes_ears[which(df_analysis_wide3$time_in_bed_minutes_ears < Tmin | df_analysis_wide3$time_in_bed_minutes_ears > Tmax)]
out_ind <- which(df_analysis_wide3$time_in_bed_minutes_ears %in% c(out))
out_ids <- df_analysis_wide3 %>% slice(133) # ae1365 (day 0, 50.43 min)

### Bedtime
ears_bedtime_dist <-
  df_analysis_wide3 %>%
  ggplot(
    aes(x = bedtime_start_onset_minutes_ears)
  ) + 
  geom_boxplot() +
  labs(
    x = "Bedtime (Min from Midnight)"
  ) +
  theme(axis.title.x = element_text(size = 10))
# get mean and sd
mean <- mean(df_analysis_wide3$bedtime_start_onset_minutes_ears, na.rm = TRUE)
sd <- sd(df_analysis_wide3$bedtime_start_onset_minutes_ears, na.rm = TRUE)
# get threshold values for outliers
Tmin = mean-(3*sd) 
Tmax = mean+(3*sd)
# find outlier
out <- df_analysis_wide3$bedtime_start_onset_minutes_ears[which(df_analysis_wide3$bedtime_start_onset_minutes_ears < Tmin | df_analysis_wide3$bedtime_start_onset_minutes_ears > Tmax)]
out_ind <- which(df_analysis_wide3$bedtime_start_onset_minutes_ears %in% c(out))
out_ids <- df_analysis_wide3 %>% slice(131, 133) # ae1365 (day 6, 1267 min; day 0, 1291 min)



### Risetime
ears_risetime_dist <-
  df_analysis_wide3 %>%
  ggplot(
    aes(x = risetime_start_offset_minutes_ears)
  ) + 
  geom_boxplot() +
  labs(
    x = "Rise Time (Min from Midnight)"
  ) +
  theme(axis.title.x = element_text(size = 10))
# get mean and sd
mean <- mean(df_analysis_wide3$risetime_start_offset_minutes_ears, na.rm = TRUE)
sd <- sd(df_analysis_wide3$risetime_start_offset_minutes_ears, na.rm = TRUE)
# get threshold values for outliers
Tmin = mean-(3*sd) 
Tmax = mean+(3*sd)
# find outlier
out <- df_analysis_wide3$risetime_start_offset_minutes_ears[which(df_analysis_wide3$risetime_start_offset_minutes_ears < Tmin | df_analysis_wide3$risetime_start_offset_minutes_ears > Tmax)]
out_ind <- which(df_analysis_wide3$risetime_start_offset_minutes_ears %in% c(out))
out_ids <- df_analysis_wide3 %>% slice(131, 133) # ae1365 (day 6, 1347 min; day 0, 1342 min)



(ears_bedtime_dist + ears_risetime_dist + ears_tib_dist) +
  plot_annotation(
    title = "Distribution of EARS Mobile Sensing Bedtime, Risetime, Time-in-Bed",
    subtitle = "",
    caption = "",
    theme = theme(axis.text = element_text(size = 8))
  )
```

##### DF without outliers (wide form)

```{r}
# --- Df without outliers ---

# diary time in bed: 
# no outliers
# diary bedtime minutes:  
## vh2540 (risetime date 2018-10-04, day 1, 280 min);
## vh2540 (risetime date 2018-10-09, day 6, 291 min); 
## kk1526 (risetime date 2018-10-14, day 5, 360 min).
# diary risetime minutes: 
## vh2540 (risetime date 2018-10-04, day 1, 900 min); 

# diary sleep duration: 
# no outliers
# diary sleep onset minutes:  
## vh2540 (risetime date 2018-10-09, day 6, 335 min);
## kk1526 (risetime date 2018-10-14, day 5, 360 min); 
# diary sleep offset minutes: 
## vh2540 (risetime date 2018-10-04, day 1, 860 min); 

# actilife time in bed: 
## kj6506 (risetime date 2018-10-12, day 3, 1405 min); 
# actilife bedtime minutes: 
## ss9468 (risetime date 2018-10-11, day 7, -514 min);
## kj6506 (risetime date 2018-10-12, day 3, -599 min); 
## jd5772 (risetime date 2018-10-17, day 5,  746).
# actilife risetime minutes: 
## vh2540 (risetime date 2018-10-07, day 4, 1149 min); 
## jm8103 (risetime date 2018-10-26, day 7, 1054 min). 

# ears time in bed: 
## ae1365 (risetime date 2018-10-15, day 0, 50.43 min). 
# ears bedtime minutes: 
## ae1365 (risetime date 2018-10-21, day 6, 1267 min);
## ae1365 (risetime date 2018-10-15, day 0, 1291 min). 
# ears risetime minutes: 
## ae1365 (risetime date 2018-10-21, day 6, 1347 min);
## ae1365 (risetime date 2018-10-15, day 0, 1342 min).

df_analysis_wide3 <- 
  df_analysis_wide3 %>%
  dplyr::mutate(
    outlier =
      ifelse(
        actilife_id == "vh2540" & risetime_date == "2018-10-04", 1, 0 # outlier in diary bedtime, diary risetime, diary sleep offset 
      ),
    outlier =
      ifelse(
        actilife_id == "vh2540" & risetime_date == "2018-10-09", 1, outlier # outlier in diary bedtime, diary sleep onset
      ),
    outlier =
      ifelse(
        actilife_id == "kk1526" & risetime_date == "2018-10-14", 1, outlier # outlier in diary bedtime, diary sleep onset 
      ),
    outlier =
      ifelse(
        actilife_id == "kj6506" & risetime_date == "2018-10-12", 1, outlier # outlier in actilife time-in-bed, actilife bedtime
      ),
    outlier =
      ifelse(
        actilife_id == "ss9468" & risetime_date == "2018-10-11", 1, outlier # outlier in actilife bedtime
      ),
    outlier =
      ifelse(
        actilife_id == "jd5772" & risetime_date == "2018-10-17", 1, outlier # outlier in actilife bedtime
      ),
    outlier =
      ifelse(
        actilife_id == "vh2540" & risetime_date == "2018-10-07", 1, outlier # outlier in actilife risetime
      ),
    outlier =
      ifelse(
        actilife_id == "jm8103" & risetime_date == "2018-10-26", 1, outlier # outlier in actilife risetime
      ),
    outlier =
      ifelse(
        actilife_id == "ae1365" & risetime_date == "2018-10-15", 1, outlier # outlier in ears time-in-bed, ears bedtime, ears risetime
      ),
    outlier =
      ifelse(
        actilife_id == "ae1365" & risetime_date == "2018-10-21", 1, outlier # outlier in ears bedtime, ears risetime
      )
  )
# 10 observations of outliers

df_analysis_wide3_RemOut <-
  df_analysis_wide3 %>%
  dplyr::filter(
    outlier == 0
  )
```

##### DF without outliers (long form)

```{r}
df_analysis4 <- 
  df_analysis4 %>%
  dplyr::mutate(
    outlier =
      ifelse(
        actilife_id == "vh2540" & risetime_date == "2018-10-04" & source == "diary", 1, 0
      ),
    outlier =
      ifelse(
        actilife_id == "vh2540" & risetime_date == "2018-10-09" & source == "diary", 1, outlier
      ),
    outlier =
      ifelse(
        actilife_id == "kk1526" & risetime_date == "2018-10-14" & source == "diary", 1, outlier
      ),
    outlier =
      ifelse(
        actilife_id == "kj6506" & risetime_date == "2018-10-12" & source == "actilife", 1, outlier
      ),
    outlier =
      ifelse(
        actilife_id == "ss9468" & risetime_date == "2018-10-11" & source == "actilife", 1, outlier
      ),
    outlier =
      ifelse(
        actilife_id == "jd5772" & risetime_date == "2018-10-17" & source == "actilife", 1, outlier
      ),
    outlier =
      ifelse(
        actilife_id == "vh2540" & risetime_date == "2018-10-07" & source == "actilife", 1, outlier
      ),
    outlier =
      ifelse(
        actilife_id == "jm8103" & risetime_date == "2018-10-26" & source == "actilife", 1, outlier
      ),
    outlier =
      ifelse(
        actilife_id == "ae1365" & risetime_date == "2018-10-15" & source == "ears" , 1, outlier
      ),
    outlier =
      ifelse(
        actilife_id == "ae1365" & risetime_date == "2018-10-21" & source == "ears", 1, outlier
      )
  )
# 10 observations of outliers

df_analysis4_RemOut <-
  df_analysis4 %>%
  dplyr::filter(
    outlier == 0
  )
```

#### Reinspecting Outliers

```{r, echo=FALSE,message=FALSE,warning=FALSE}


# ---- Diary ---- 

### Time in Bed
diary_tib_dist <- 
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(x = time_in_bed_minutes_diary)
  ) + 
  geom_boxplot(fill = "#E69F00")+ 
  labs(
    x = "Time-in-Bed (Min)"
  ) 
  
# get mean and sd
mean <- mean(df_analysis_wide3_RemOut$time_in_bed_minutes_diary, na.rm = TRUE)
sd <- sd(df_analysis_wide3_RemOut$time_in_bed_minutes_diary, na.rm = TRUE)

### Bedtime
diary_bedtime_dist <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(x = bedtime_start_onset_minutes_diary)
  ) + 
  geom_boxplot(fill = "#E69F00") +
    labs(
    x = "Bedtime (Min from Midnight)"
  ) 
# get mean and sd
mean <- mean(df_analysis_wide3_RemOut$bedtime_start_onset_minutes_diary, na.rm = TRUE)
sd <- sd(df_analysis_wide3_RemOut$bedtime_start_onset_minutes_diary, na.rm = TRUE)

### Risetime
diary_risetime_dist <- 
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(x = risetime_start_offset_minutes_diary)
  ) + 
  geom_boxplot(fill = "#E69F00") +
    labs(
    x = "Risetime (Min from Midnight)"
  ) 
# get mean and sd
mean <- mean(df_analysis_wide3_RemOut$risetime_start_offset_minutes_diary, na.rm = TRUE)
sd <- sd(df_analysis_wide3_RemOut$risetime_start_offset_minutes_diary, na.rm = TRUE)

(diary_bedtime_dist + diary_risetime_dist + diary_tib_dist) +
  plot_annotation(
    title = "Distribution of Diary Self-Reported Bedtime, Risetime, Time-in-Bed",
    subtitle = "",
    caption = ""
  )

#############################################

### Sleep Duration
diary_dur_dist <- 
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(x = sleep_duration_minutes_diary)
  ) + 
  geom_boxplot(fill = "#E69F00")+ 
  labs(
    x = "Sleep Duration (Min)"
  ) 
  
# get mean and sd
mean <- mean(df_analysis_wide3_RemOut$sleep_duration_minutes_diary, na.rm = TRUE)
sd <- sd(df_analysis_wide3_RemOut$sleep_duration_minutes_diary, na.rm = TRUE)

### Sleep Onset
diary_on_dist <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(x = sleep_period_start_onset_minutes_diary)
  ) + 
  geom_boxplot(fill = "#E69F00") +
    labs(
    x = "Sleep Onset (Min from Midnight)"
  ) 
# get mean and sd
mean <- mean(df_analysis_wide3_RemOut$sleep_period_start_onset_minutes_diary, na.rm = TRUE)
sd <- sd(df_analysis_wide3_RemOut$sleep_period_start_onset_minutes_diary, na.rm = TRUE)

### Sleep Offset
diary_off_dist <- 
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(x = sleep_period_start_offset_minutes_diary)
  ) + 
  geom_boxplot(fill = "#E69F00") +
    labs(
    x = "Sleep Offset (Min from Midnight)"
  ) 
# get mean and sd
mean <- mean(df_analysis_wide3_RemOut$sleep_period_start_offset_minutes_diary, na.rm = TRUE)
sd <- sd(df_analysis_wide3_RemOut$sleep_period_start_offset_minutes_diary, na.rm = TRUE)

(diary_on_dist + diary_off_dist + diary_dur_dist) +
  plot_annotation(
    title = "Distribution of Diary Self-Reported Sleep",
    subtitle = "",
    caption = ""
  )


# ---- Actilife ---- 

### Time in Bed
act_tib_dist <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(x = time_in_bed_minutes_actilife)
  ) + 
  geom_boxplot(fill = "#999999") +
  labs(
    x = "Time-in-Bed (Min)"
  )
# get mean and sd
mean <- mean(df_analysis_wide3_RemOut$time_in_bed_minutes_actilife, na.rm = TRUE)
sd <- sd(df_analysis_wide3_RemOut$time_in_bed_minutes_actilife, na.rm = TRUE)

### Bedtime
act_bedtime_dist<-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(x = bedtime_start_onset_minutes_actilife)
  ) + 
  geom_boxplot(fill = "#999999") +
  labs(
    x = "Bedtime (Min from Midnight)"
  ) 
# get mean and sd
mean <- mean(df_analysis_wide3_RemOut$bedtime_start_onset_minutes_actilife, na.rm = TRUE)
sd <- sd(df_analysis_wide3_RemOut$bedtime_start_onset_minutes_actilife, na.rm = TRUE)

### Risetime
act_risetime_dist <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(x = risetime_start_offset_minutes_actilife)
  ) + 
  geom_boxplot(fill = "#999999") +
  labs(
    x = "Risetime (Min from Midnight)"
  ) 
# get mean and sd
mean <- mean(df_analysis_wide3_RemOut$risetime_start_offset_minutes_actilife, na.rm = TRUE)
sd <- sd(df_analysis_wide3_RemOut$risetime_start_offset_minutes_actilife, na.rm = TRUE)

(act_bedtime_dist + act_risetime_dist + act_tib_dist) +
  plot_annotation(
    title = "Distribution of ActiGraph Wearable Bedtime, Risetime, Time-in-Bed",
    subtitle = "",
    caption = "",
    theme = theme(axis.text = element_text(size = 8))
  )

# ---- ears ---- 

### Time in Bed
ears_tib_dist <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(x = time_in_bed_minutes_ears)
  ) + 
  geom_boxplot(fill = "#56B4E9")  +
  labs(
    x = "Time-in-Bed (Min)"
  ) 
# get mean and sd
mean <- mean(df_analysis_wide3_RemOut$time_in_bed_minutes_ears, na.rm = TRUE)
sd <- sd(df_analysis_wide3_RemOut$time_in_bed_minutes_ears, na.rm = TRUE)

### Bedtime
ears_bedtime_dist <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(x = bedtime_start_onset_minutes_ears)
  ) + 
  geom_boxplot(fill = "#56B4E9") +
  labs(
    x = "Bedtime (Min from Midnight)"
  ) 
# get mean and sd
mean <- mean(df_analysis_wide3_RemOut$bedtime_start_onset_minutes_ears, na.rm = TRUE)
sd <- sd(df_analysis_wide3_RemOut$bedtime_start_onset_minutes_ears, na.rm = TRUE)

### Risetime
ears_risetime_dist <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(x = risetime_start_offset_minutes_ears)
  ) + 
  geom_boxplot(fill = "#56B4E9") +
  labs(
    x = "Risetime (Min from Midnight)"
  ) 
# get mean and sd
mean <- mean(df_analysis_wide3_RemOut$risetime_start_offset_minutes_ears, na.rm = TRUE)
sd <- sd(df_analysis_wide3_RemOut$risetime_start_offset_minutes_ears, na.rm = TRUE)


(ears_bedtime_dist + ears_risetime_dist + ears_tib_dist) +
  plot_annotation(
    title = "Distribution of EARS Mobile Sensing Bedtime, Risetime, Time-in-Bed",
    subtitle = "",
    caption = "",
    theme = theme(axis.text = element_text(size = 8))
  )

# plotting all 
(diary_on_dist | diary_off_dist | diary_dur_dist)  /
  (diary_bedtime_dist | diary_risetime_dist | diary_tib_dist) /
  (act_bedtime_dist |  act_risetime_dist | act_tib_dist) /
  (ears_bedtime_dist | ears_risetime_dist | ears_tib_dist) +
  plot_annotation(
    title = "Supplemental Figure 1. Distributions of Sleep Features",
    subtitle = "",
    caption = "",
    tag_levels = 'A'
  )
ggsave(filename = "SupplementalFig1.jpeg", width = 12, height = 12)
```

## Number of Days per Person

```{r}
df_analysis_wide3 <-
  df_analysis_wide3 %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::mutate(
    n_days = n()
  )
df_analysis_wide3 %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::summarise(
    n = n()
  )

df_analysis_wide3_RemOut <-
  df_analysis_wide3_RemOut %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::mutate(
    n_days = n()
  )

df_analysis_wide3_RemOut %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::summarise(
    n = n()
  ) 
```

# Writing out .Rda

```{r}
# Save
save(file = format(Sys.Date(), 'reliability_%B%e%Y.Rda'), list=c("df_analysis4","df_analysis_wide3", "df_analysis_wide3_RemOut", "df_analysis4_RemOut", "df_analysis_roster", "df_analysis_wide_demoxx"))
```

\newpage

# References

::: {#refs custom-style="Bibliography"}
:::
