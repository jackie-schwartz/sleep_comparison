---
title: "Comparison of Sleep Features across Mobile Sensors, Diaries, and Actigraphy in Young Adults"
author:
- name: Jaclyn S. Kirshenbaum
  affiliation: '1,2'
  corresponding: true
  address: 1051 Riverside Drive, 3511 Pardes New York, NY 10032
  email: Jaclyn.Kirshenbaum@nyspi.columbia.edu
  role:
  - Analysis
  - "Writing - Original Draft Preparation"
  - "Writing - Review & Editing"
- name: Ryann Crowley
  affiliation: '3'
  role: Original code and Analysis
- name: David Pagliaccio
  affiliation: '1,2'
  role: "Writing - Review & Editing"
- name: Nicholas B. Allen
  affiliation: '3'
  role:
  - Conceptualization
  - Funding
- name: Randy P. Auerbach
  affiliation: '1,2'
  role: "Writing - Review & Editing"
shorttitle: Sleep Reliability
output:
  papaja::apa6_pdf:
    latex_engine: lualatex
  html_document:
    df_print: paged
  word_document: null
  html_notebook: null
keywords: sleep, wearables, smartphones, accelerometer, reliability
wordcount: X
bibliography: "r-references.bib"
floatsintext: true
linenumbers: false
draft: false
mask: false
figurelist: false
tablelist: false
footnotelist: false
classoption: doc
affiliation:
- id: '1'
  institution: Department of Psychiatry, Columbia University, New York, NY
- id: '2'
  institution: Division of Child and Adolescent Psychiatry, New York State Psychiatric
    Institute, New York, NY
- id: '3'
  institution: Oregon Research Institute, Eugene, Oregon
editor_options:
  chunk_output_type: console
---

# Setup

```{r setup}
library("papaja")
library("kableExtra")
r_refs("r-references.bib")
```

```{r analysis-preferences}
# Seed for random number generation
set.seed(42)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed)
```

## Participants
From my analysis:
29 University students provided smartphone accelerometer, wearable, and self-reported diary data for one week. 18 participants provided actigraphy data and one participant was excluded for having only one day of data, leaving 17 participants with at least 5 days of data.
## Procedure
The current study analyzed data from the baseline week of a 4-week micro-randomized trial, as described in (Latham, 2020). At the consent session, the Effortless Assessment of Research Systems (EARS) phone application was installed on participants’ phones. The EARS app was developed by the Adolescent Development and Psychopathology Team (ADAPT) at the University of Oregon to passively collect data with minimal burden to participants (Lind et al., 2018).
## Data analysis
For all analyses, Diary data were considered “ground truth” given a) all participants were administered daily diaries, b) the questions were derived from validated measures, and c) diaries are more commonly used relative to the ActiGraph wearable and EARS smartphone application. However, we also repeat analyses with ActiGraph as the reference measurement given this wearable uses accelerometry. 

We used `r cite_r("r-references.bib")` for all our analyses.

## Libraries, color palatte, and functions

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(readr)
library(stringr)
library(lubridate)
library(data.table)
library(skimr)
library(patchwork)
library(MethodCompare)
library(DescTools)

library(lme4)
library(lmerTest)
library(knitr)
library(janitor)
library(scipub)
library(lmtest)
library(rmcorr)
library(rempsyc)
library(BlandAltmanLeh)
library(ggExtra)

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7") 
theme_set(theme_bw())
# Simple function for computing ICC from lme() output
ICClme <- function(out) {
  varests <- as.numeric(VarCorr(out)[1:2])
  return(paste("ICC =", varests[1] / sum(varests)))
}

theme_set(theme_bw(base_size = 12,base_family = "Arial")); theme_update(panel.grid.minor = element_line(linetype = "solid",linewidth =.5),axis.title.x = element_text(face = "bold"),axis.title.y = element_text(face = "bold"), plot.title = element_text(face = "bold"))
```


# Reading in files

```{r}
load("reliability_May132024.Rda")
## Reading in files

df_sleep_actilife_path  <- "~/Dropbox/Postdoc/15_Sleep_metrics_reliability/BatchSleepExportDetails(2020-03-03_14-13-01).csv"
df_sleep_diary_path <- "~/Dropbox/Postdoc/15_Sleep_metrics_reliability/sleep_diary.csv"
df_sleep_ears_path <- "~/Dropbox/Postdoc/15_Sleep_metrics_reliability/sleep_detection_final.csv"
df_ears_acc_10sec_path <- "~/Dropbox/Postdoc/15_Sleep_metrics_reliability/acc_second10_df.csv"
```

# Analysis

## Observations

> Assessing the number of observations per source, particularly when removing outliers

```{r, echo=FALSE,message=FALSE,warning=FALSE}
# Observations per Source
df_analysis4 %>% 
  ggplot(aes(day_num, fill = source)) + 
  geom_histogram(position = "dodge", binwidth = 1, col = "white") +
  facet_grid(source ~ .) +
  theme_minimal() +
  scale_fill_manual(values = cbPalette) +
  scale_x_continuous(breaks = seq(0,10, by = 1)) +
  labs(title = "Number of Observations per Day",
       x = "Day",
       fill = "",
       caption = "") +
  theme(legend.position = "none")
ggsave("number_observations_per_day_per_source.png")

# Observations per Source (RemOut)
df_analysis4_RemOut %>% 
  ggplot(aes(day_num, fill = source)) + 
  geom_histogram(position = "dodge", binwidth = 1, col = "white") +
  facet_grid(source ~ .) +
  theme_minimal() +
  scale_fill_manual(values = cbPalette) +
  scale_x_continuous(breaks = seq(0,10, by = 1)) +
  labs(title = "Number of Observations per Day",
       x = "Day",
       fill = "",
       caption = "") +
  theme(legend.position = "none")
ggsave("number_observations_per_day_per_source_RemOut.png")

source_nums <-
  df_analysis4 %>%
  drop_na(source_combination) %>%
  dplyr::group_by(source) %>%
  dplyr::summarise(
    n = n()
  )

source_nums_RemOut <-
  df_analysis4_RemOut %>%
  drop_na(source_combination) %>%  
  dplyr::group_by(source) %>%
  dplyr::summarise(
    n = n()
  )

# Observations per Source Combination
df_analysis4 %>% 
  ggplot(aes(day_num, fill = source_combination)) + 
  geom_histogram(position = "dodge", binwidth = 1, col = "white") +
  facet_grid(source_combination ~ .) +
  theme_minimal() +
  scale_fill_manual(values = cbPalette) +
  scale_x_continuous(breaks = seq(0,10, by = 1)) +
  labs(title = "Number of Observations per Day",
       x = "Day",
       fill = "",
       caption = "") +
  theme(legend.position = "none")
ggsave("number_observations_per_day_per_source_combination.png", height = 5, width = 5)

df_analysis4_RemOut %>% 
  drop_na(source_combination) %>% # droping the two participants with *only* diary data
  ggplot(aes(day_num, fill = source_combination)) + 
  geom_histogram(position = "dodge", binwidth = 1, col = "white") +
  facet_grid(source_combination ~ .) +
  theme_minimal() +
  scale_fill_manual(values = cbPalette) +
  scale_x_continuous(breaks = seq(0,10, by = 1)) +
  labs(title = "Number of Observations per Day",
       x = "Day",
       fill = "",
       caption = "") +
  theme(legend.position = "none")
ggsave("number_observations_per_day_per_source_combination_RemOut.png", height = 5, width = 5)

source_nums_comb_RemOut <- 
  df_analysis4_RemOut %>%
  drop_na(source_combination) %>%
  dplyr::group_by(source_combination) %>%
  dplyr::summarise(
    n = n()
  )

source_nums_comb <- 
  df_analysis4 %>%
  drop_na(source_combination) %>%
  dplyr::group_by(source_combination) %>%
  dplyr::summarise(
    n = n()
  )

df_analysis4_RemOut %>%
  drop_na(source_combination) %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::summarise(
    n = n()
  )


df_analysis_wide3_RemOut %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::summarise(
    n = n()
  )
```

> Considering the sources of data separately, there are `r source_nums$n[1]` observations of ActiGraph, `r source_nums$n[2]` observations of Diary, and `r source_nums$n[3]` observations of EARS data. In combination, there are `r source_nums_comb$n[1]` observations of Diary and ActiGraph data, `r source_nums_comb$n[2]` observations of Diary and EARS data, and `r source_nums_comb$n[3]` observations of Diary, EARS, and ActiGraph data.  With the removal of outliers and the two participant with only Diary data (_n_=13 observations), there are `r source_nums_RemOut$n[1]` observations of actilife, `r source_nums_RemOut$n[2]` observations of Diary, and `r source_nums_RemOut$n[3]` observations of EARS data. In combination, there are `r source_nums_comb_RemOut$n[1]` observations of Diary and ActiGraph data, `r source_nums_comb_RemOut$n[2]` observations of Diary and EARS data, and `r source_nums_comb_RemOut$n[3]` observations of Diary, EARS, and ActiGraph data. 

> Only using the "RemOut" dataframes moving forward removing the observations with Diary-only data

# Descriptives

## Summary of participant numbers

```{r}
df_analysis3_sum <-
  df_analysis_wide3_RemOut %>%
  dplyr::group_by(actilife_id, sample_data_available) %>%
  dplyr::summarise(
    n = n()
  ) %>%
  distinct() %>%
  dplyr::ungroup() %>%
  dplyr::group_by(sample_data_available) %>%
  dplyr::summarise(
    n = n()
  ) %>%
  dplyr::rename("Source" = sample_data_available)
# Same number of participants with and without outliers - and then there were two participants removed due to just having diary data, so reduced N to 32


```

> Considering the sources of data together, `r df_analysis3_sum$n[1]` participants have Diary & ActiGraph data, `r df_analysis3_sum$n[2]` participants have Diary & EARS data, `r df_analysis3_sum$n[3]` participants have Diary, EARS, and ActiGraph data.


## Summary of Bedtime, Rise Time, and Time in Bed

```{r, echo=FALSE, message=FALSE, warning=FALSE, attr.output=FALSE}
# EARS, Diary, ActiGraph descriptives of onset, offset, and duration
table_descriptives_RemOut <- 
  df_analysis_wide3_RemOut %>%
  dplyr::ungroup() %>%
  dplyr::summarise(
    Sleep_Onset_Mean_Minutes_from_Midnight_EARS = round(mean(sleep_period_start_onset_minutes_ears, na.rm = TRUE),2),
    Sleep_Onset_Med_Minutes_from_Midnight_EARS = round(median(sleep_period_start_onset_minutes_ears, na.rm = TRUE),2),
    Sleep_Onset_SD_Minutes_from_Midnight_EARS = round(sd(sleep_period_start_onset_minutes_ears, na.rm = TRUE),2),
    Sleep_Onset_Min_Minutes_from_Midnight_EARS = round(min(sleep_period_start_onset_minutes_ears, na.rm = TRUE),2),
    Sleep_Onset_Max_Minutes_from_Midnight_EARS = round(max(sleep_period_start_onset_minutes_ears, na.rm = TRUE),2),  
    Sleep_Offset_Mean_Minutes_from_Midnight_EARS = round(mean(sleep_period_start_offset_minutes_ears, na.rm = TRUE),2),
    Sleep_Offset_Med_Minutes_from_Midnight_EARS = round(median(sleep_period_start_offset_minutes_ears, na.rm = TRUE),2),
    Sleep_Offset_SD_Minutes_from_Midnight_EARS = round(sd(sleep_period_start_offset_minutes_ears, na.rm = TRUE),2),
    Sleep_Offset_Min_Minutes_from_Midnight_EARS = round(min(sleep_period_start_offset_minutes_ears, na.rm = TRUE),2),
    Sleep_Offset_Max_Minutes_from_Midnight_EARS = round(max(sleep_period_start_offset_minutes_ears, na.rm = TRUE),2),
    Sleep_Duration_Mean_Minutes_EARS = round(mean(sleep_duration_minutes_ears, na.rm = TRUE),2),
    Sleep_Duration_Med_Minutes_EARS = round(median(sleep_duration_minutes_ears, na.rm = TRUE),2),
    Sleep_Duration_SD_Minutes_EARS = round(sd(sleep_duration_minutes_ears, na.rm = TRUE),2),
    Sleep_Duration_Min_Minutes_EARS = round(min(sleep_duration_minutes_ears, na.rm = TRUE),2),
    Sleep_Duration_Max_Minutes_EARS = round(max(sleep_duration_minutes_ears, na.rm = TRUE),2),
    
    Sleep_Onset_Mean_Minutes_from_Midnight_ACT = round(mean(sleep_period_start_onset_minutes_actilife, na.rm = TRUE),2),
    Sleep_Onset_Med_Minutes_from_Midnight_ACT = round(median(sleep_period_start_onset_minutes_actilife, na.rm = TRUE),2),
    Sleep_Onset_SD_Minutes_from_Midnight_ACT = round(sd(sleep_period_start_onset_minutes_actilife, na.rm = TRUE),2),
    Sleep_Onset_Min_Minutes_from_Midnight_ACT = round(min(sleep_period_start_onset_minutes_actilife, na.rm = TRUE),2),
    Sleep_Onset_Max_Minutes_from_Midnight_ACT = round(max(sleep_period_start_onset_minutes_actilife, na.rm = TRUE),2),  
    Sleep_Offset_Mean_Minutes_from_Midnight_ACT = round(mean(sleep_period_start_offset_minutes_actilife, na.rm = TRUE),2),
    Sleep_Offset_Med_Minutes_from_Midnight_ACT = round(median(sleep_period_start_offset_minutes_actilife, na.rm = TRUE),2),
    Sleep_Offset_SD_Minutes_from_Midnight_ACT = round(sd(sleep_period_start_offset_minutes_actilife, na.rm = TRUE),2),
    Sleep_Offset_Min_Minutes_from_Midnight_ACT = round(min(sleep_period_start_offset_minutes_actilife, na.rm = TRUE),2),
    Sleep_Offset_Max_Minutes_from_Midnight_ACT = round(max(sleep_period_start_offset_minutes_actilife, na.rm = TRUE),2),
    Sleep_Duration_Mean_Minutes_ACT = round(mean(sleep_duration_minutes_actilife, na.rm = TRUE),2),
    Sleep_Duration_Med_Minutes_ACT = round(median(sleep_duration_minutes_actilife, na.rm = TRUE),2),
    Sleep_Duration_SD_Minutes_ACT = round(sd(sleep_duration_minutes_actilife, na.rm = TRUE),2),
    Sleep_Duration_Min_Minutes_ACT = round(min(sleep_duration_minutes_actilife, na.rm = TRUE),2),
    Sleep_Duration_Max_Minutes_ACT = round(max(sleep_duration_minutes_actilife, na.rm = TRUE),2),
    
    Sleep_Onset_Mean_Minutes_from_Midnight_DIARY = round(mean(sleep_period_start_onset_minutes_diary, na.rm = TRUE),2),
    Sleep_Onset_Med_Minutes_from_Midnight_DIARY = round(median(sleep_period_start_onset_minutes_diary, na.rm = TRUE),2),
    Sleep_Onset_SD_Minutes_from_Midnight_DIARY = round(sd(sleep_period_start_onset_minutes_diary, na.rm = TRUE),2),
    Sleep_Onset_Min_Minutes_from_Midnight_DIARY = round(min(sleep_period_start_onset_minutes_diary, na.rm = TRUE),2),
    Sleep_Onset_Max_Minutes_from_Midnight_DIARY = round(max(sleep_period_start_onset_minutes_diary, na.rm = TRUE),2),  
    Sleep_Offset_Mean_Minutes_from_Midnight_DIARY = round(mean(sleep_period_start_offset_minutes_diary, na.rm = TRUE),2),
    Sleep_Offset_Med_Minutes_from_Midnight_DIARY = round(median(sleep_period_start_offset_minutes_diary, na.rm = TRUE),2),
    Sleep_Offset_SD_Minutes_from_Midnight_DIARY = round(sd(sleep_period_start_offset_minutes_diary, na.rm = TRUE),2),
    Sleep_Offset_Min_Minutes_from_Midnight_DIARY = round(min(sleep_period_start_offset_minutes_diary, na.rm = TRUE),2),
    Sleep_Offset_Max_Minutes_from_Midnight_DIARY = round(max(sleep_period_start_offset_minutes_diary, na.rm = TRUE),2),
    Sleep_Duration_Mean_Minutes_DIARY = round(mean(sleep_duration_minutes_diary, na.rm = TRUE),2),
    Sleep_Duration_Med_Minutes_DIARY = round(median(sleep_duration_minutes_diary, na.rm = TRUE),2),
    Sleep_Duration_SD_Minutes_DIARY = round(sd(sleep_duration_minutes_diary, na.rm = TRUE),2),
    Sleep_Duration_Min_Minutes_DIARY = round(min(sleep_duration_minutes_diary, na.rm = TRUE),2),
    Sleep_Duration_Max_Minutes_DIARY = round(max(sleep_duration_minutes_diary, na.rm = TRUE),2)
    )
write.csv(table_descriptives_RemOut, "sleep_descriptives.csv")
```

#### Supplement: Distributions ####

### Diary & EARS
```{r, echo=FALSE}
# Onset
sleep_onset_diff_min_diary_ears <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>% 
  dplyr::group_by(actilife_id) %>% 
  dplyr::summarise(
    sleep_onset_diff_min_diary_ears_mean = mean(sleep_onset_diff_min_diary_ears)
    )
mean(df_analysis_wide3_RemOut$sleep_onset_diff_min_diary_ears, na.rm=TRUE)
sd(df_analysis_wide3_RemOut$sleep_onset_diff_min_diary_ears, na.rm=TRUE)

fig_onset_ears <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>% 
  ggplot() +
  geom_density(aes(sleep_onset_diff_min_diary_ears), col = "black") +
  geom_vline(data = sleep_onset_diff_min_diary_ears, aes(xintercept=sleep_onset_diff_min_diary_ears_mean, color = actilife_id), linewidth = .5, linetype = "dashed") +
  # scale_colour_manual(name = "Days", values = c("0" = "#E69F00", "1" = "#56B4E9", "2" = "#009E73","3"= "#F0E442", 
  #                                              "4" = "#0072B2", "5"= "#D55E00", "6"= "#CC79A7", "7" = "#999999")) +
  geom_vline(aes(xintercept = mean(sleep_onset_diff_min_diary_ears, na.rm=TRUE)), linewidth =1) +
  geom_label(aes(x=mean(sleep_onset_diff_min_diary_ears, na.rm=TRUE), label=paste("mean = ", round(mean(sleep_onset_diff_min_diary_ears, na.rm=TRUE),1)), y = 0.008)) +
  labs(title = "Diary Bedtime - EARS Bedtime",
       x = "Difference in Bedtime (minutes)",
       y = "",
       color = "") +
  theme_classic()  +
  theme(legend.position="none")
fig_onset_ears

# Offset
sleep_offset_diff_min_diary_ears <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>% 
  dplyr::group_by(actilife_id) %>% 
  dplyr::summarise(
    sleep_offset_diff_min_diary_ears_mean = mean(sleep_offset_diff_min_diary_ears)
    )
mean(df_analysis_wide3_RemOut$sleep_offset_diff_min_diary_ears, na.rm=TRUE)
sd(df_analysis_wide3_RemOut$sleep_offset_diff_min_diary_ears, na.rm=TRUE)

fig_offset_ears <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>% 
  ggplot() +
  geom_density(aes(sleep_offset_diff_min_diary_ears), col = "black") +
  geom_vline(data = sleep_offset_diff_min_diary_ears, aes(xintercept=sleep_offset_diff_min_diary_ears_mean, color = actilife_id), linewidth = .5, linetype = "dashed") +
  # scale_colour_manual(name = "Days", values = c("0" = "#E69F00", "1" = "#56B4E9", "2" = "#009E73","3"= "#F0E442", 
  #                                              "4" = "#0072B2", "5"= "#D55E00", "6"= "#CC79A7", "7" = "#999999")) +
  geom_vline(aes(xintercept = mean(sleep_offset_diff_min_diary_ears, na.rm=TRUE)), linewidth =1) +
  geom_label(aes(x=mean(sleep_offset_diff_min_diary_ears, na.rm=TRUE), label=paste("mean = ", round(mean(sleep_offset_diff_min_diary_ears, na.rm=TRUE),1)), y = 0.008)) +
  labs(title = "Diary Rise Time - EARS Rise Time",
       x = "Difference in Rise Time (minutes)",
       y = "") +
  theme_classic()  +
  theme(legend.position="none")
fig_offset_ears


# Duration
sleep_dur_diff_min_diary_ears <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>% 
  dplyr::group_by(actilife_id) %>% 
  dplyr::summarise(
    sleep_duration_minutes_diff_min_diary_ears_mean = mean(sleep_duration_minutes_diff_min_diary_ears)
    )
mean(df_analysis_wide3_RemOut$sleep_duration_minutes_diff_min_diary_ears, na.rm=TRUE)
sd(df_analysis_wide3_RemOut$sleep_duration_minutes_diff_min_diary_ears, na.rm=TRUE)

fig_dur_ears <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>% 
  ggplot() +
  geom_density(aes(sleep_duration_minutes_diff_min_diary_ears), col = "black") +
  geom_vline(data = sleep_dur_diff_min_diary_ears, aes(xintercept=sleep_duration_minutes_diff_min_diary_ears_mean, color = actilife_id), linewidth = .5, linetype = "dashed") +
  # scale_colour_manual(name = "Days", values = c("0" = "#E69F00", "1" = "#56B4E9", "2" = "#009E73","3"= "#F0E442", 
  #                                              "4" = "#0072B2", "5"= "#D55E00", "6"= "#CC79A7", "7" = "#999999")) +
  geom_vline(aes(xintercept = mean(sleep_duration_minutes_diff_min_diary_ears, na.rm=TRUE)), linewidth =1) +
  geom_label(aes(x=mean(sleep_duration_minutes_diff_min_diary_ears, na.rm=TRUE), label=paste("mean = ", round(mean(sleep_duration_minutes_diff_min_diary_ears, na.rm=TRUE),1)), y = 0.004)) +
  labs(title = "Diary Time in Bed - EARS Time in Bed",
       x = "Difference in Time in Bed (minutes)",
       y = "") +
  theme_classic()  +
  theme(legend.position="none")
fig_dur_ears


(fig_onset_ears ) /
  (fig_offset_ears) /
  (fig_dur_ears) +
  plot_annotation(title = "",
                  caption = "", tag_levels = 'A')
```

### Actilife & EARS
```{r, echo=FALSE}

# Onset
sleep_onset_diff_min_act_ears <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_2_flag == 1) %>% 
  dplyr::group_by(actilife_id) %>% 
  dplyr::summarise(
    sleep_onset_diff_min_actilife_ears_mean = mean(sleep_onset_diff_min_actilife_ears, na.rm = TRUE),
    sleep_onset_diff_min_actilife_ears_sd = sd(sleep_onset_diff_min_actilife_ears, na.rm = TRUE),
    )
mean(df_analysis_wide3_RemOut$sleep_onset_diff_min_actilife_ears, na.rm=TRUE)
sd(df_analysis_wide3_RemOut$sleep_onset_diff_min_actilife_ears, na.rm=TRUE)

fig_onset_ears_act <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_2_flag == 1) %>% 
  ggplot() +
  geom_density(aes(sleep_onset_diff_min_actilife_ears), col = "black") +
  geom_vline(data = sleep_onset_diff_min_act_ears, aes(xintercept=sleep_onset_diff_min_actilife_ears_mean, color = actilife_id), linewidth = .5, linetype = "dashed") +
  # scale_colour_manual(name = "Days", values = c("0" = "#E69F00", "1" = "#56B4E9", "2" = "#009E73","3"= "#F0E442", "4" = "#0072B2", "5"= "#D55E00", "6"= "#CC79A7", "7" = "#999999")) +
  geom_vline(aes(xintercept = mean(sleep_onset_diff_min_actilife_ears, na.rm=TRUE)), linewidth =1) +
  geom_label(aes(x=mean(sleep_onset_diff_min_actilife_ears, na.rm=TRUE), label=paste("mean = ", round(mean(sleep_onset_diff_min_actilife_ears, na.rm=TRUE),1)), y = 0.009)) +
  labs(title = "ActiGraph Bedtime - EARS Bedtime",
       x = "Difference in Bedtime (minutes)",
       y = "")  +
  theme_classic()  +
  theme(legend.position="none")
fig_onset_ears_act

# Offset
sleep_offset_diff_min_act_ears <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_2_flag == 1) %>% 
  dplyr::group_by(actilife_id) %>% 
  dplyr::summarise(
    sleep_offset_diff_min_actilife_ears_mean = mean(sleep_offset_diff_min_actilife_ears)
    )
mean(df_analysis_wide3_RemOut$sleep_offset_diff_min_actilife_ears, na.rm=TRUE)
sd(df_analysis_wide3_RemOut$sleep_offset_diff_min_actilife_ears, na.rm=TRUE)

fig_offset_ears_act <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_2_flag == 1) %>% 
  ggplot() +
  geom_density(aes(sleep_offset_diff_min_actilife_ears), col = "black") +
  geom_vline(data = sleep_offset_diff_min_act_ears, aes(xintercept=sleep_offset_diff_min_actilife_ears_mean, color = actilife_id), linewidth = .5, linetype = "dashed") +
  # scale_colour_manual(name = "Days", values = c("0" = "#E69F00", "1" = "#56B4E9", "2" = "#009E73","3"= "#F0E442", "4" = "#0072B2", "5"= "#D55E00", "6"= "#CC79A7", "7" = "#999999")) +
  geom_vline(aes(xintercept = mean(sleep_offset_diff_min_actilife_ears, na.rm=TRUE)), linewidth =1) +
  geom_label(aes(x=mean(sleep_offset_diff_min_actilife_ears, na.rm=TRUE), label=paste("mean = ", round(mean(sleep_offset_diff_min_actilife_ears, na.rm=TRUE),1)), y = 0.004)) +
  labs(title = "ActiGraph Rise Time - EARS Rise Time",
       x = "Difference in Rise Time (minutes)",
       y = "")  +
  theme_classic()  +
  theme(legend.position="none")
fig_offset_ears_act



# Duration
sleep_dur_diff_min_act_ears <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_2_flag == 1) %>% 
  dplyr::group_by(actilife_id) %>% 
  dplyr::summarise(
    sleep_duration_minutes_diff_min_actilife_ears_mean = mean(sleep_duration_minutes_diff_min_actilife_ears, na.rm = TRUE)
    )
mean(df_analysis_wide3_RemOut$sleep_duration_minutes_diff_min_actilife_ears, na.rm=TRUE)
sd(df_analysis_wide3_RemOut$sleep_duration_minutes_diff_min_actilife_ears, na.rm=TRUE)

fig_dur_ears_act <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_2_flag == 1) %>% 
  ggplot() +
  geom_density(aes(sleep_duration_minutes_diff_min_actilife_ears), col = "black") +
  geom_vline(data = sleep_dur_diff_min_act_ears, aes(xintercept=sleep_duration_minutes_diff_min_actilife_ears_mean, color = actilife_id), linewidth = .5, linetype = "dashed") +
  # scale_colour_manual(name = "Days", values = c("0" = "#E69F00", "1" = "#56B4E9", "2" = "#009E73","3"= "#F0E442", "4" = "#0072B2", "5"= "#D55E00", "6"= "#CC79A7", "7" = "#999999")) +
  geom_vline(aes(xintercept = mean(sleep_duration_minutes_diff_min_actilife_ears, na.rm=TRUE)), linewidth =1) +
  geom_label(aes(x=mean(sleep_duration_minutes_diff_min_actilife_ears, na.rm=TRUE), label=paste("mean = ", round(mean(sleep_duration_minutes_diff_min_actilife_ears, na.rm=TRUE),1)), y = 0.003)) +
  labs(title = "ActiGraph Time in Bed - EARS Time in Bed",
       x = "Difference in Time in Bed (minutes)",
       y = "")  +
  theme_classic()  +
  theme(legend.position="none")
fig_dur_ears_act

(fig_onset_ears_act ) /
  (fig_offset_ears_act) /
  (fig_dur_ears_act) +
  plot_annotation(title = "",
                  caption = "", tag_levels = 'A')
```

# Comparing average bedtimes, rise times, and time in bed among sources

```{r}

#  ---- onset/offset distribution ----

num_obs_per_participant <-
  df_analysis4_RemOut %>%
  filter(sample_1_flag == 1) %>%
  dplyr::group_by(actilife_id, source) %>%
  dplyr::summarise(n=n()) 

# AVERAGE BEDTIME, RISE TIME, TIME IN BED

mean_times_ears <-
  df_analysis4_RemOut %>%
  filter(sample_1_flag == 1) %>%
  dplyr::group_by(actilife_id, source) %>%
  dplyr::summarise(
    mean_onset = mean(sleep_period_start_onset_minutes, na.rm=TRUE),
    mean_offset = mean(sleep_period_start_offset_minutes, na.rm=TRUE),
    mean_dur = mean(sleep_duration_minutes, na.rm=TRUE)
  ) %>%
  dplyr::ungroup() %>%
  dplyr::mutate_if(
    is.character, as.factor
  ) %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::mutate(
    n_sources = n()
  ) %>%
  filter(
    n_sources > 1,
    source !="actilife"
  ) 

mean_times_act <-
  df_analysis4_RemOut %>%
  filter(sample_2_flag == 1) %>%
  dplyr::group_by(actilife_id, source) %>%
  dplyr::summarise(
    mean_onset = mean(sleep_period_start_onset_minutes, na.rm=TRUE),
    mean_offset = mean(sleep_period_start_offset_minutes, na.rm=TRUE),
    mean_dur = mean(sleep_duration_minutes, na.rm=TRUE)
  ) %>%
  dplyr::ungroup() %>%
  dplyr::mutate_if(
    is.character, as.factor
  ) %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::mutate(
    n_sources = n()
  ) %>%
  filter(
    n_sources > 1
  )

#  ---- Bedtime ----

# REF GROUP: DIARY
ontimes_lm <- lm(mean_onset ~ relevel(source, ref = "diary"), data = mean_times_ears)
apa_ontimes_lm <- apa_print(ontimes_lm)
apa_table(
  apa_ontimes_lm$table
  , landscape = FALSE
  , caption = "Comparing EARS to Diary Bedtimes"
)

# REF GROUP: ACTILIFE
ontimes_lm_act <- lm(mean_onset ~ relevel(source, ref = "actilife"), data = mean_times_act)
apa_ontimes_lm_act <- apa_print(ontimes_lm_act)
apa_table(
  apa_ontimes_lm_act$table
  , caption = "Comparing EARS and Diary Bedtimes to ActiGraph Bedtimes"
)

# REF GROUP: DIARY (COMPARING ACT TO DIARY)
ontimes_lm_act_diary <- lm(mean_onset ~ relevel(source, ref = "diary"), data = mean_times_act)
apa_ontimes_lm_act_diary <- apa_print(ontimes_lm_act_diary)
apa_table(
  apa_ontimes_lm_act_diary$table
  , caption = "Comparing EARS and ActiGraph Bedtimes to Diary Bedtimes"
)

#  ---- Rise Time ----

# REF GROUP: DIARY
offtimes_lm <- lm(mean_offset ~ source, data = mean_times_ears)
apa_offtimes_lm <- apa_print(offtimes_lm)
apa_table(
  apa_offtimes_lm$table
  , caption = "Comparing EARS to Diary Rise Times"
)


# REF GROUP: ACTILIFE
offtimes_lm_act <- lm(mean_offset ~ relevel(source, ref = "actilife"), data = mean_times_act)
apa_offtimes_lm_act <- apa_print(offtimes_lm_act)
apa_table(
  apa_offtimes_lm_act$table
  , caption = "Comparing EARS and Diary Rise Times to ActiGraph Rise Times"
)

# REF GROUP: DIARY (COMPARING ACT TO DIARY)
offtimes_lm_act_diary <- lm(mean_offset ~ relevel(source, ref = "diary"), data = mean_times_act)
apa_offtimes_lm_act_diary <- apa_print(offtimes_lm_act_diary)
apa_table(
  apa_offtimes_lm_act_diary$table
  , caption = "Comparing EARS and ActiGraph Rise Times to Diary Rise Times"
)


#  ---- Time in Bed ----

# REF GROUP: DIARY
dur_lm <- lm(mean_dur ~ source, data = mean_times_ears)
apa_dur_lm <- apa_print(dur_lm)
apa_table(
  apa_dur_lm$table
  , landscape = FALSE
  , caption = "Comparing EARS Time in Bed to Diary Time in Bed"
)

# REF GROUP: ACTILIFE
dur_lm_act <- lm(mean_dur ~ relevel(source, ref = "actilife"), data = mean_times_act)
apa_dur_lm_act <- apa_print(dur_lm_act)
apa_table(
  apa_dur_lm_act$table
  , caption = "Comparing EARS and Diary Time in Bed to ActiGraph Time in Bed"
)

# REF GROUP: DIARY (COMPARING ACT TO DIARY)
dur_lm_act_diary <- lm(mean_dur ~ relevel(source, ref = "diary"), data = mean_times_act)
apa_dur_lm_act_diary <- apa_print(dur_lm_act_diary)
apa_table(
  apa_dur_lm_act_diary$table
  , caption = "Comparing EARS and ActiGraph Time in Bed to Diary Time in Bed"
)

```
There is no difference in bedtime `r apa_ontimes_lm$statistic$sourceears`, rise time `r apa_offtimes_lm$statistic$sourceears` , and time in bed `r apa_dur_lm$statistic$sourceears` times between EARS and Diary sources, and there was no difference in bedtime `r apa_ontimes_lm_act$statistic$relevelsource_ref____actilife_ears`, rise time `r apa_ontimes_lm_act$statistic$relevelsource_ref____actilife_ears`, and time in bed `r apa_dur_lm_act$statistic$relevelsource_ref____actilife_ears` between EARS and ActiGraph sources (see Figure below). 

```{r}
df_analysis4_RemOut %>%
  #filter(sample_1_flag == 1) %>%
  dplyr::mutate(
    sleep_period_start_onset_hours = sleep_period_start_onset_minutes/60,
    sleep_period_start_offset_hours = sleep_period_start_offset_minutes/60
  ) %>%
  ggplot() +
  geom_density(aes(sleep_period_start_onset_hours, col = source), linewidth = 1, trim=TRUE) +
  geom_density(aes(sleep_period_start_offset_hours, col = source), linewidth = 1, linetype="dashed", trim=TRUE) +
  theme_classic() +
  scale_color_manual(values = cbPalette, labels = c("ActiGraph", "Diary", "EARS")) +
  labs(title = "The Distribution of Bedtimes and Rise Times",
       x = "Time of Day (Hours)",
       y = "Density",
       col = "") +
  scale_x_continuous(breaks = seq(-10,24, by = 2), labels = c("14", "16", "18", "20", "22", "0", "2", "4", "6", "8", "10", "12", "14", "16", "18", "20", "22", "24")) +
  theme(text = element_text(size = 12)) +
  theme(axis.text.x = element_text(size = 12))  +
  theme(axis.text.y = element_text(size = 12))  +
  geom_vline(aes(xintercept = 10.65028), colour = "#CC79A7", linetype = "solid", linewidth = .5) +
  theme(legend.direction = c("vertical"))
ggsave("~/Dropbox/Postdoc/15_Sleep_metrics_reliability/Dist_Onset_Offset_Across_Sources_ROs.tiff")
```

# Correlation between sources

```{r}
#  ---- Bedtime ----

# DIARY AND EARS

onset_de_RO <- 
  lmer(
  scale(sleep_period_start_onset_minutes_ears) ~ scale(sleep_period_start_onset_minutes_diary) + (1 | actilife_id), data = df_analysis_wide3_RemOut
)
summary(onset_de_RO)
rmcorr(participant = actilife_id, measure1 = sleep_period_start_onset_minutes_ears, measure2 = sleep_period_start_onset_minutes_diary, dataset = df_analysis_wide3_RemOut)
apa_onset_de_RO <- apa_print(onset_de_RO) # rmcorr not supported with apa_print
apa_table(
  apa_onset_de_RO$table
  , caption = "Correlation between Diary and EARS Bedtime Minutes from Midnight"
)

de_corr_onset <- 
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = sleep_period_start_onset_minutes_diary, y = sleep_period_start_onset_minutes_ears
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#56B4E9")  +
  labs(
    x = "Bedtime Minutes from Midnight (Diary)",
    y = "Bedtime \n Minutes from Midnight (EARS)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    )

# DIARY and ACTILIFE

onset_da_RO <- 
  lmer(
  scale(sleep_period_start_onset_minutes_actilife) ~ scale(sleep_period_start_onset_minutes_diary) + (1 | actilife_id), data = df_analysis_wide3_RemOut
)
summary(onset_da_RO)
rmcorr(participant = actilife_id, measure1 = sleep_period_start_onset_minutes_actilife, measure2 = sleep_period_start_onset_minutes_diary, dataset = df_analysis_wide3_RemOut)
apa_onset_da_RO <- apa_print(onset_da_RO)
apa_table(
  apa_onset_da_RO$table
  , caption = "Correlation between Diary and ActiGraph Bedtime Minutes from Midnight"
)

da_corr_onset <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = sleep_period_start_onset_minutes_diary, y = sleep_period_start_onset_minutes_actilife
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#999999")  +
  labs(
    x = "Bedtime Minutes from Midnight (Diary)",
    y = "Bedtime \n Minutes from Midnight (ActiGraph)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    )

# ACTILIFE and EARS

onset_ae_RO <- 
  lmer(
  scale(sleep_period_start_onset_minutes_ears) ~ scale(sleep_period_start_onset_minutes_actilife) + (1 | actilife_id), data = df_analysis_wide3_RemOut
)
summary(onset_ae_RO)
rmcorr(participant = actilife_id, measure1 = sleep_period_start_onset_minutes_ears, measure2 = sleep_period_start_onset_minutes_actilife, dataset = df_analysis_wide3_RemOut)
apa_onset_ae_RO <- apa_print(onset_ae_RO)
apa_table(
  apa_onset_ae_RO$table
  , caption = "Correlation between ActiGraph and EARS Bedtime Minutes from Midnight"
)

ae_corr_onset <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = sleep_period_start_onset_minutes_actilife, y = sleep_period_start_onset_minutes_ears
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#56B4E9")  +
  labs(
    x = "Bedtime Minutes from Midnight (ActiGraph)",
    y = "Bedtime \n Minutes from Midnight (EARS)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    )



#  ---- Rise Time ----

# DIARY and EARS

offset_de_RO <- 
  lmer(
  scale(sleep_period_start_offset_minutes_ears) ~ scale(sleep_period_start_offset_minutes_diary) + (1 | actilife_id), data = df_analysis_wide3_RemOut
)
summary(offset_de_RO)
rmcorr(participant = actilife_id, measure1 = sleep_period_start_offset_minutes_ears, measure2 = sleep_period_start_offset_minutes_diary, dataset = df_analysis_wide3_RemOut)
apa_offset_de_RO <- apa_print(offset_de_RO)
apa_table(
  apa_offset_de_RO$table
  , caption = "Correlation between Diary and EARS Rise Time Minutes from Midnight"
)
de_corr_offset <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = sleep_period_start_offset_minutes_diary, y = sleep_period_start_offset_minutes_ears
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#56B4E9")  +
  labs(
    x = "Rise Time Minutes from Midnight (Diary)",
    y = "Rise Time \n Minutes from Midnight (EARS)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    ) +
  geom_hline(aes(yintercept = 639), colour = "#CC79A7", linetype = "solid", linewidth = 1)

# DIARY and ACTILIFE

offset_da_RO <- 
  lmer(
  scale(sleep_period_start_offset_minutes_actilife) ~ scale(sleep_period_start_offset_minutes_diary) + (1 | actilife_id), data = df_analysis_wide3_RemOut
)
summary(offset_da_RO)
rmcorr(participant = actilife_id, measure1 = sleep_period_start_offset_minutes_actilife, measure2 = sleep_period_start_offset_minutes_diary, dataset = df_analysis_wide3_RemOut)
apa_offset_da_RO <- apa_print(offset_da_RO)
apa_table(
  apa_offset_da_RO$table
  , caption = "Correlation between Diary and ActiGraph Rise Time Minutes from Midnight"
)
da_corr_offset <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = sleep_period_start_offset_minutes_diary, y = sleep_period_start_offset_minutes_actilife
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#999999")  +
  labs(
    x = "Rise Time Minutes from Midnight (Diary)",
    y = "Rise Time \n Minutes from Midnight (ActiGraph)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    )


# ACTILIFE and EARS

offset_ae_RO <- 
  lmer(
  scale(sleep_period_start_offset_minutes_ears) ~ scale(sleep_period_start_offset_minutes_actilife) + (1 | actilife_id), data = df_analysis_wide3_RemOut
)
summary(offset_ae_RO)
rmcorr(participant = actilife_id, measure1 = sleep_period_start_offset_minutes_ears, measure2 = sleep_period_start_offset_minutes_actilife, dataset = df_analysis_wide3_RemOut)
apa_offset_ae_RO <- apa_print(offset_ae_RO)
apa_table(
  apa_offset_ae_RO$table
  , caption = "Correlation between ActiGraph and EARS Rise Time Minutes from Midnight"
)
ae_corr_offset <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = sleep_period_start_offset_minutes_actilife, y = sleep_period_start_offset_minutes_ears
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#56B4E9")  +
  labs(
    x = "Rise Time Minutes from Midnight (ActiGraph)",
    y = "Rise Time \n Minutes from Midnight (EARS)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    ) +
  geom_hline(aes(yintercept = 639), colour = "#CC79A7", linetype = "solid", linewidth = 1)


#  ---- Time in Bed ----

# DIARY and EARS

dur_de_RO <- 
  lmer(
  scale(sleep_duration_minutes_ears) ~ scale(sleep_duration_minutes_diary) + (1 | actilife_id), data = df_analysis_wide3_RemOut
)
summary(dur_de_RO)
rmcorr(participant = actilife_id, measure1 = sleep_duration_minutes_ears, measure2 = sleep_duration_minutes_diary, dataset = df_analysis_wide3_RemOut)
apa_dur_de_RO <- apa_print(dur_de_RO)
apa_table(
  apa_dur_de_RO$table
  , caption = "Correlation between Diary and EARS Time in Bed"
)
de_corr_dur <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = sleep_duration_minutes_diary, y = sleep_duration_minutes_ears
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#56B4E9")  +
  labs(
    x = "Time in Bed Minutes (Diary)",
    y = "Time in Bed \n Minutes (EARS)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    )

# DIARY and ACTILIFE

dur_da_RO <- 
  lmer(
  scale(sleep_duration_minutes_actilife) ~ scale(sleep_duration_minutes_diary) + (1 | actilife_id), data = df_analysis_wide3_RemOut
)
summary(dur_da_RO)
rmcorr(participant = actilife_id, measure1 = sleep_duration_minutes_actilife, measure2 = sleep_duration_minutes_diary, dataset = df_analysis_wide3_RemOut)
apa_dur_da_RO <- apa_print(dur_da_RO)
apa_table(
  apa_dur_da_RO$table
  , caption = "Correlation between Diary and ActiGraph Time in Bed"
)
da_corr_dur <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = sleep_duration_minutes_diary, y = sleep_duration_minutes_actilife
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#999999")  +
  labs(
    x = "Time in Bed Minutes (Diary)",
    y = "Time in Bed \n Minutes (ActiGraph)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    )

# ACTILIFE and EARS

dur_ae_RO <- 
  lmer(
  scale(sleep_duration_minutes_ears) ~ scale(sleep_duration_minutes_actilife) + (1 | actilife_id), data = df_analysis_wide3_RemOut
)
summary(dur_ae_RO)
rmcorr(participant = actilife_id, measure1 = sleep_duration_minutes_ears, measure2 = sleep_duration_minutes_actilife, dataset = df_analysis_wide3_RemOut)
apa_dur_ae_RO <- apa_print(dur_ae_RO)
apa_table(
  apa_dur_ae_RO$table
  , caption = "Correlation between ActiGraph and EARS Time in Bed"
)
ae_corr_dur <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = sleep_duration_minutes_actilife, y = sleep_duration_minutes_ears
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#56B4E9")  +
  labs(
    x = "Time in Bed Minutes (ActiGraph)",
    y = "Time in Bed \n Minutes (EARS)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    )

(de_corr_onset + de_corr_offset + de_corr_dur) /
  (ae_corr_onset + ae_corr_offset + ae_corr_dur) +
  plot_annotation(title = 'Intersource Correlations', tag_levels = 'A')

```

Bedtime is correlated among Diary, ActiGraph, and EARS sources. The association between Diary and EARS bedtime is`r apa_onset_de_RO$full_result$sleep_period_start_onset_minutes_diary`. The association between Diary and ActiGraph bedtime is`r apa_onset_da_RO$full_result$sleep_period_start_onset_minutes_diary`. The association between ActiGraph and EARS bedtime is `r apa_onset_ae_RO$full_result$sleep_period_start_onset_minutes_actilife`.  

Rise time is correlated among Diary, ActiGraph, and EARS sources. The association between Diary and EARS rise time is`r apa_offset_de_RO$full_result$sleep_period_start_offset_minutes_diary`. The association between Diary and ActiGraph rise time is`r apa_offset_da_RO$full_result$sleep_period_start_offset_minutes_diary`. The association between ActiGraph and EARS rise time is `r apa_offset_ae_RO$full_result$sleep_period_start_offset_minutes_actilife`.   

Time in bed is correlated among Diary, ActiGraph, and EARS sources. The association between Diary and EARS time in bed is`r apa_dur_de_RO$full_result$sleep_duration_minutes_diary`. The association between Diary and ActiGraph time in bed is`r apa_dur_da_RO$full_result$sleep_duration_minutes_diary`. The association between ActiGraph and EARS time in bed is `r apa_dur_ae_RO$full_result$sleep_duration_minutes_actilife`. 

# Spec/Sens/Acc

```{r}
# EARS sensitivity = true sleep epochs divided by the sum of true sleep and false sleep epochs.
# EARS specificity = true wake periods divided by the sum of false wake and true wake periods. 
# EARS accuracy = true sleep and true wake epochs divided by the sum of all true and false sleep and wake epochs

# _ Sample 1 Spec/Sens ----
ears_spec_sens <- df_analysis_wide3_RemOut %>% dplyr::select(actilife_id, sleep_offset_date, day_num, sample_1_flag, ends_with(c("sensitivity", "specificity", "accuracy"))) %>% drop_na(ears_sensitivity)
act_spec_sens <- df_analysis_wide3_RemOut %>% dplyr::select(actilife_id, sleep_offset_date, day_num, sample_2_flag, ends_with(c("sensitivity", "specificity", "accuracy"))) %>% drop_na(actilife_sensitivity)

earsdiary_spec_sens <-
  ears_spec_sens %>% # specificty and sensitivity are against the diary data (this is more intuitive than the individual participant distributions)
  filter(sample_1_flag == 1) %>% 
  ggplot() + 
 geom_line(aes(x = 1 - ears_specificity, y = ears_sensitivity), linewidth = 1.5, color = "#56B4E9", alpha = .5) +
  geom_point(aes(x = 1 - ears_specificity, y = ears_sensitivity), linewidth = 1.5, color = "#56B4E9", alpha = .5) +
  geom_abline(lty = 2, alpha = 0.5, color = "gray50", linewidth = 1.2) +
  expand_limits(x = c(0,1), y = c(0,1)) +
  theme_minimal() +
  labs(
    x = "1 - Specificity (FPR)",
    y = "Sensitivity (TPR)",
    title = "EARS ROC"
  )

actdiary_spec_sens <- # need act v diary ?
  act_spec_sens %>% # specificty and sensitivity are against the diary data (this is more intuitive than the individual participant distributions)
  filter(sample_2_flag == 1) %>% 
  ggplot() + 
  geom_line(aes(x = 1 - actilife_specificity, y = actilife_sensitivity), linewidth = 1.5, color = "#999999", alpha = .5) +
  geom_point(aes(x = 1 - actilife_specificity, y = actilife_sensitivity), linewidth = 1.5, color = "#999999", alpha = .5) +
  geom_abline(lty = 2, alpha = 0.5, color = "gray50", linewidth = 1.2) +
  expand_limits(x = c(0,1), y = c(0,1)) +
  theme_minimal() +
  labs(
    x = "1 - Specificity (FPR)",
    y = "Sensitivity (TPR)",
    title = "ActiGraph ROC"
  )


# table with sensitivty, specificity, accuracy
ears_sens_spec_acc <- 
  df_analysis_wide3_RemOut %>%
  dplyr::select(c(actilife_id, sleep_offset_date, day_num, sample_1_flag, sample_2_flag, ends_with(c("sensitivity", "specificity", "accuracy")))) %>%
  filter(sample_1_flag == 1) %>%
  drop_na(ears_sensitivity) %>%
 dplyr::group_by(actilife_id) %>%
  dplyr::summarise(
    sensitivity = mean(ears_sensitivity),
    specificity = mean(ears_specificity),
    accuracy = mean(ears_accuracy)
  ) %>%
  dplyr::ungroup() %>%
  dplyr::summarise(
    sensitivity = mean(sensitivity),
    specificity = mean(specificity),
    accuracy = mean(accuracy)
  )  

# nice_table(ears_sens_spec_acc, title = "Average EARS Sensitivity, Specificity, and Accuracy")

ears_sens_spec_acc <-
  df_analysis_wide3_RemOut %>%
  dplyr::select(c(actilife_id, sleep_offset_date, day_num, sample_1_flag, sample_2_flag, ends_with(c("sensitivity", "specificity", "accuracy")))) %>%
  filter(sample_2_flag == 1) %>%
  drop_na(actilife_sensitivity) %>%
 dplyr::group_by(actilife_id) %>%
  dplyr::summarise(
    sensitivity = mean(ears_sensitivity),
    specificity = mean(ears_specificity),
    accuracy = mean(ears_accuracy)
  ) %>%
  dplyr::ungroup() %>%
  dplyr::summarise(
    sensitivity = mean(sensitivity),
    specificity = mean(specificity),
    accuracy = mean(accuracy)
  )  
```

# Alignment across sources

```{r}
# replacing actilife id labels for visualization in publication
id_replace <- function(string) {
  abc <- c(LETTERS, "AA", "BB", "CC") # sequence letters of alphabet
  last_num <- gsub("^.*(\\d{1})$", "\\1", string) # grab last number
  out <- paste(abc, last_num, sep = "") # paste together
  out
}

# _ sleep segments ----
df_analysis4_RemOut %>%
  #filter(source_combination != "ears_actilife") %>%
  dplyr::mutate(
    y = day_num,
    adjust = ifelse(source == "diary", .2,
                    ifelse(source == "ears", 0, -.2)), # if diary, then .2, otherwise if ears then 0, otherwise, -0.2. therefore, diary = 0.2, ears = 0, actilife = -0.2
    ypos = y + adjust,
    source = fct_reorder(source, desc(adjust)),
    sleep_period_start_onset_hours = sleep_period_start_onset_minutes/60,
     sleep_period_start_offset_hours = sleep_period_start_offset_minutes/60,
     sleep_duration_hours = sleep_duration_minutes/60
  ) %>%
  ggplot(aes(color = source)) +  
  # ggplot(aes(color = source, shape = factor(day_num))) +
  # scale_shape_manual(values=c(0, 2, 3, 4, 6, 8, 18, 24, 25)) +
  geom_segment(aes(x = sleep_period_start_onset_hours, xend = sleep_period_start_offset_hours, y = ypos, yend = ypos), alpha = .8) +
  geom_point(aes(x = sleep_period_start_onset_hours, ypos), alpha = .8) +
  geom_point(aes(x = sleep_period_start_offset_hours, ypos), alpha = .8) +
  theme_minimal() +
  facet_wrap(actilife_id ~ ., labeller = labeller(actilife_id = id_replace)) +
  labs(title = "Supplemental Figure 4. Detected Sleep Onset to Offset by Source",
       x = "Time of Day (hours)",
       y = "Day",
       col = "") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(face = "bold", size = 10),
        facet_wrap) +
  scale_color_manual(values = c("#E69F00", "#56B4E9", "#999999")) +
  scale_x_continuous(breaks = seq(-10,24, by = 6), labels = c("14", "20", "2", "8", "14", "20"))
```

# Bland-Altman Plots
```{r}
fig_ears <- 
  df_analysis_wide3_RemOut %>%  
  filter(sample_1_flag == 1) %>% 
  ggplot(aes(x = sleep_period_start_onset_avg_diary_ears, y = sleep_onset_diff_min_diary_ears)) +
  geom_point(alpha = 0.6, size = 2, aes(col = actilife_id)) +
  geom_hline(yintercept = mean(df_analysis_wide3_RemOut$sleep_onset_diff_min_diary_ears, na.rm = TRUE), colour = "black", linewidth = 0.5) +
  geom_hline(yintercept = mean(df_analysis_wide3_RemOut$sleep_onset_diff_min_diary_ears, na.rm = TRUE) - (1.96 * sd(df_analysis_wide3_RemOut$sleep_onset_diff_min_diary_ears, na.rm = TRUE)), colour = "black", linewidth = 0.5, linetype = "dashed") +
  geom_hline(yintercept = mean(df_analysis_wide3_RemOut$sleep_onset_diff_min_diary_ears, na.rm = TRUE) + (1.96 * sd(df_analysis_wide3_RemOut$sleep_onset_diff_min_diary_ears, na.rm = TRUE)), colour = "black", linewidth = 0.5, linetype = "dashed") +
  labs(title = "EARS", y = "Difference between Diary and EARS Bedtime", x = "Average of Diary and EARS Bedtime") +
  expand_limits(x = c(-100, 200), y = c(-250, 250)) + 
  scale_x_continuous(breaks = seq(-100, 200, by = 100)) +
  scale_y_continuous(breaks = seq(-250, 250, by = 100)) +
  theme(legend.position = "none") +
  NULL

samp1 <- 
  df_analysis_wide3_RemOut %>%
  filter(sample_1_flag == 1)
samp2 <- 
  df_analysis_wide3_RemOut %>%
  filter(sample_2_flag == 1)

# Diary and EARS: Bedtime

ba_diaryears_onset <- 
  bland.altman.plot(samp1$sleep_period_start_onset_minutes_diary, samp1$sleep_period_start_onset_minutes_ears, graph.sys = "ggplot2", conf.int = .95)
ba_diaryears_onset$layers[[2]]$aes_params$colour <- c('red', 'gray', 'red')
ba_diaryears_onset + ggtitle("EARS compared to Diary Bedtime")
bland.altman.stats(samp1$sleep_period_start_onset_minutes_diary, samp1$sleep_period_start_onset_minutes_ears, two = 1.96, mode = 1, conf.int = 0.95)

# Diary and EARS: Rise Time
ba_diaryears_offset <- 
  bland.altman.plot(samp1$sleep_period_start_offset_minutes_diary, samp1$sleep_period_start_offset_minutes_ears, graph.sys = "ggplot2", conf.int = .95)
ba_diaryears_offset$layers[[2]]$aes_params$colour <- c('red', 'gray', 'red')
ba_diaryears_offset + ggtitle("EARS compared to Diary Rise Time")
bland.altman.stats(samp1$sleep_period_start_offset_minutes_diary, samp1$sleep_period_start_offset_minutes_ears, two = 1.96, mode = 1, conf.int = 0.95)


# Diary and EARS: TIme in Bed
ba_diaryears_dur <- 
  bland.altman.plot(samp1$sleep_duration_minutes_diary, samp1$sleep_duration_minutes_ears, graph.sys = "ggplot2", conf.int = .95)
ba_diaryears_dur$layers[[2]]$aes_params$colour <- c('red', 'gray', 'red')
ba_diaryears_dur + ggtitle("EARS compared to Diary Time in Bed")
bland.altman.stats(samp1$sleep_duration_minutes_diary, samp1$sleep_duration_minutes_ears, two = 1.96, mode = 1, conf.int = 0.95)

# Act and EARS: Bedtime

ba_actears_onset <- 
  bland.altman.plot(samp2$sleep_period_start_onset_minutes_actilife, samp2$sleep_period_start_onset_minutes_ears, graph.sys = "ggplot2", conf.int = .95)
ba_actears_onset$layers[[2]]$aes_params$colour <- c('red', 'gray', 'red')
ba_actears_onset + ggtitle("EARS compared to ActiGraph Bedtime")
bland.altman.stats(samp2$sleep_period_start_onset_minutes_actilife, samp2$sleep_period_start_onset_minutes_ears, two = 1.96, mode = 1, conf.int = 0.95)

# Act and EARS: Rise Time
ba_actears_offset <- 
  bland.altman.plot(samp2$sleep_period_start_offset_minutes_actilife, samp2$sleep_period_start_offset_minutes_ears, graph.sys = "ggplot2", conf.int = .95)
ba_actears_offset$layers[[2]]$aes_params$colour <- c('red', 'gray', 'red')
ba_actears_offset + ggtitle("EARS compared to ActiGraph Rise Time")
bland.altman.stats(samp2$sleep_period_start_offset_minutes_actilife, samp2$sleep_period_start_offset_minutes_ears, two = 1.96, mode = 1, conf.int = 0.95)


# Act and EARS: Time in Bed
ba_actears_dur <- 
  bland.altman.plot(samp2$sleep_duration_minutes_actilife, samp2$sleep_duration_minutes_ears, graph.sys = "ggplot2", conf.int = .95)
ba_actears_dur$layers[[2]]$aes_params$colour <- c('red', 'gray', 'red')
ba_actears_dur + ggtitle("EARS compared to ActiGraph Time in Bed")
bland.altman.stats(samp2$sleep_duration_minutes_actilife, samp2$sleep_duration_minutes_ears, two = 1.96, mode = 1, conf.int = 0.95)

(ba_diaryears_onset + ba_diaryears_offset + ba_diaryears_dur ) /
  (ba_actears_onset + ba_actears_offset + ba_actears_dur ) +
  plot_annotation(title = "",
                  caption = "", tag_levels = 'A')

```

### supplementary
```{r}
# _ bland altman ----

# _ _ sleep onset ----

# using MethodCompare
df_analysis_sleep_onset_wide_RO <- 
  df_analysis4_RemOut %>% 
  dplyr::select(actilife_id, sleep_offset_date, sleep_period_start_onset_minutes, source) %>% 
  tidyr::spread(source, sleep_period_start_onset_minutes) 

### First seeing whether two variances are equal in sleep onset using scale location plot and Breusch Pagan Test
sl_onset_de <- plot(lm(diary ~ ears, data = df_analysis_sleep_onset_wide_RO))
bp_onset_de <- bptest(lm(diary ~ ears, data = df_analysis_sleep_onset_wide_RO)) # variances are *not* equal between diary and ears sleep onset

sl_onset_ae <- plot(lm(actilife ~ ears, data = df_analysis_sleep_onset_wide_RO))
bp_onset_ae <- bptest(lm(actilife ~ ears, data = df_analysis_sleep_onset_wide_RO)) # variances are equal between actilife and ears sleep onset

# _ _ _ ears ----
df_methodcompare_RO <- measure_compare(df_analysis_sleep_onset_wide_RO, new = "ears", Ref = "diary", ID = "actilife_id")
bias_plot(df_methodcompare_RO) # best linear unbiased prediction (BLUP) is used in linear mixed models for the estimation of random effects
precision_plot(df_methodcompare_RO)
ba_ears_RO <- bland_altman_plot(df_analysis_sleep_onset_wide_RO, new = "ears", Ref = "diary", ID = "actilife_id", fill = FALSE)

# _ _ _ actilife ----
df_methodcompare_RO <- measure_compare(df_analysis_sleep_onset_wide_RO, new = "ears", Ref = "actilife", ID = "actilife_id")
bias_plot(df_methodcompare_RO) 
precision_plot(df_methodcompare_RO)
ba_actilife_RO <- bland_altman_plot(df_analysis_sleep_onset_wide_RO, new = "ears", Ref = "actilife", ID = "actilife_id", fill = FALSE)

#### using rmba ####
source("rmba.R")
rmba_res <-
  rmba(
    data = df_analysis_sleep_onset_wide_RO,
    measure_one_col = "diary",
    measure_two_col = "ears",
    id_col = "actilife_id",
    bootstrap = TRUE,
    B = 1000,
    seed = 123
    )

# _ _ sleep offset ----

# using MethodCompare
df_analysis_sleep_offset_wide_RO <- 
  df_analysis4_RemOut %>% 
  dplyr::select(actilife_id, sleep_offset_date, sleep_period_start_offset_minutes, source) %>% 
  tidyr::spread(source, sleep_period_start_offset_minutes)

### First seeing whether two variances are equal in sleep onset using scale location plot and Breusch Pagan Test
sl_offset_de <- plot(lm(diary ~ ears, data = df_analysis_sleep_offset_wide_RO))
bp_offset_de <- bptest(lm(diary ~ ears, data = df_analysis_sleep_offset_wide_RO)) # variances are equal between diary and ears sleep offset

sl_offset_ae <- plot(lm(actilife ~ ears, data = df_analysis_sleep_offset_wide_RO))
bp_offset_ae <- bptest(lm(actilife ~ ears, data = df_analysis_sleep_offset_wide_RO)) # variances are equal between actilife and ears sleep offset

# _ _ _ ears ----
df_methodcompare_RO <- measure_compare(df_analysis_sleep_offset_wide_RO, new = "ears", Ref = "diary", ID = "actilife_id" )
bias_plot(df_methodcompare_RO) 
precision_plot(df_methodcompare_RO)
ba_ears_RO <- bland_altman_plot(df_analysis_sleep_offset_wide_RO, new = "ears", Ref = "diary", ID = "actilife_id", fill = FALSE)

# _ _ _ actilife ----
df_methodcompare_RO <- measure_compare(df_analysis_sleep_offset_wide_RO, new = "actilife", Ref = "diary", ID = "actilife_id" )
bias_plot(df_methodcompare_RO) 
precision_plot(df_methodcompare_RO)
ba_actilife_RO <- bland_altman_plot(df_analysis_sleep_offset_wide_RO, new = "ears", Ref = "actilife", ID = "actilife_id", fill = FALSE)


# _ _ sleep duration ----
# using MethodCompare
df_analysis_sleep_duration_wide_RO <- 
  df_analysis4_RemOut %>% 
  dplyr::select(actilife_id, sleep_offset_date, sleep_duration_minutes, source) %>% 
  tidyr::spread(source, sleep_duration_minutes)

### First seeing whether two variances are equal in sleep onset using scale location plot and Breusch Pagan Test
sl_dur_de <- plot(lm(diary ~ ears, data = df_analysis_sleep_duration_wide_RO))
bp_dur_de <- bptest(lm(diary ~ ears, data = df_analysis_sleep_duration_wide_RO)) # variances are equal between diary and ears sleep duration

sl_dur_ae <- plot(lm(actilife ~ ears, data = df_analysis_sleep_duration_wide_RO))
bp_dur_ae <- bptest(lm(actilife ~ ears, data = df_analysis_sleep_duration_wide_RO)) # variances are equal between actilife and ears sleep duration

df_methodcompare_RO <- measure_compare(df_analysis_sleep_duration_wide_RO, new = "ears", Ref = "diary", ID = "actilife_id")
bias_plot(df_methodcompare_RO) 
precision_plot(df_methodcompare_RO)
ba_ears_RO <- bland_altman_plot(df_analysis_sleep_duration_wide_RO, new = "ears", Ref = "diary", ID = "actilife_id", fill = FALSE)

df_methodcompare_RO <- measure_compare(df_analysis_sleep_duration_wide_RO, new = "actilife", Ref = "diary", ID = "actilife_id")
bias_plot(df_methodcompare_RO) 
precision_plot(df_methodcompare_RO)
ba_actilife_RO <- bland_altman_plot(df_analysis_sleep_duration_wide_RO, new = "ears", Ref = "actilife", ID = "actilife_id", fill = FALSE)

```
