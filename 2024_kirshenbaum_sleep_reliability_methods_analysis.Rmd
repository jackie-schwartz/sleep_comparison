---
title: "Comparison of Sleep Features across Mobile Sensors, Diaries, and Actigraphy in Young Adults"
author:
- name: Jaclyn S. Kirshenbaum
  affiliation: '1,2'
  corresponding: true
  address: 1051 Riverside Drive, 2313 Pardes New York, NY 10032
  email: Jaclyn.Kirshenbaum@nyspi.columbia.edu
  role:
  - "Analysis"
  - "Writing - Original Draft Preparation"
  - "Writing - Review & Editing"
- name: Ryann Crowley
  affiliation: '3'
  role: Original code and Analysis
- name: David Pagliaccio
  affiliation: '1,2'
  role: "Writing - Review & Editing"
- name: Nicholas B. Allen
  affiliation: '3'
  role:
  - Conceptualization
  - Funding
- name: Randy P. Auerbach
  affiliation: '1,2'
  role: "Writing - Review & Editing"
shorttitle: Sleep Reliability
output:
  papaja::apa6_pdf:
    latex_engine: lualatex
  html_document:
    df_print: paged
  word_document: null
  html_notebook: null
keywords: sleep, wearables, smartphones, accelerometer, reliability
wordcount: X
bibliography: "r-references.bib"
floatsintext: true
linenumbers: false
draft: false
mask: false
figurelist: false
tablelist: false
footnotelist: false
classoption: doc
affiliation:
- id: '1'
  institution: Department of Psychiatry, Columbia University, New York, NY
- id: '2'
  institution: Division of Child and Adolescent Psychiatry, New York State Psychiatric
    Institute, New York, NY
- id: '3'
  institution: Oregon Research Institute, Eugene, Oregon
editor_options:
  chunk_output_type: console
---

# Setup

```{r setup}
library("papaja")
library("kableExtra")
library("verification")
r_refs("r-references.bib")
```

```{r analysis-preferences}
# Seed for random number generation
set.seed(42)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed)
```

## Participants
From my analysis:
29 University students provided smartphone accelerometer and self-reported diary data for one week. 13 participants provided concurrent actigraphy data
## Procedure
The current study analyzed data from the baseline week of a 4-week micro-randomized trial, as described in (Latham, 2020). At the consent session, the Effortless Assessment of Research Systems (EARS) phone application was installed on participants’ phones. The EARS app was developed by the Adolescent Development and Psychopathology Team (ADAPT) at the University of Oregon to passively collect data with minimal burden to participants (Lind et al., 2018).
## Data analysis
For all analyses, Diary data were considered “ground truth” given a) all participants were administered daily diaries, b) the questions were derived from validated measures, and c) diaries are more commonly used relative to the ActiGraph wearable and EARS smartphone application. However, we also repeat analyses with ActiGraph as the reference measurement given this wearable uses accelerometry. 

We used `r cite_r("r-references.bib")` for all our analyses.

## Libraries, color palatte, and functions

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(readr)
library(stringr)
library(lubridate)
library(data.table)
library(skimr)
library(patchwork)
library(MethodCompare)
library(DescTools)

library(lme4)
library(lmerTest)
library(knitr)
library(janitor)
library(scipub)
library(lmtest)
library(rmcorr)
library(rempsyc)
library(BlandAltmanLeh)
library(ggExtra)

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7") 
theme_set(theme_bw())
# Simple function for computing ICC from lme() output
ICClme <- function(out) {
  varests <- as.numeric(VarCorr(out)[1:2])
  return(paste("ICC =", varests[1] / sum(varests)))
}

mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

theme_set(theme_bw(base_size = 12,base_family = "Arial")); theme_update(panel.grid.minor = element_line(linetype = "solid",linewidth =.5),axis.title.x = element_text(face = "bold"),axis.title.y = element_text(face = "bold"), plot.title = element_text(face = "bold"))
```


# Reading in files

```{r}
load("~/Dropbox/Postdoc/15_Sleep_metrics_reliability/sleep_comparison/reliability_October 12024.Rda")

## Reading in files

df_sleep_actilife_path  <- "~/Dropbox/Postdoc/15_Sleep_metrics_reliability/BatchSleepExportDetails(2020-03-03_14-13-01).csv"
df_sleep_diary_path <- "~/Dropbox/Postdoc/15_Sleep_metrics_reliability/sleep_diary.csv"
df_sleep_ears_path <- "~/Dropbox/Postdoc/15_Sleep_metrics_reliability/sleep_detection_final.csv"
df_ears_acc_10sec_path <- "~/Dropbox/Postdoc/15_Sleep_metrics_reliability/acc_second10_df.csv"
```

# Analysis

## Observations

> Assessing the number of observations per source, particularly when removing outliers

```{r, echo=FALSE,message=FALSE,warning=FALSE}
# Observations per Source
df_analysis4 %>% 
  ggplot(aes(day_num, fill = source)) + 
  geom_histogram(position = "dodge", binwidth = 1, col = "white") +
  facet_grid(source ~ .) +
  theme_minimal() +
  scale_fill_manual(values = cbPalette) +
  scale_x_continuous(breaks = seq(0,10, by = 1)) +
  labs(title = "Number of Observations per Day",
       x = "Day",
       fill = "",
       caption = "") +
  theme(legend.position = "none")


# Observations per Source (RemOut)
df_analysis4_RemOut %>% 
  ggplot(aes(day_num, fill = source)) + 
  geom_histogram(position = "dodge", binwidth = 1, col = "white") +
  facet_grid(source ~ .) +
  theme_minimal() +
  scale_fill_manual(values = cbPalette) +
  scale_x_continuous(breaks = seq(0,10, by = 1)) +
  labs(title = "Number of Observations per Day",
       x = "Day",
       fill = "",
       caption = "") +
  theme(legend.position = "none")

source_nums <-
  df_analysis4 %>%
  drop_na(source_combination) %>%
  dplyr::group_by(source) %>%
  dplyr::summarise(
    n = n()
  )

source_nums_RemOut <-
  df_analysis4_RemOut %>%
  drop_na(source_combination) %>%  
  dplyr::group_by(source) %>%
  dplyr::summarise(
    n = n()
  )

# Observations per Source Combination
df_analysis4 %>% 
  ggplot(aes(day_num, fill = source_combination)) + 
  geom_histogram(position = "dodge", binwidth = 1, col = "white") +
  facet_grid(source_combination ~ .) +
  theme_minimal() +
  scale_fill_manual(values = cbPalette) +
  scale_x_continuous(breaks = seq(0,10, by = 1)) +
  labs(title = "Number of Observations per Day",
       x = "Day",
       fill = "",
       caption = "") +
  theme(legend.position = "none")


df_analysis4_RemOut %>% 
  drop_na(source_combination) %>% # droping the two participants with *only* diary data
  ggplot(aes(day_num, fill = source_combination)) + 
  geom_histogram(position = "dodge", binwidth = 1, col = "white") +
  facet_grid(source_combination ~ .) +
  theme_minimal() +
  scale_fill_manual(values = cbPalette) +
  scale_x_continuous(breaks = seq(0,10, by = 1)) +
  labs(title = "Number of Observations per Day",
       x = "Day",
       fill = "",
       caption = "") +
  theme(legend.position = "none")


source_nums_comb_RemOut <- 
  df_analysis4_RemOut %>%
  drop_na(source_combination) %>%
  dplyr::group_by(source_combination) %>%
  dplyr::summarise(
    n = n()
  )

source_nums_comb <- 
  df_analysis4 %>%
  drop_na(source_combination) %>%
  dplyr::group_by(source_combination) %>%
  dplyr::summarise(
    n = n()
  )

df_analysis4_RemOut %>%
  drop_na(source_combination) %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::summarise(
    n = n()
  )


df_analysis_wide3_RemOut %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::summarise(
    n = n()
  )
```

> Considering the sources of data separately, there are `r source_nums$n[1]` observations of ActiGraph, `r source_nums$n[2]` observations of Diary, and `r source_nums$n[3]` observations of EARS data. In combination, there are `r source_nums_comb$n[1]` observations of Diary and ActiGraph data, `r source_nums_comb$n[2]` observations of Diary and EARS data, and `r source_nums_comb$n[3]` observations of Diary, EARS, and ActiGraph data.  With the removal of outliers and the two participant with only Diary data (_n_=13 observations), there are `r source_nums_RemOut$n[1]` observations of actilife, `r source_nums_RemOut$n[2]` observations of Diary, and `r source_nums_RemOut$n[3]` observations of EARS data. In combination, there are `r source_nums_comb_RemOut$n[1]` observations of Diary and ActiGraph data, `r source_nums_comb_RemOut$n[2]` observations of Diary and EARS data, and `r source_nums_comb_RemOut$n[3]` observations of Diary, EARS, and ActiGraph data. 

> Only using the "RemOut" dataframes moving forward removing the observations with Diary-only data

## Summary of Bedtime, Rise Time, and Time in Bed

```{r, echo=FALSE, message=FALSE, warning=FALSE, attr.output=FALSE}
# EARS, Diary, ActiGraph descriptives of onset, offset, and duration
table_descriptives_RemOut <- 
  df_analysis_wide3_RemOut %>%
  dplyr::ungroup() %>%
  dplyr::summarise(
    Bedtime_Mean_Minutes_from_Midnight_EARS = round(mean(bedtime_start_onset_minutes_ears, na.rm = TRUE),2),
    Bedtime_Med_Minutes_from_Midnight_EARS = round(median(bedtime_start_onset_minutes_ears, na.rm = TRUE),2),
    Bedtime_SD_Minutes_from_Midnight_EARS = round(sd(bedtime_start_onset_minutes_ears, na.rm = TRUE),2),
    Bedtime_Min_Minutes_from_Midnight_EARS = round(min(bedtime_start_onset_minutes_ears, na.rm = TRUE),2),
    Bedtime_Max_Minutes_from_Midnight_EARS = round(max(bedtime_start_onset_minutes_ears, na.rm = TRUE),2),  
    Risetime_Mean_Minutes_from_Midnight_EARS = round(mean(risetime_start_offset_minutes_ears, na.rm = TRUE),2),
    Risetime_Med_Minutes_from_Midnight_EARS = round(median(risetime_start_offset_minutes_ears, na.rm = TRUE),2),
    Risetime_SD_Minutes_from_Midnight_EARS = round(sd(risetime_start_offset_minutes_ears, na.rm = TRUE),2),
    Risetime_Min_Minutes_from_Midnight_EARS = round(min(risetime_start_offset_minutes_ears, na.rm = TRUE),2),
    Risetime_Max_Minutes_from_Midnight_EARS = round(max(risetime_start_offset_minutes_ears, na.rm = TRUE),2),
    TIB_Mean_Minutes_EARS = round(mean(time_in_bed_minutes_ears, na.rm = TRUE),2),
    TIB_Med_Minutes_EARS = round(median(time_in_bed_minutes_ears, na.rm = TRUE),2),
    TIB_SD_Minutes_EARS = round(sd(time_in_bed_minutes_ears, na.rm = TRUE),2),
    TIB_Min_Minutes_EARS = round(min(time_in_bed_minutes_ears, na.rm = TRUE),2),
    TIB_Max_Minutes_EARS = round(max(time_in_bed_minutes_ears, na.rm = TRUE),2),
    
    Bedtime_Mean_Minutes_from_Midnight_ACT = round(mean(bedtime_start_onset_minutes_actilife, na.rm = TRUE),2),
    Bedtime_Med_Minutes_from_Midnight_ACT = round(median(bedtime_start_onset_minutes_actilife, na.rm = TRUE),2),
    Bedtime_SD_Minutes_from_Midnight_ACT = round(sd(bedtime_start_onset_minutes_actilife, na.rm = TRUE),2),
    Bedtime_Min_Minutes_from_Midnight_ACT = round(min(bedtime_start_onset_minutes_actilife, na.rm = TRUE),2),
    Bedtime_Max_Minutes_from_Midnight_ACT = round(max(bedtime_start_onset_minutes_actilife, na.rm = TRUE),2),  
    Risetime_Mean_Minutes_from_Midnight_ACT = round(mean(risetime_start_offset_minutes_actilife, na.rm = TRUE),2),
    Risetime_Med_Minutes_from_Midnight_ACT = round(median(risetime_start_offset_minutes_actilife, na.rm = TRUE),2),
    Risetime_SD_Minutes_from_Midnight_ACT = round(sd(risetime_start_offset_minutes_actilife, na.rm = TRUE),2),
    Risetime_Min_Minutes_from_Midnight_ACT = round(min(risetime_start_offset_minutes_actilife, na.rm = TRUE),2),
    Risetime_Max_Minutes_from_Midnight_ACT = round(max(risetime_start_offset_minutes_actilife, na.rm = TRUE),2),
    TIB_Mean_Minutes_ACT = round(mean(time_in_bed_minutes_actilife, na.rm = TRUE),2),
    TIB_Med_Minutes_ACT = round(median(time_in_bed_minutes_actilife, na.rm = TRUE),2),
    TIB_SD_Minutes_ACT = round(sd(time_in_bed_minutes_actilife, na.rm = TRUE),2),
    TIB_Min_Minutes_ACT = round(min(time_in_bed_minutes_actilife, na.rm = TRUE),2),
    TIB_Max_Minutes_ACT = round(max(time_in_bed_minutes_actilife, na.rm = TRUE),2),
    
    Bedtime_Mean_Minutes_from_Midnight_DIARY = round(mean(bedtime_start_onset_minutes_diary, na.rm = TRUE),2),
    Bedtime_Med_Minutes_from_Midnight_DIARY = round(median(bedtime_start_onset_minutes_diary, na.rm = TRUE),2),
    Bedtime_SD_Minutes_from_Midnight_DIARY = round(sd(bedtime_start_onset_minutes_diary, na.rm = TRUE),2),
    Bedtime_Min_Minutes_from_Midnight_DIARY = round(min(bedtime_start_onset_minutes_diary, na.rm = TRUE),2),
    Bedtime_Max_Minutes_from_Midnight_DIARY = round(max(bedtime_start_onset_minutes_diary, na.rm = TRUE),2),  
    Risetime_Mean_Minutes_from_Midnight_DIARY = round(mean(risetime_start_offset_minutes_diary, na.rm = TRUE),2),
    Risetime_Med_Minutes_from_Midnight_DIARY = round(median(risetime_start_offset_minutes_diary, na.rm = TRUE),2),
    Risetime_SD_Minutes_from_Midnight_DIARY = round(sd(risetime_start_offset_minutes_diary, na.rm = TRUE),2),
    Risetime_Min_Minutes_from_Midnight_DIARY = round(min(risetime_start_offset_minutes_diary, na.rm = TRUE),2),
    Risetime_Max_Minutes_from_Midnight_DIARY = round(max(risetime_start_offset_minutes_diary, na.rm = TRUE),2),
    TIB_Mean_Minutes_DIARY = round(mean(time_in_bed_minutes_diary, na.rm = TRUE),2),
    TIB_Med_Minutes_DIARY = round(median(time_in_bed_minutes_diary, na.rm = TRUE),2),
    TIB_SD_Minutes_DIARY = round(sd(time_in_bed_minutes_diary, na.rm = TRUE),2),
    TIB_Min_Minutes_DIARY = round(min(time_in_bed_minutes_diary, na.rm = TRUE),2),
    TIB_Max_Minutes_DIARY = round(max(time_in_bed_minutes_diary, na.rm = TRUE),2),
    
    Sleep_Onset_Mean_Minutes_from_Midnight_DIARY = round(mean(sleep_period_start_onset_minutes_diary, na.rm = TRUE),2),
    Sleep_Onset_Med_Minutes_from_Midnight_DIARY = round(median(sleep_period_start_onset_minutes_diary, na.rm = TRUE),2),
    Sleep_Onset_SD_Minutes_from_Midnight_DIARY = round(sd(sleep_period_start_onset_minutes_diary, na.rm = TRUE),2),
    Sleep_Onset_Min_Minutes_from_Midnight_DIARY = round(min(sleep_period_start_onset_minutes_diary, na.rm = TRUE),2),
    Sleep_Onset_Max_Minutes_from_Midnight_DIARY = round(max(sleep_period_start_onset_minutes_diary, na.rm = TRUE),2),  
    Sleep_Offset_Mean_Minutes_from_Midnight_DIARY = round(mean(sleep_period_start_offset_minutes_diary, na.rm = TRUE),2),
    Sleep_Offset_Med_Minutes_from_Midnight_DIARY = round(median(sleep_period_start_offset_minutes_diary, na.rm = TRUE),2),
    Sleep_Offset_SD_Minutes_from_Midnight_DIARY = round(sd(sleep_period_start_offset_minutes_diary, na.rm = TRUE),2),
    Sleep_Offset_Min_Minutes_from_Midnight_DIARY = round(min(sleep_period_start_offset_minutes_diary, na.rm = TRUE),2),
    Sleep_Offset_Max_Minutes_from_Midnight_DIARY = round(max(sleep_period_start_offset_minutes_diary, na.rm = TRUE),2),
    Sleep_Duration_Mean_Minutes_DIARY = round(mean(sleep_duration_minutes_diary, na.rm = TRUE),2),
    Sleep_Duration_Med_Minutes_DIARY = round(median(sleep_duration_minutes_diary, na.rm = TRUE),2),
    Sleep_Duration_SD_Minutes_DIARY = round(sd(sleep_duration_minutes_diary, na.rm = TRUE),2),
    Sleep_Duration_Min_Minutes_DIARY = round(min(sleep_duration_minutes_diary, na.rm = TRUE),2),
    Sleep_Duration_Max_Minutes_DIARY = round(max(sleep_duration_minutes_diary, na.rm = TRUE),2)    
    )

```

#### Supplement: Distributions ####

### Diary & EARS
```{r, echo=FALSE}
# Bedtime
bedtime_diff_min_diary_ears_df <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>% 
  dplyr::group_by(actilife_id) %>% 
  dplyr::summarise(
    bedtime_diff_min_diary_ears_mean = mean(bedtime_diff_min_diary_ears)
    )
mean(df_analysis_wide3_RemOut$bedtime_diff_min_diary_ears, na.rm=TRUE)
sd(df_analysis_wide3_RemOut$bedtime_diff_min_diary_ears, na.rm=TRUE)

fig_bedtime_ears <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>% 
  ggplot() +
  geom_density(aes(bedtime_diff_min_diary_ears), col = "black") +
  geom_vline(data = bedtime_diff_min_diary_ears_df, aes(xintercept=bedtime_diff_min_diary_ears_mean, color = actilife_id), linewidth = .5, linetype = "dashed") +
  geom_vline(aes(xintercept = mean(bedtime_diff_min_diary_ears, na.rm=TRUE)), linewidth =1) +
  geom_label(aes(x=mean(bedtime_diff_min_diary_ears, na.rm=TRUE), label=paste("mean = ", round(mean(bedtime_diff_min_diary_ears, na.rm=TRUE),1)), y = 0.008)) +
  labs(title = "Diary Bedtime - EARS Bedtime",
       x = "Difference in Bedtime (minutes)",
       y = "",
       color = "") +
  theme_classic()  +
  theme(legend.position="none")
fig_bedtime_ears

# Risetime
risetime_diff_min_diary_ears_df <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>% 
  dplyr::group_by(actilife_id) %>% 
  dplyr::summarise(
    risetime_diff_min_diary_ears_mean = mean(risetime_diff_min_diary_ears)
    )
mean(df_analysis_wide3_RemOut$risetime_diff_min_diary_ears, na.rm=TRUE)
sd(df_analysis_wide3_RemOut$risetime_diff_min_diary_ears, na.rm=TRUE)

fig_risetime_ears <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>% 
  ggplot() +
  geom_density(aes(risetime_diff_min_diary_ears), col = "black") +
  geom_vline(data = risetime_diff_min_diary_ears_df, aes(xintercept=risetime_diff_min_diary_ears_mean, color = actilife_id), linewidth = .5, linetype = "dashed") +
  geom_vline(aes(xintercept = mean(risetime_diff_min_diary_ears, na.rm=TRUE)), linewidth =1) +
  geom_label(aes(x=mean(risetime_diff_min_diary_ears, na.rm=TRUE), label=paste("mean = ", round(mean(risetime_diff_min_diary_ears, na.rm=TRUE),1)), y = 0.008)) +
  labs(title = "Diary Rise Time - EARS Rise Time",
       x = "Difference in Rise Time (minutes)",
       y = "") +
  theme_classic()  +
  theme(legend.position="none")
fig_risetime_ears


# Time in Bed
tib_diff_min_diary_ears_df <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>% 
  dplyr::group_by(actilife_id) %>% 
  dplyr::summarise(
    time_in_bed_minutes_diff_min_diary_ears_mean = mean(time_in_bed_minutes_diff_min_diary_ears)
    )
mean(df_analysis_wide3_RemOut$time_in_bed_minutes_diff_min_diary_ears, na.rm=TRUE)
sd(df_analysis_wide3_RemOut$time_in_bed_minutes_diff_min_diary_ears, na.rm=TRUE)

fig_tib_ears <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>% 
  ggplot() +
  geom_density(aes(time_in_bed_minutes_diff_min_diary_ears), col = "black") +
  geom_vline(data = tib_diff_min_diary_ears_df, aes(xintercept=time_in_bed_minutes_diff_min_diary_ears_mean, color = actilife_id), linewidth = .5, linetype = "dashed") +
  geom_vline(aes(xintercept = mean(time_in_bed_minutes_diff_min_diary_ears, na.rm=TRUE)), linewidth =1) +
  geom_label(aes(x=mean(time_in_bed_minutes_diff_min_diary_ears, na.rm=TRUE), label=paste("mean = ", round(mean(time_in_bed_minutes_diff_min_diary_ears, na.rm=TRUE),1)), y = 0.004)) +
  labs(title = "Diary Time in Bed - EARS Time in Bed",
       x = "Difference in Time in Bed (minutes)",
       y = "") +
  theme_classic()  +
  theme(legend.position="none")
fig_tib_ears


(fig_bedtime_ears ) /
  (fig_risetime_ears) /
  (fig_tib_ears) +
  plot_annotation(title = "",
                  caption = "", tag_levels = 'A')
ggsave("SupplementalFig2.jpeg", width = 7, height = 8)

###########################
# Onset
sleep_onset_bedtime_diff_min_diary_ears_df <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>% 
  dplyr::group_by(actilife_id) %>% 
  dplyr::summarise(
    sleep_onset_bedtime_diff_min_diary_ears_mean = mean(sleep_onset_bedtime_diff_min_diary_ears)
    )
mean(df_analysis_wide3_RemOut$sleep_onset_bedtime_diff_min_diary_ears, na.rm=TRUE)
sd(df_analysis_wide3_RemOut$sleep_onset_bedtime_diff_min_diary_ears, na.rm=TRUE)

fig_onset_ears <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>% 
  ggplot() +
  geom_density(aes(sleep_onset_bedtime_diff_min_diary_ears), col = "black") +
  geom_vline(data = sleep_onset_bedtime_diff_min_diary_ears_df, aes(xintercept=sleep_onset_bedtime_diff_min_diary_ears_mean, color = actilife_id), linewidth = .5, linetype = "dashed") +
  geom_vline(aes(xintercept = mean(sleep_onset_bedtime_diff_min_diary_ears, na.rm=TRUE)), linewidth =1) +
  geom_label(aes(x=mean(sleep_onset_bedtime_diff_min_diary_ears, na.rm=TRUE), label=paste("mean = ", round(mean(sleep_onset_bedtime_diff_min_diary_ears, na.rm=TRUE),1)), y = 0.008)) +
  labs(title = "Diary Sleep Onset - EARS Bedtime",
       x = "Difference in Sleep Onset and Bedtime (minutes)",
       y = "",
       color = "") +
  theme_classic()  +
  theme(legend.position="none")
fig_onset_ears

# Offset
sleep_offset_risetime_diff_min_diary_ears_df <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>% 
  dplyr::group_by(actilife_id) %>% 
  dplyr::summarise(
    sleep_offset_risetime_diff_min_diary_ears_mean = mean(sleep_offset_risetime_diff_min_diary_ears)
    )
mean(df_analysis_wide3_RemOut$sleep_offset_risetime_diff_min_diary_ears, na.rm=TRUE)
sd(df_analysis_wide3_RemOut$sleep_offset_risetime_diff_min_diary_ears, na.rm=TRUE)

fig_offset_ears <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>% 
  ggplot() +
  geom_density(aes(sleep_offset_risetime_diff_min_diary_ears), col = "black") +
  geom_vline(data = sleep_offset_risetime_diff_min_diary_ears_df, aes(xintercept=sleep_offset_risetime_diff_min_diary_ears_mean, color = actilife_id), linewidth = .5, linetype = "dashed") +
  geom_vline(aes(xintercept = mean(sleep_offset_risetime_diff_min_diary_ears, na.rm=TRUE)), linewidth =1) +
  geom_label(aes(x=mean(sleep_offset_risetime_diff_min_diary_ears, na.rm=TRUE), label=paste("mean = ", round(mean(sleep_offset_risetime_diff_min_diary_ears, na.rm=TRUE),1)), y = 0.008)) +
  labs(title = "Diary Sleep Offset - EARS Rise Time",
       x = "Difference in Sleep Offset and Rise Time (minutes)",
       y = "") +
  theme_classic()  +
  theme(legend.position="none")
fig_offset_ears


# Duration
sleep_dur_time_in_bed_minutes_diff_min_diary_ears_df <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>% 
  dplyr::group_by(actilife_id) %>% 
  dplyr::summarise(
    sleep_dur_time_in_bed_minutes_diff_min_diary_ears_mean = mean(sleep_dur_time_in_bed_minutes_diff_min_diary_ears)
    )
mean(df_analysis_wide3_RemOut$sleep_dur_time_in_bed_minutes_diff_min_diary_ears, na.rm=TRUE)
sd(df_analysis_wide3_RemOut$sleep_dur_time_in_bed_minutes_diff_min_diary_ears, na.rm=TRUE)

fig_dur_ears <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>% 
  ggplot() +
  geom_density(aes(sleep_dur_time_in_bed_minutes_diff_min_diary_ears), col = "black") +
  geom_vline(data = sleep_dur_time_in_bed_minutes_diff_min_diary_ears_df, aes(xintercept=sleep_dur_time_in_bed_minutes_diff_min_diary_ears_mean, color = actilife_id), linewidth = .5, linetype = "dashed") +
  geom_vline(aes(xintercept = mean(sleep_dur_time_in_bed_minutes_diff_min_diary_ears, na.rm=TRUE)), linewidth =1) +
  geom_label(aes(x=mean(sleep_dur_time_in_bed_minutes_diff_min_diary_ears, na.rm=TRUE), label=paste("mean = ", round(mean(sleep_dur_time_in_bed_minutes_diff_min_diary_ears, na.rm=TRUE),1)), y = 0.004)) +
  labs(title = "Diary Sleep Duration - EARS Time in Bed",
       x = "Difference in Sleep Duration and Time in Bed (minutes)",
       y = "") +
  theme_classic()  +
  theme(legend.position="none")
fig_dur_ears


(fig_onset_ears ) /
  (fig_offset_ears) /
  (fig_dur_ears) +
  plot_annotation(title = "",
                  caption = "", tag_levels = 'A')
ggsave("SupplementalFig4.jpeg", width = 7, height = 8)
```

### Actilife & EARS
```{r, echo=FALSE}

# Bedtime
bedtime_diff_min_act_ears_df <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_2_flag == 1) %>% 
  dplyr::group_by(actilife_id) %>% 
  dplyr::summarise(
    bedtime_diff_min_actilife_ears_mean = mean(bedtime_diff_min_actilife_ears, na.rm = TRUE)
    )
mean(df_analysis_wide3_RemOut$bedtime_diff_min_actilife_ears, na.rm=TRUE)
sd(df_analysis_wide3_RemOut$bedtime_diff_min_actilife_ears, na.rm=TRUE)

fig_bedtime_ears_act <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_2_flag == 1) %>% 
  ggplot() +
  geom_density(aes(bedtime_diff_min_actilife_ears), col = "black") +
  geom_vline(data = bedtime_diff_min_act_ears_df, aes(xintercept=bedtime_diff_min_actilife_ears_mean, color = actilife_id), linewidth = .5, linetype = "dashed") +
  geom_vline(aes(xintercept = mean(bedtime_diff_min_actilife_ears, na.rm=TRUE)), linewidth =1) +
  geom_label(aes(x=mean(bedtime_diff_min_actilife_ears, na.rm=TRUE), label=paste("mean = ", round(mean(bedtime_diff_min_actilife_ears, na.rm=TRUE),1)), y = 0.009)) +
  labs(title = "ActiGraph Bedtime - EARS Bedtime",
       x = "Difference in Bedtime (minutes)",
       y = "")  +
  theme_classic()  +
  theme(legend.position="none")
fig_bedtime_ears_act

# Risetime
risetime_diff_min_act_ear_df <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_2_flag == 1) %>% 
  dplyr::group_by(actilife_id) %>% 
  dplyr::summarise(
    risetime_diff_min_actilife_ears_mean = mean(risetime_diff_min_actilife_ears, na.rm=TRUE)
    )
mean(df_analysis_wide3_RemOut$risetime_diff_min_actilife_ears, na.rm=TRUE)
sd(df_analysis_wide3_RemOut$risetime_diff_min_actilife_ears, na.rm=TRUE)

fig_risetime_ears_act <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_2_flag == 1) %>% 
  ggplot() +
  geom_density(aes(risetime_diff_min_actilife_ears), col = "black") +
  geom_vline(data = risetime_diff_min_act_ear_df, aes(xintercept=risetime_diff_min_actilife_ears_mean, color = actilife_id), linewidth = .5, linetype = "dashed") +
  geom_vline(aes(xintercept = mean(risetime_diff_min_actilife_ears, na.rm=TRUE)), linewidth =1) +
  geom_label(aes(x=mean(risetime_diff_min_actilife_ears, na.rm=TRUE), label=paste("mean = ", round(mean(risetime_diff_min_actilife_ears, na.rm=TRUE),1)), y = 0.004)) +
  labs(title = "ActiGraph Rise Time - EARS Rise Time",
       x = "Difference in Rise Time (minutes)",
       y = "")  +
  theme_classic()  +
  theme(legend.position="none")
fig_risetime_ears_act



# Time in Bed
tib_diff_min_act_ears_df <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_2_flag == 1) %>% 
  dplyr::group_by(actilife_id) %>% 
  dplyr::summarise(
    time_in_bed_minutes_diff_min_actilife_ears_mean = mean(time_in_bed_minutes_diff_min_actilife_ears, na.rm = TRUE)
    )
mean(df_analysis_wide3_RemOut$time_in_bed_minutes_diff_min_actilife_ears, na.rm=TRUE)
sd(df_analysis_wide3_RemOut$time_in_bed_minutes_diff_min_actilife_ears, na.rm=TRUE)

fig_tib_ears_act <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_2_flag == 1) %>% 
  ggplot() +
  geom_density(aes(time_in_bed_minutes_diff_min_actilife_ears), col = "black") +
  geom_vline(data = tib_diff_min_act_ears_df, aes(xintercept=time_in_bed_minutes_diff_min_actilife_ears_mean, color = actilife_id), linewidth = .5, linetype = "dashed") +
  geom_vline(aes(xintercept = mean(time_in_bed_minutes_diff_min_actilife_ears, na.rm=TRUE)), linewidth =1) +
  geom_label(aes(x=mean(time_in_bed_minutes_diff_min_actilife_ears, na.rm=TRUE), label=paste("mean = ", round(mean(time_in_bed_minutes_diff_min_actilife_ears, na.rm=TRUE),1)), y = 0.003)) +
  labs(title = "ActiGraph Time in Bed - EARS Time in Bed",
       x = "Difference in Time in Bed (minutes)",
       y = "")  +
  theme_classic()  +
  theme(legend.position="none")
fig_tib_ears_act

(fig_bedtime_ears_act ) /
  (fig_risetime_ears_act) /
  (fig_tib_ears_act) +
  plot_annotation(title = "",
                  caption = "", tag_levels = 'A')
ggsave("SupplementalFig3.jpeg", width = 7, height = 8)
```

# Comparing average bedtimes, rise times, and time in bed among sources

```{r}

#  ---- onset/offset distribution ----

num_obs_per_participant <-
  df_analysis4_RemOut %>%
  filter(sample_1_flag == 1) %>%
  dplyr::group_by(actilife_id, source) %>%
  dplyr::summarise(n=n()) 

# AVERAGE BEDTIME, RISE TIME, TIME IN BED

mean_times_ears <-
  df_analysis4_RemOut %>%
  filter(sample_1_flag == 1) %>%
  dplyr::group_by(actilife_id, source) %>%
  dplyr::summarise(
    mean_bedtime = mean(bedtime_start_onset_minutes, na.rm=TRUE),
    mean_risetime = mean(risetime_start_offset_minutes, na.rm=TRUE),
    mean_tib = mean(time_in_bed_minutes, na.rm=TRUE)
  ) %>%
  dplyr::ungroup() %>%
  dplyr::mutate_if(
    is.character, as.factor
  ) %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::mutate(
    n_sources = n()
  ) %>%
  filter(
    n_sources > 1,
    source !="actilife"
  ) 

mean_times_act <-
  df_analysis4_RemOut %>%
  filter(sample_2_flag == 1) %>%
  dplyr::group_by(actilife_id, source) %>%
  dplyr::summarise(
    mean_bedtime = mean(bedtime_start_onset_minutes, na.rm=TRUE),
    mean_risetime = mean(risetime_start_offset_minutes, na.rm=TRUE),
    mean_tib = mean(time_in_bed_minutes, na.rm=TRUE)
  ) %>%
  dplyr::ungroup() %>%
  dplyr::mutate_if(
    is.character, as.factor
  ) %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::mutate(
    n_sources = n()
  ) %>%
  filter(
    n_sources > 1
  )

#  ---- Bedtime ----

# REF GROUP: DIARY
bedtimes_lm <- lm(mean_bedtime ~ relevel(source, ref = "diary"), data = mean_times_ears)
apa_bedtimes_lm <- apa_print(bedtimes_lm)
apa_table(
  apa_bedtimes_lm$table
  , landscape = FALSE
  , caption = "Comparing EARS to Diary Bedtimes"
)

# REF GROUP: ACTILIFE
bedtimes_lm_act <- lm(mean_bedtime ~ relevel(source, ref = "actilife"), data = mean_times_act)
apa_bedtimes_lm_act <- apa_print(bedtimes_lm_act)
apa_table(
  apa_bedtimes_lm_act$table
  , caption = "Comparing EARS and Diary Bedtimes to ActiGraph Bedtimes"
)

# REF GROUP: DIARY (COMPARING ACT TO DIARY)
bedtimes_lm_act_diary <- lm(mean_bedtime ~ relevel(source, ref = "diary"), data = mean_times_act)
apa_bedtimes_lm_act_diary <- apa_print(bedtimes_lm_act_diary)
apa_table(
  apa_bedtimes_lm_act_diary$table
  , caption = "Comparing EARS and ActiGraph Bedtimes to Diary Bedtimes"
)

#  ---- Rise Time ----

# REF GROUP: DIARY
risetimes_lm <- lm(mean_risetime ~ source, data = mean_times_ears)
apa_risetimes_lm <- apa_print(risetimes_lm)
apa_table(
  apa_risetimes_lm$table
  , caption = "Comparing EARS to Diary Rise Times"
)


# REF GROUP: ACTILIFE
risetimes_lm_act <- lm(mean_risetime ~ relevel(source, ref = "actilife"), data = mean_times_act)
apa_risetimes_lm_act <- apa_print(risetimes_lm_act)
apa_table(
  apa_risetimes_lm_act$table
  , caption = "Comparing EARS and Diary Rise Times to ActiGraph Rise Times"
)

# REF GROUP: DIARY (COMPARING ACT TO DIARY)
risetimes_lm_act_diary <- lm(mean_risetime ~ relevel(source, ref = "diary"), data = mean_times_act)
apa_risetimes_lm_act_diary <- apa_print(risetimes_lm_act_diary)
apa_table(
  apa_risetimes_lm_act_diary$table
  , caption = "Comparing EARS and ActiGraph Rise Times to Diary Rise Times"
)


#  ---- Time in Bed ----

# REF GROUP: DIARY
tib_lm <- lm(mean_tib ~ source, data = mean_times_ears)
apa_tib_lm <- apa_print(tib_lm)
apa_table(
  apa_tib_lm$table
  , landscape = FALSE
  , caption = "Comparing EARS Time in Bed to Diary Time in Bed"
)

# REF GROUP: ACTILIFE
tib_lm_act <- lm(mean_tib ~ relevel(source, ref = "actilife"), data = mean_times_act)
apa_tib_lm_act <- apa_print(tib_lm_act)
apa_table(
  apa_tib_lm_act$table
  , caption = "Comparing EARS and Diary Time in Bed to ActiGraph Time in Bed"
)

# REF GROUP: DIARY (COMPARING ACT TO DIARY)
tib_lm_act_diary <- lm(mean_tib ~ relevel(source, ref = "diary"), data = mean_times_act)
apa_tib_lm_act_diary <- apa_print(tib_lm_act_diary)
apa_table(
  apa_tib_lm_act_diary$table
  , caption = "Comparing EARS and ActiGraph Time in Bed to Diary Time in Bed"
)


#######################

### SUPPLEMENTARY DIARY (SLEEP) AND EARS (BED)

mean_times_ears.diary_supp <-
  df_analysis4_RemOut %>%
  filter(sample_1_flag == 1) %>%
  dplyr::mutate(
    bed.sleepon_min = 
      ifelse(
        source == "diary", sleep_period_start_onset_minutes, bedtime_start_onset_minutes
        ),
    rise.sleepoff_min = 
      ifelse(
        source == "diary", sleep_period_start_offset_minutes, risetime_start_offset_minutes
        ),
    tib.dur_min = 
      ifelse(
        source == "diary", sleep_duration_minutes, time_in_bed_minutes
        )
    ) %>%
  dplyr::group_by(actilife_id, source) %>%
  dplyr::summarise(
    mean_bed.sleep = mean(bed.sleepon_min, na.rm=TRUE),
    mean_rise.off = mean(rise.sleepoff_min, na.rm=TRUE),
    mean_tib.dur = mean(tib.dur_min, na.rm=TRUE)
  ) %>%
  dplyr::ungroup() %>%
  dplyr::mutate_if(
    is.character, as.factor
  ) %>%
  dplyr::group_by(actilife_id) %>%
  dplyr::mutate(
    n_sources = n()
  ) %>%
  filter(
    n_sources > 1,
    source !="actilife"
  ) 

# ears bedtime v diary sleep onset
bedtimes_lm_supp <- lm(mean_bed.sleep ~ relevel(source, ref = "diary"), data = mean_times_ears.diary_supp)
apa_bedtimes_lm_supp <- apa_print(bedtimes_lm_supp)
apa_table(
  apa_bedtimes_lm_supp$table
  , landscape = FALSE
  , caption = "Comparing EARS Bedtime to Diary Sleep Onset"
)

# ears risetime v diary sleep offset
risetimes_lm_supp <- lm(mean_rise.off ~ relevel(source, ref = "diary"), data = mean_times_ears.diary_supp)
apa_risetimes_lm_supp <- apa_print(risetimes_lm_supp)
apa_table(
  apa_risetimes_lm_supp$table
  , caption = "Comparing EARS Risetime to Diary Sleep Offset"
)

# ears tib v diary sleep duration
tib_lm_supp <- lm(mean_tib.dur ~ relevel(source, ref = "diary"), data = mean_times_ears.diary_supp)
apa_tib_lm_supp <- apa_print(tib_lm_supp)
apa_table(
  apa_tib_lm_supp$table
  , landscape = FALSE
  , caption = "Comparing EARS Time-in-Bed to Diary Sleep Duration"
)

```
There is no difference in bedtime `r apa_ontimes_lm$statistic$sourceears`, rise time `r apa_offtimes_lm$statistic$sourceears` , and time in bed `r apa_dur_lm$statistic$sourceears` times between EARS and Diary sources, and there was no difference in bedtime `r apa_ontimes_lm_act$statistic$relevelsource_ref____actilife_ears`, rise time `r apa_ontimes_lm_act$statistic$relevelsource_ref____actilife_ears`, and time in bed `r apa_dur_lm_act$statistic$relevelsource_ref____actilife_ears` between EARS and ActiGraph sources (see Figure below). 

```{r}
df_analysis4_RemOut %>%
  #filter(sample_1_flag == 1) %>%
  dplyr::mutate(
    bedtime_start_onset_hours = bedtime_start_onset_minutes/60,
    risetime_start_offset_hours = risetime_start_offset_minutes/60
  ) %>%
  ggplot() +
  geom_density(aes(bedtime_start_onset_hours, col = source), linewidth = 1, trim=TRUE) +
  geom_density(aes(risetime_start_offset_hours, col = source), linewidth = 1, linetype="dashed", trim=TRUE) +
  theme_classic() +
  scale_color_manual(values = cbPalette, labels = c("ActiGraph", "Diary", "EARS")) +
  labs(title = "The Distribution of Bedtimes and Rise Times",
       x = "Time of Day (Hours)",
       y = "Density",
       col = "") +
  scale_x_continuous(breaks = seq(-10,24, by = 2), labels = c("14", "16", "18", "20", "22", "0", "2", "4", "6", "8", "10", "12", "14", "16", "18", "20", "22", "24")) +
  theme(text = element_text(size = 12)) +
  theme(axis.text.x = element_text(size = 12))  +
  theme(axis.text.y = element_text(size = 12))  +
  geom_vline(aes(xintercept = 10.65028), colour = "#CC79A7", linetype = "solid", linewidth = .5) +
  theme(legend.direction = c("vertical"))
ggsave("Figure1.jpeg")


## Average timestamps

avg_timestamps <- 
  df_analysis4_RemOut %>%
  dplyr::group_by(source) %>%
  dplyr::summarise(
    mean_bed_minutes_from_midnight = mean(bedtime_start_onset_minutes, na.rm = TRUE), # avg minutes from midnight
    mean_bed_onset_H = mean_bed_minutes_from_midnight/60, # hours
    mean_bed_onset_M =  ((mean_bed_minutes_from_midnight/60) - trunc(mean_bed_minutes_from_midnight/60))*60, # minutes
    mean_bed_onset_S = (mean_bed_onset_M - trunc(mean_bed_onset_M))*60, # seconds
    mean_rise_minutes_from_midnight = mean(risetime_start_offset_minutes, na.rm = TRUE), # avg minutes from midnight
    mean_rise_onset_H = mean_rise_minutes_from_midnight/60, # hours
    mean_rise_onset_M =  ((mean_rise_minutes_from_midnight/60) - trunc(mean_rise_minutes_from_midnight/60))*60, # minutes
    mean_rise_onset_S = (mean_rise_onset_M - trunc(mean_rise_onset_M))*60 # seconds    
  ) %>%
  dplyr::mutate(
    mean_bed_timestamp_H = as.integer(mean_bed_onset_H),
    mean_bed_timestamp_M = trunc(mean_bed_onset_M),
    mean_bed_timestamp_S = as.integer(mean_bed_onset_S),
    bed_timestamp = paste0(mean_bed_timestamp_H, ":", mean_bed_timestamp_M, ":", mean_bed_timestamp_S),
    mean_rise_timestamp_H = as.integer(mean_rise_onset_H),
    mean_rise_timestamp_M = trunc(mean_rise_onset_M),
    mean_rise_timestamp_S = as.integer(mean_rise_onset_S),
    rise_timestamp = paste0(mean_rise_timestamp_H, ":", mean_rise_timestamp_M, ":", mean_rise_timestamp_S)
  )
```

# Correlation between sources

```{r}
#  ---- Bedtime ----

# DIARY AND EARS


rmcorr(participant = actilife_id, measure1 = bedtime_start_onset_minutes_ears, measure2 = bedtime_start_onset_minutes_diary, dataset = df_analysis_wide3_RemOut) # r=0.29, p=0.002

de_corr_onset <- 
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = bedtime_start_onset_minutes_diary, y = bedtime_start_onset_minutes_ears
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#56B4E9")  +
  labs(
    x = "Bedtime Minutes from Midnight (Diary)",
    y = "Bedtime \n Minutes from Midnight (EARS)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    )


# ACTILIFE and EARS

rmcorr(participant = actilife_id, measure1 = bedtime_start_onset_minutes_ears, measure2 = bedtime_start_onset_minutes_actilife, dataset = df_analysis_wide3_RemOut) # r=0.38, p=0.013

ae_corr_onset <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = bedtime_start_onset_minutes_actilife, y = bedtime_start_onset_minutes_ears
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#56B4E9")  +
  labs(
    x = "Bedtime Minutes from Midnight (ActiGraph)",
    y = "Bedtime \n Minutes from Midnight (EARS)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    )

# DIARY and ACTILIFE

rmcorr(participant = actilife_id, measure1 = bedtime_start_onset_minutes_actilife, measure2 = bedtime_start_onset_minutes_diary, dataset = df_analysis_wide3_RemOut)  # r=0.54, p<0.001

da_corr_onset <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = bedtime_start_onset_minutes_diary, y = bedtime_start_onset_minutes_actilife
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#999999")  +
  labs(
    x = "Bedtime Minutes from Midnight (Diary)",
    y = "Bedtime \n Minutes from Midnight (ActiGraph)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    )



#  ---- Rise Time ----

# DIARY and EARS

rmcorr(participant = actilife_id, measure1 = risetime_start_offset_minutes_ears, measure2 = risetime_start_offset_minutes_diary, dataset = df_analysis_wide3_RemOut) #r = 0.52, p<0.001

de_corr_offset <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = risetime_start_offset_minutes_diary, y = risetime_start_offset_minutes_ears
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#56B4E9")  +
  labs(
    x = "Rise Time Minutes from Midnight (Diary)",
    y = "Rise Time \n Minutes from Midnight (EARS)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    ) +
  geom_hline(aes(yintercept = 639), colour = "#CC79A7", linetype = "solid", linewidth = 1)


# ACTILIFE and EARS

rmcorr(participant = actilife_id, measure1 = risetime_start_offset_minutes_ears, measure2 = risetime_start_offset_minutes_actilife, dataset = df_analysis_wide3_RemOut) # r=0.29, p=0.067

ae_corr_offset <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = risetime_start_offset_minutes_actilife, y = risetime_start_offset_minutes_ears
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#56B4E9")  +
  labs(
    x = "Rise Time Minutes from Midnight (ActiGraph)",
    y = "Rise Time \n Minutes from Midnight (EARS)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    ) +
  geom_hline(aes(yintercept = 639), colour = "#CC79A7", linetype = "solid", linewidth = 1)


# DIARY and ACTILIFE

rmcorr(participant = actilife_id, measure1 = risetime_start_offset_minutes_actilife, measure2 = risetime_start_offset_minutes_diary, dataset = df_analysis_wide3_RemOut) # r=0.55, p<0.001

da_corr_offset <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = risetime_start_offset_minutes_diary, y = risetime_start_offset_minutes_actilife
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#999999")  +
  labs(
    x = "Rise Time Minutes from Midnight (Diary)",
    y = "Rise Time \n Minutes from Midnight (ActiGraph)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    )


#  ---- Time in Bed ----

# DIARY and EARS

rmcorr(participant = actilife_id, measure1 = time_in_bed_minutes_ears, measure2 = time_in_bed_minutes_diary, dataset = df_analysis_wide3_RemOut) # r=0.37, p<0.001

de_corr_dur <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = time_in_bed_minutes_diary, y = time_in_bed_minutes_ears
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#56B4E9")  +
  labs(
    x = "Time in Bed Minutes (Diary)",
    y = "Time in Bed \n Minutes (EARS)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    )

# ACTILIFE and EARS

rmcorr(participant = actilife_id, measure1 = time_in_bed_minutes_ears, measure2 = time_in_bed_minutes_actilife, dataset = df_analysis_wide3_RemOut) # r=0.55, p<0.001

ae_corr_dur <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = time_in_bed_minutes_actilife, y = time_in_bed_minutes_ears
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#56B4E9")  +
  labs(
    x = "Time in Bed Minutes (ActiGraph)",
    y = "Time in Bed \n Minutes (EARS)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    )

# DIARY and ACTILIFE

rmcorr(participant = actilife_id, measure1 = time_in_bed_minutes_actilife, measure2 = time_in_bed_minutes_diary, dataset = df_analysis_wide3_RemOut) # r=0.36, p=0.002

da_corr_dur <-
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = time_in_bed_minutes_diary, y = time_in_bed_minutes_actilife
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#999999")  +
  labs(
    x = "Time in Bed Minutes (Diary)",
    y = "Time in Bed \n Minutes (ActiGraph)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    )

(de_corr_onset + de_corr_offset + de_corr_dur) /
  (ae_corr_onset + ae_corr_offset + ae_corr_dur) +
  plot_annotation(title = 'Intersource Correlations', tag_levels = 'A')
ggsave("Figure2.jpeg", width = 14, height = 8)

#######################

### SUPPLEMENTARY DIARY (SLEEP) AND EARS (BED)

#  ---- ONSET ----

rmcorr(participant = actilife_id, measure1 = bedtime_start_onset_minutes_ears, measure2 = sleep_period_start_onset_minutes_diary, dataset = df_analysis_wide3_RemOut) # r=0.47, p<0.001


de_corr_onset_supp <- 
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = sleep_period_start_onset_minutes_diary, y = bedtime_start_onset_minutes_ears
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#56B4E9")  +
  labs(
    x = "Sleep Onset Minutes from Midnight (Diary)",
    y = "Bedtime \n Minutes from Midnight (EARS)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    )

#  ---- OFFSET ----

rmcorr(participant = actilife_id, measure1 = risetime_start_offset_minutes_ears, measure2 = sleep_period_start_offset_minutes_diary, dataset = df_analysis_wide3_RemOut) # r=0.48, p<0.001


de_corr_offset_supp <- 
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = sleep_period_start_offset_minutes_diary, y = risetime_start_offset_minutes_ears
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#56B4E9")  +
  labs(
    x = "Sleep Offset Minutes from Midnight (Diary)",
    y = "Risetime \n Minutes from Midnight (EARS)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    ) +
  geom_hline(aes(yintercept = 639), colour = "#CC79A7", linetype = "solid", linewidth = 1)

#  ---- DURATION ----

rmcorr(participant = actilife_id, measure1 = time_in_bed_minutes_ears, measure2 = sleep_duration_minutes_diary, dataset = df_analysis_wide3_RemOut) # r=0.44, p<0.001


de_corr_dur_supp <- 
  df_analysis_wide3_RemOut %>%
  ggplot(
    aes(
      x = sleep_duration_minutes_diary, y = time_in_bed_minutes_ears
    )
  ) +
  geom_point() +
  stat_smooth(method = "lm", color = "#56B4E9")  +
  labs(
    x = "Sleep Duration (Diary)",
    y = "Time-in-Bed (EARS)"
  ) +
  theme(
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9)
    )

(de_corr_onset_supp + de_corr_offset_supp + de_corr_dur_supp) +
  plot_annotation(title = 'Intersource Correlations', tag_levels = 'A')
ggsave("SupplementalFig6.jpeg", width = 14, height = 4)

```


```{r}
#######################

### EXPLORATORY EARS (Bedtime/Rise/TIB) AND PSQI (Bedtime/Rise/TIB)
#### 

psqi <-
  df_analysis_wide3_RemOut %>%
  filter(sample_1_flag == 1) %>%
  dplyr::group_by(actilife_id) %>%
  summarise(
    mean_bedtime = mean(bedtime_start_onset_minutes_ears),
    mean_risetime = mean(risetime_start_offset_minutes_ears),
    mean_tib = mean(time_in_bed_minutes_ears)
  )

psqi <-
  left_join(psqi, df_analysis_wide_demoxx, by = "actilife_id")

# converting psqi timestamps into minutes from midnight
psqi <-
  psqi %>%
  dplyr::mutate(
    psqi_1_gone_to_bed_timestamp_hms = as.character(psqi_1_gone_to_bed_timestamp_hms),
    psqi_3_wakeup_timestamp_hms = as.character(psqi_3_wakeup_timestamp_hms),
    wake_date = date(psqi_3_wakeup_timestamp_hms),
    psqi_onset_timestamp = lubridate::as_datetime(psqi_1_gone_to_bed_timestamp_hms),
    psqi_offset_timestamp = lubridate::as_datetime(psqi_3_wakeup_timestamp_hms),
    psqi_sleep_period_start_timestamp = lubridate::as_datetime(paste(wake_date, "00:00:00")),
    psqi_sleep_period_start_onset_minutes = as.numeric(difftime(psqi_onset_timestamp, psqi_sleep_period_start_timestamp, units = "mins")),
    psqi_sleep_period_start_offset_minutes = as.numeric(difftime(psqi_offset_timestamp, psqi_sleep_period_start_timestamp, units = "mins")),
    psqi_time_in_bed_minutes = as.numeric(difftime(psqi_offset_timestamp, psqi_onset_timestamp, units = "mins"))
  )

# bedtime
cor.test(psqi$mean_bedtime, psqi$psqi_sleep_period_start_onset_minutes) # r = 0.08116312, p = 0.6814
# risetime
cor.test(psqi$mean_risetime, psqi$psqi_sleep_period_start_offset_minutes) # r = 0.2007547, p = 0.3057
# time-in-bed
cor.test(psqi$mean_tib, psqi$psqi_time_in_bed_minutes) # r = -0.0008592537, p = 0.9965
```
No correlations between EARS and PSQI bedtime, ristime, and tib


# Spec/Sens/Acc

```{r}
# EARS sensitivity = true sleep epochs divided by the sum of true sleep and false sleep epochs.
# EARS specificity = true wake periods divided by the sum of false wake and true wake periods. 
# EARS accuracy = true sleep and true wake epochs divided by the sum of all true and false sleep and wake epochs

# _ Sample 1 EARS v DIARY HITS & FALSE ALARMS  ----

ears_spec_sens_1440min <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>%
  dplyr::select(actilife_id, risetime_date, day_num, sample_1_flag, true_bed_EARS_DIARY:p_cr_ears.diary.p)

# person estimates
ears_spec_sens_1440min.p <-
  ears_spec_sens_1440min %>%
  dplyr::select(actilife_id, ends_with("p")) %>%
  distinct()

ears_spec_sens_1440min.p_sum <- 
  ears_spec_sens_1440min.p %>%
  ungroup() %>%
  dplyr::summarise(
    p_hit = mean(p_hit_ears.diary.p), # tpr
    p_hit_min = min(p_hit_ears.diary.p),
    p_hit_max = max(p_hit_ears.diary.p),
    p_fa = mean(p_fa_ears.diary.p), # fpr
    p_fa_min = min(p_fa_ears.diary.p),
    p_fa_max = max(p_fa_ears.diary.p)
  ) 


################ SUPPLEMENTARY ################ 

# _ Sample 1 HITS & FALSE ALARMS: EARS BED v DIARY SLEEP (1440)----

ears_spec_sens_1440min_supp <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>%
  dplyr::select(actilife_id, risetime_date, day_num, sample_1_flag, true_sleep:p_cr_ears_diary_sleep.p)

# person estimates
ears_spec_sens_1440min.p_supp <-
  ears_spec_sens_1440min_supp %>%
  dplyr::select(actilife_id, ends_with(".p")) %>%
  distinct()

ears_spec_sens_1440min.p_supp_sum <- 
  ears_spec_sens_1440min.p_supp %>%
  ungroup() %>%
  dplyr::summarise(
    p_hit = mean(p_hit_ears_diary_sleep.p), # tpr
    p_hit_min = min(p_hit_ears_diary_sleep.p),
    p_hit_max = max(p_hit_ears_diary_sleep.p),
    p_fa = mean( p_fa_ears_diary_sleep.p), # fpr
    p_fa_min = min( p_fa_ears_diary_sleep.p),
    p_fa_max = max( p_fa_ears_diary_sleep.p)
  ) 

# _ Sample 1 EARS v DIARY HIT/FALSE TRUNCATED: EARS (8:30-10:39) v Diary ----

ears_spec_sens_1440min_trunc <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>%
  dplyr::select(actilife_id, risetime_date, day_num, sample_1_flag, true_bed_EARS_DIARY_t:p_cr_ears_diary_t.p)

# person estimates
ears_spec_sens_1440min.p_trunc <-
  ears_spec_sens_1440min_trunc %>%
  dplyr::select(actilife_id, ends_with(".p")) %>%
  distinct()

ears_spec_sens_1440min.p_trunc_sum <- 
  ears_spec_sens_1440min.p_trunc %>%
  ungroup() %>%
  dplyr::summarise(
    p_hit = mean(p_hit_ears_diary_t.p), # tpr
    p_hit_min = min(p_hit_ears_diary_t.p),
    p_hit_max = max(p_hit_ears_diary_t.p),
    p_fa = mean(p_fa_ears_diary_t.p), # fpr
    p_fa_min = min(p_fa_ears_diary_t.p),
    p_fa_max = max(p_fa_ears_diary_t.p)
  ) 

# _ Sample 2 EARS v ACTIGRAPH HIT/FALSE:  ----

# EARS v ActiGraph

ears_spec_sens_act <- 
  df_analysis_wide3_RemOut %>% 
  filter(sample_1_flag == 1) %>%
  dplyr::select(actilife_id, risetime_date, day_num, sample_1_flag, true_bed_EARS_ACT:p_cr_ears_actilife.p)

# person estimates
ears_spec_sens_act.p <-
  ears_spec_sens_act %>%
  dplyr::select(actilife_id, ends_with(".p")) %>%
  distinct()

ears_spec_sens_act.p_sum <- 
  ears_spec_sens_act.p %>%
  ungroup() %>%
  drop_na(true_bed_EARS_ACT.p) %>%
  dplyr::summarise(
    p_hit = mean(p_hit_ears_actilife.p), # tpr
    p_hit_min = min(p_hit_ears_actilife.p),
    p_hit_max = max(p_hit_ears_actilife.p),
    p_fa = mean(p_fa_ears_actilife.p), # fpr
    p_fa_min = min(p_fa_ears_actilife.p),
    p_fa_max = max(p_fa_ears_actilife.p)
  ) 


```

# Alignment across sources

```{r}
# replacing actilife id labels for visualization in publication
id_replace <- function(string) {
  abc <- c(LETTERS, "AA", "BB", "CC") # sequence letters of alphabet
  last_num <- gsub("^.*(\\d{1})$", "\\1", string) # grab last number
  out <- paste(abc, last_num, sep = "") # paste together
  out
}

# _ BED/Sleep segments ----
df_analysis4_RemOut %>%
  #filter(source_combination != "ears_actilife") %>%
  dplyr::mutate(
    y = day_num,
    adjust = ifelse(source == "diary", .2,
                    ifelse(source == "ears", 0, -.2)), # if diary, then .2, otherwise if ears then 0, otherwise, -0.2. therefore, diary = 0.2, ears = 0, actilife = -0.2
    ypos = y + adjust,
    source = fct_reorder(source, desc(adjust)),
    bedtime_onset_hours = bedtime_start_onset_minutes/60,
    risetime_offset_hours = risetime_start_offset_minutes/60,
    sleep_onset_hours = sleep_period_start_onset_minutes/60, # diary sleep onset
    sleep_offset_hours = sleep_period_start_offset_minutes/60 # diary sleep offset
  ) %>%
  ggplot(aes(color = source)) +  
  # ggplot(aes(color = source, shape = factor(day_num))) +
  # scale_shape_manual(values=c(0, 2, 3, 4, 6, 8, 18, 24, 25)) +
  geom_segment(aes(x = bedtime_onset_hours, xend = risetime_offset_hours, y = ypos, yend = ypos), alpha = .8) +
  geom_point(aes(x = bedtime_onset_hours, ypos), alpha = .8) +
  geom_point(aes(x = risetime_offset_hours, ypos), alpha = .8) +  
  geom_point(aes(x = sleep_onset_hours, ypos), alpha = .5, shape = "triangle", color = "purple") + # diary sleep onset
  geom_point(aes(x = sleep_offset_hours, ypos), alpha = .5, shape = "triangle", color = "purple") + # diary sleep offset    
  theme_minimal() +
  facet_wrap(actilife_id ~ ., labeller = labeller(actilife_id = id_replace)) +
  labs(title = "Supplemental Figure 4. Detected Bedtime/Sleep Onset to Risetime/Sleep Offset by Source",
       x = "Time of Day (hours)",
       y = "Day",
       col = "Source") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(face = "bold", size = 10),
        facet_wrap) +
  scale_color_manual(values = c("#E69F00", "#56B4E9", "#999999"), labels = c('Diary','EARS','ActiGraph')) +
  scale_x_continuous(breaks = seq(-10,24, by = 6), labels = c("14", "20", "2", "8", "14", "20"))
ggsave("SupplementalFig5.jpeg", width = 7, height = 9)


```

# Bland-Altman Plots
```{r}
fig_ears <- 
  df_analysis_wide3_RemOut %>%  
  filter(sample_1_flag == 1) %>% 
  ggplot(aes(x = bedtime_start_onset_avg_diary_ears, y = bedtime_diff_min_diary_ears)) +
  geom_point(alpha = 0.6, size = 2, aes(col = actilife_id)) +
  geom_hline(yintercept = mean(df_analysis_wide3_RemOut$bedtime_diff_min_diary_ears, na.rm = TRUE), colour = "black", linewidth = 0.5) +
  geom_hline(yintercept = mean(df_analysis_wide3_RemOut$bedtime_diff_min_diary_ears, na.rm = TRUE) - (1.96 * sd(df_analysis_wide3_RemOut$bedtime_diff_min_diary_ears, na.rm = TRUE)), colour = "black", linewidth = 0.5, linetype = "dashed") +
  geom_hline(yintercept = mean(df_analysis_wide3_RemOut$bedtime_diff_min_diary_ears, na.rm = TRUE) + (1.96 * sd(df_analysis_wide3_RemOut$bedtime_diff_min_diary_ears, na.rm = TRUE)), colour = "black", linewidth = 0.5, linetype = "dashed") +
  labs(title = "EARS", y = "Difference between Diary and EARS Bedtime", x = "Average of Diary and EARS Bedtime") +
  expand_limits(x = c(-100, 200), y = c(-250, 250)) + 
  scale_x_continuous(breaks = seq(-100, 200, by = 100)) +
  scale_y_continuous(breaks = seq(-250, 250, by = 100)) +
  theme(legend.position = "none") +
  NULL

samp1 <- 
  df_analysis_wide3_RemOut %>%
  filter(sample_1_flag == 1)
samp2 <- 
  df_analysis_wide3_RemOut %>%
  filter(sample_2_flag == 1)

# Diary and EARS: Bedtime

ba_diaryears_onset <- 
  bland.altman.plot(samp1$bedtime_start_onset_minutes_diary, samp1$bedtime_start_onset_minutes_ears, graph.sys = "ggplot2", conf.int = .95)
ba_diaryears_onset$layers[[2]]$aes_params$colour <- c('#CC79A7', 'gray', '#CC79A7')
ba_diaryears_onset$layers[[2]]$aes_params$linetype <- c('solid', 'solid', 'solid')
ba_diaryears_onset + ggtitle("EARS compared to Diary Bedtime")
bland.altman.stats(samp1$bedtime_start_onset_minutes_diary, samp1$bedtime_start_onset_minutes_ears, two = 1.96, mode = 1, conf.int = 0.95)
#### association between mean and difference
summary(lmer(bedtime_diff_min_diary_ears ~ bedtime_start_onset_avg_diary_ears + (1|actilife_id), data = samp1))


# Diary and EARS: Rise Time
ba_diaryears_offset <- 
  bland.altman.plot(samp1$risetime_start_offset_minutes_diary, samp1$risetime_start_offset_minutes_ears, graph.sys = "ggplot2", conf.int = .95)
ba_diaryears_offset$layers[[2]]$aes_params$colour <- c('#CC79A7', 'gray', '#CC79A7')
ba_diaryears_offset$layers[[2]]$aes_params$linetype <- c('solid', 'solid', 'solid')
ba_diaryears_offset + ggtitle("EARS compared to Diary Rise Time")
bland.altman.stats(samp1$risetime_start_offset_minutes_diary, samp1$risetime_start_offset_minutes_ears, two = 1.96, mode = 1, conf.int = 0.95)
#### association between mean and difference
summary(lmer(risetime_diff_min_diary_ears ~ risetime_start_offset_avg_diary_ears + (1|actilife_id), data = samp1))


# Diary and EARS: TIme in Bed
ba_diaryears_dur <- 
  bland.altman.plot(samp1$time_in_bed_minutes_diary, samp1$time_in_bed_minutes_ears, graph.sys = "ggplot2", conf.int = .95)
ba_diaryears_dur$layers[[2]]$aes_params$colour <- c('#CC79A7', 'gray', '#CC79A7')
ba_diaryears_dur$layers[[2]]$aes_params$linetype <- c('solid', 'solid', 'solid')
ba_diaryears_dur + ggtitle("EARS compared to Diary Time in Bed")
bland.altman.stats(samp1$time_in_bed_minutes_diary, samp1$time_in_bed_minutes_ears, two = 1.96, mode = 1, conf.int = 0.95)
#### association between mean and difference
summary(lmer(time_in_bed_minutes_diff_min_diary_ears ~ time_in_bed_minutes_avg_diary_ears + (1|actilife_id), data = samp1))

# Act and EARS: Bedtime

ba_actears_onset <- 
  bland.altman.plot(samp2$bedtime_start_onset_minutes_actilife, samp2$bedtime_start_onset_minutes_ears, graph.sys = "ggplot2", conf.int = .95)
ba_actears_onset$layers[[2]]$aes_params$colour <- c('#CC79A7', 'gray', '#CC79A7')
ba_actears_onset$layers[[2]]$aes_params$linetype <- c('solid', 'solid', 'solid')
ba_actears_onset + ggtitle("EARS compared to ActiGraph Bedtime")
bland.altman.stats(samp2$bedtime_start_onset_minutes_actilife, samp2$bedtime_start_onset_minutes_ears, two = 1.96, mode = 1, conf.int = 0.95)
#### association between mean and difference
summary(lmer(bedtime_diff_min_actilife_ears ~ bedtime_start_onset_avg_actilife_ears + (1|actilife_id), data = samp2))

# Act and EARS: Rise Time
ba_actears_offset <- 
  bland.altman.plot(samp2$risetime_start_offset_minutes_actilife, samp2$risetime_start_offset_minutes_ears, graph.sys = "ggplot2", conf.int = .95)
ba_actears_offset$layers[[2]]$aes_params$colour <- c('#CC79A7', 'gray', '#CC79A7')
ba_actears_offset$layers[[2]]$aes_params$linetype <- c('solid', 'solid', 'solid')
ba_actears_offset + ggtitle("EARS compared to ActiGraph Rise Time")
bland.altman.stats(samp2$risetime_start_offset_minutes_actilife, samp2$risetime_start_offset_minutes_ears, two = 1.96, mode = 1, conf.int = 0.95)
#### association between mean and difference
summary(lmer(risetime_diff_min_actilife_ears ~ risetime_start_offset_avg_actilife_ears + (1|actilife_id), data = samp2))


# Act and EARS: Time in Bed
ba_actears_dur <- 
  bland.altman.plot(samp2$time_in_bed_minutes_actilife, samp2$time_in_bed_minutes_ears, graph.sys = "ggplot2", conf.int = .95)
ba_actears_dur$layers[[2]]$aes_params$colour <- c('#CC79A7', 'gray', '#CC79A7')
ba_actears_dur$layers[[2]]$aes_params$linetype <- c('solid', 'solid', 'solid')
ba_actears_dur + ggtitle("EARS compared to ActiGraph Time in Bed")
bland.altman.stats(samp2$time_in_bed_minutes_actilife, samp2$time_in_bed_minutes_ears, two = 1.96, mode = 1, conf.int = 0.95)
#### association between mean and difference
summary(lmer(time_in_bed_minutes_diff_min_actilife_ears ~ time_in_bed_minutes_avg_actilife_ears + (1|actilife_id), data = samp2))


(ba_diaryears_onset + ba_diaryears_offset + ba_diaryears_dur ) /
  (ba_actears_onset + ba_actears_offset + ba_actears_dur ) +
  plot_annotation(title = "",
                  caption = "", tag_levels = 'A')

### looking at correlation between actilife and diary bedtime and tib avg-diff to see if the association between ears and diary bedtime and tib avg-diff could be due to diary misalignment
summary(lmer(bedtime_diff_min_diary_actilife ~ bedtime_start_onset_avg_diary_actilife + (1|actilife_id), data = samp2))
summary(lmer(time_in_bed_minutes_diff_min_diary_actilife ~ time_in_bed_minutes_avg_diary_actilife + (1|actilife_id), data = samp2))
```

\newpage

# References

::: {#refs custom-style="Bibliography"}
:::